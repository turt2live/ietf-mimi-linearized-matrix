<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>Linearized Matrix</title>
<meta content="Travis Ralston" name="author">
<meta content="Matthew Hodgson" name="author">
<meta content="
       This document specifies Linearized Matrix (LM). LM is an extensible protocol for interoperability
between messaging providers, using Matrix's ( matrix.org ) decentralized room
model. LM simplifies the Directed Acyclic Graph (DAG) persistence of Matrix while maintaining
compatibility with non-linearized servers within a room. It does this by using a doubly-linked list
of events/messages per room with hub and spoke fanout. 
       LM's extensibility enables a wide range of transport protocol and end-to-end encryption possibilities.
This document uses Matrix's room access control semantics supported by Messaging Layer Security (MLS),
transported via HTTPS and JSON. The details of which server-to-server transport to use and what is
put over MLS are replaceable. 
       The threat model of LM does not place trust in a central owning server for each conversation. Instead,
it defines a hub server which handles maintaining linearized room history for other servers in the
room. This model permits transparent interconnection between LM servers and Matrix servers, in the
same room. 
    " name="description">
<meta content="xml2rfc 3.19.0" name="generator">
<meta content="matrix" name="keyword">
<meta content="linearized" name="keyword">
<meta content="interoperability" name="keyword">
<meta content="messaging" name="keyword">
<meta content="mimi" name="keyword">
<meta content="decentralized" name="keyword">
<meta content="draft-ralston-mimi-linearized-matrix-latest" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.19.0
    Python 3.11.6
    ConfigArgParse 1.7
    google-i18n-address 3.1.0
    intervaltree 3.1.0
    Jinja2 3.1.2
    lxml 4.9.3
    platformdirs 4.1.0
    pycountry 22.3.5
    PyYAML 6.0.1
    requests 2.31.0
    setuptools 68.2.2
    six 1.16.0
    wcwidth 0.2.12
-->
<link href="draft-ralston-mimi-linearized-matrix.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}

@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Lora SemiBold'), local('Lora-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

:root {
  color-scheme: light dark;
  --background-color: #fff;
  --text-color: #222;
  --title-color: #191919;
  --link-color: #2a6496;
  --highlight-color: #f9f9f9;
  --line-color: #eee;
  --pilcrow-weak: #ddd;
  --pilcrow-strong: #bbb;
  --small-font-size: 14.5px;
  --font-mono: 'Oxygen Mono', monospace;
  scrollbar-color: #bbb #eee;
}
body {
  max-width: 600px;
  margin: 75px auto;
  padding: 0 5px;
  color: var(--text-color);
  background-color: var(--background-color);
  font: 16px/22px "Lora", serif;
  scroll-behavior: smooth;
}

.ears {
  display: none;
}

/* headings */
h1, h2, h3, h4, h5, h6 {
  font-family: "Cabin Condensed", sans-serif;
  font-weight: 600;
  margin: 0.8em 0 0.3em;
  font-size-adjust: 0.5;
  color: var(--title-color);
}
h1#title {
  font-size: 32px;
  line-height: 40px;
  clear: both;
}
h1#title, h1#rfcnum {
  margin: 1.5em 0 0.2em;
}
h1#rfcnum + h1#title {
  margin: 0.2em 0;
}

h1, h2, h3 {
  font-size: 22px;
  line-height: 27px;
}
h4, h5, h6 {
  font-size: 20px;
  line-height: 24px;
}

/* general structure */
.author {
  padding-bottom: 0.3em;
}
#abstract+p {
  font-size: 18px;
  line-height: 24px;
}
#abstract+p code, #abstract+p samp, #abstract+p tt {
  font-size: 16px;
  line-height: 0;
}

p {
  padding: 0;
  margin: 0.5em 0;
  text-align: left;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignRight.art-text pre {
  padding: 0;
  width: auto;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
/* font-family isn't space-separated, but =~ will have to do */
svg[font-family~="monospace" i], svg [font-family~="monospace" i] {
  font-family: var(--font-mono);
}
.alignCenter.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignCenter.art-text pre {
  padding: 0;
  width: auto;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 0.5em 2em;
}
:is(ol, ul) :is(ol, ul) {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
:is(ul, ol).compact, .ulCompact, .olCompact {
  line-height: 1;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
  clear: left;
  --indent: 3ch;
  /* --indent: attr(indent ch); not supported in any browser, but we can dream */
}
dl.olPercent {
  --indent: 5ch;
}
dl > dt {
  float: left;
  margin-right: 2ch;
  min-width: 8ch;
}
dl.dlNewline > dt {
  float: none;
}
dl > dd {
  margin-bottom: .8em;
  margin-left: var(--indent) !important; /* stupid element overrides */
  min-height: 2ex;
}
dl.olPercent > dt {
  min-width: calc(var(--indent) - 2ch);
}
:is(dl.compact, .dlCompact) > dd {
  margin-bottom: 0;
}
:is(dl.compact, .dlCompact) > dd > :is(:first-child, .break:first-child + *) {
  margin-top: 0;
}
:is(dl.compact, .dlCompact) > dd > :is(:last-child) {
  margin-bottom: 0;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0;
}
:is(dd, span).break {
  display: none;
}

/* links */
a, a[href].selfRef:hover {
  text-decoration: none;
}
a[href] {
  color: var(--link-color);
}
a[href].selfRef, .iref + a[href].internal {
  color: var(--text-color);
}
a[href]:hover {
  text-decoration: underline;
}
a[href].selfRef:hover {
  background-color: var(--highlight-color);
}
a.xref:is(.cite, .auto), :is(#status-of-memo, #copyright) a {
  white-space: nowrap;
}

/* Figures */
tt, code, pre {
  background-color: var(--highlight-color);
  font: 14px/22px var(--font-mono);
}
tt, code {
  /* changing the font for inline elements leads to different ascender
     and descender heights; as we want to retain baseline alignment,
     remove leading to avoid altering the final height of lines
     note: this fails if these blocks take an entire line,
     a different solution would be great */
  line-height: 0;
}
:is(h1, h2, h3, h4, h5, h6) :is(tt, code) {
  font-size: 84%;
}
pre {
  border: 1px solid var(--line-color);
  font-size: 13.5px;
  line-height: 16px;
  letter-spacing: -0.2px;
  margin: 5px;
  padding: 5px;
}
img {
  max-width: 100%;
}
figure {
  margin: 0.5em 0;
  padding: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption, caption {
  font-style: italic;
  margin: 0.5em 1.5em;
  text-align: left;
}
@media screen {
  /* Auto-collapse boilerplate. */
  :is(#status-of-memo, #copyright) p {
    margin: -2px 0;
    max-height: 0;
    transition: max-height 2s ease, margin 0.5s ease 0.5s;
    overflow: hidden;
  }
  :is(#status-of-memo, #copyright):hover p,
  :is(#status-of-memo, #copyright) h2:target ~ p {
    margin: 0.5em 0;
    max-height: 500px;
    overflow: auto;
  }
  pre, svg {
    display: inline-block;
    overflow-x: auto;
  }
  pre {
    max-width: 100%;
    width: calc(100% - 22px - 1em);
  }
  svg {
    max-width: calc(100% - 22px - 1em);
  }
  figure pre {
    display: block;
    width: calc(100% - 25px);
  }
  :is(pre, svg) + .pilcrow {
    display: inline-block;
    vertical-align: text-bottom;
    padding-bottom: 8px;
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 0 2em;
  font-style: italic;
}
blockquote {
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  max-width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
}
table.right {
  margin-left: auto;
}
table.center {
  margin-left: auto;
  margin-right: auto;
}
table.left {
  margin-right: auto;
}
thead, tbody {
  border: 1px solid var(--line-color);
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 5px 10px;
}
th {
  background-color: var(--line-color);
}
:is(tr:nth-child(2n), thead+tbody > tr:nth-child(2n+1)) > td {
  background-color: var(--background-color);
}
:is(tr:nth-child(2n+1), thead+tbody > tr:nth-child(2n)) > td {
  background-color: var(--highlight-color);
}
table caption {
  margin: 0;
  padding: 3px 0 3px 1em;
}
table p {
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  margin-left: 3px;
  opacity: 0.2;
  user-select: none;
}
a.pilcrow[href] { color: var(--pilcrow-weak); }
a.pilcrow[href]:hover { text-decoration: none; }
@media not print {
  :hover > a.pilcrow {
    opacity: 1;
  }
  a.pilcrow[href]:hover {
    color: var(--pilcrow-strong);
    background-color: transparent;
  }
}
@media print {
  a.pilcrow {
    display: none;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid var(--line-color);
}
.bcp14 {
  font-variant: small-caps;
  font-weight: 600;
  font-size: var(--small-font-size);
}
.role {
  font-variant: all-small-caps;
}
sub, sup {
  line-height: 1;
  font-size: 80%;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: var(--small-font-size);
  line-height: 18px;
  --identifier-width: 15ch;
}
#identifiers dt {
  width: var(--identifier-width);
  min-width: var(--identifier-width);
  clear: left;
  float: left;
  text-align: right;
  margin-right: 1ch;
}
#identifiers dd {
  margin: 0;
  margin-left: calc(1em + var(--identifier-width)) !important;
  min-width: 5em;
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #999;
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
#toc nav ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
#toc nav li {
  line-height: 1.3em;
  margin: 2px 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
#toc a.xref {
  white-space: normal;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 10ch;
  margin-right: 1.5ch;
}
.references dt:target::before {
  content: "⇒";
  width: 15px;
  margin: 0 10px 0 -25px;
}
.references dd {
  margin-left: 12ch !important;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
#rfc\.index\.index + ul {
  margin-left: 0;
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}
address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}
@media (min-width: 500px) {
  #authors-addresses > section {
    column-count: 2;
    column-gap: 20px;
  }
  #authors-addresses > section > h2 {
    column-span: all;
  }
  /* hack for break-inside: avoid-column */
  #authors-addresses address {
    display: inline-block;
    break-inside: avoid-column;
  }
}

.rfcEditorRemove p:first-of-type {
  font-style: italic;
}
.cref {
  background-color: rgba(249, 232, 105, 0.3);
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 929px) {
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 1px 0 0 0;
    margin: 0;
    border-bottom: 1px solid #ccc;
    opacity: 0.6;
  }
  #toc.active {
      opacity: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 2px 0 2px 6px;
    padding-right: 1em;
    font-size: 18px;
    line-height: 24px;
    min-width: 190px;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 8px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    background-color: var(--background-color);
    padding: 0.5em 1em 1em;
    overflow: auto;
    overscroll-behavior: contain;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
  #toc.active nav {
    display: block;
  }
  /* Make the collapsed ToC header render white on gray also when it's a link */
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
  #toc a.toplink {
    margin-top: 2px;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 930px) {
  body {
    padding-right: 360px;
    padding-right: calc(min(180px + 20%, 500px));
  }
  #toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 480px);
    width: 312px;
    margin: 0;
    padding: 0;
    z-index: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 2em;
    overflow: auto;
    overscroll-behavior: contain;
    scrollbar-width: thin;
  }
  #toc nav > ul  {
    margin-bottom: 2em;
  }
  #toc ul {
    margin: 0 0 0 4px;
    font-size: var(--small-font-size);
  }
  #toc ul :is(p, li) {
    margin: 2px 0;
    line-height: 22px;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre, .vcard {
    page-break-inside: avoid;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  :is(h2, h3, h4, h5, h6)+*, dd {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
  .toplink {
    display: none;
  }
}

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
}

/* Changes introduced to fix issues found during implementation */

/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}

/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin: 8px 0.5em 0;
}

/* Provide styling for table cell text alignment */
table .text-left {
  text-align: left;
}
table .text-center {
  text-align: center;
}
table .text-right {
  text-align: right;
}

/* Make the alternative author contact information look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 20em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Dark mode. */
@media (prefers-color-scheme: dark) {
:root {
  --background-color: #121212;
  --text-color: #f0f0f0;
  --title-color: #fff;
  --link-color: #4da4f0;
  --highlight-color: #282828;
  --line-color: #444;
  --pilcrow-weak: #444;
  --pilcrow-strong: #666;
  scrollbar-color: #777 #333;
}
}

/* SVG Trick: a prefix match works because only black and white are allowed */
svg :is([stroke="black"], [stroke^="#000"]) {
  stroke: var(--text-color);
}
svg :is([stroke="white"], [stroke^="#fff"]) {
  stroke: var(--background-color);
}
svg :is([fill="black"], [fill^="#000"], :not([fill])) {
  fill: var(--text-color);
}
svg :is([fill="white"], [fill^="#fff"]) {
  fill: var(--background-color);
}
</style>

</head>
<body class="xml2rfc">
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">Linearized Matrix</td>
<td class="right">January 2024</td>
</tr></thead>
<tfoot><tr>
<td class="left">Ralston &amp; Hodgson</td>
<td class="center">Expires 14 July 2024</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">More Instant Messaging Interoperability</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-ralston-mimi-linearized-matrix-latest</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2024-01-11" class="published">11 January 2024</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Standards Track</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2024-07-14">14 July 2024</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">T. Ralston</div>
<div class="org">The Matrix.org Foundation C.I.C.</div>
</div>
<div class="author">
      <div class="author-name">M. Hodgson</div>
<div class="org">The Matrix.org Foundation C.I.C.</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">Linearized Matrix</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">This document specifies Linearized Matrix (LM). LM is an extensible protocol for interoperability
between messaging providers, using Matrix's (<a href="https://matrix.org">matrix.org</a>) decentralized room
model. LM simplifies the Directed Acyclic Graph (DAG) persistence of Matrix while maintaining
compatibility with non-linearized servers within a room. It does this by using a doubly-linked list
of events/messages per room with hub and spoke fanout.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
<p id="section-abstract-2">LM's extensibility enables a wide range of transport protocol and end-to-end encryption possibilities.
This document uses Matrix's room access control semantics supported by Messaging Layer Security (MLS),
transported via HTTPS and JSON. The details of which server-to-server transport to use and what is
put over MLS are replaceable.<a href="#section-abstract-2" class="pilcrow">¶</a></p>
<p id="section-abstract-3">The threat model of LM does not place trust in a central owning server for each conversation. Instead,
it defines a hub server which handles maintaining linearized room history for other servers in the
room. This model permits transparent interconnection between LM servers and Matrix servers, in the
same room.<a href="#section-abstract-3" class="pilcrow">¶</a></p>
</section>
<section class="note rfcEditorRemove" id="section-note.1">
      <h2 id="name-about-this-document">
<a href="#name-about-this-document" class="section-name selfRef">About This Document</a>
      </h2>
<p id="section-note.1-1">This note is to be removed before publishing as an RFC.<a href="#section-note.1-1" class="pilcrow">¶</a></p>
<p id="section-note.1-2">
        The latest revision of this draft can be found at <span><a href="https://turt2live.github.io/ietf-mimi-linearized-matrix/draft-ralston-mimi-linearized-matrix.html">https://turt2live.github.io/ietf-mimi-linearized-matrix/draft-ralston-mimi-linearized-matrix.html</a></span>.
        Status information for this document may be found at <span><a href="https://datatracker.ietf.org/doc/draft-ralston-mimi-linearized-matrix/">https://datatracker.ietf.org/doc/draft-ralston-mimi-linearized-matrix/</a></span>.<a href="#section-note.1-2" class="pilcrow">¶</a></p>
<p id="section-note.1-3">
        Discussion of this document takes place on the
        More Instant Messaging Interoperability Working Group mailing list (<span><a href="mailto:mimi@ietf.org">mailto:mimi@ietf.org</a></span>),
        which is archived at <span><a href="https://mailarchive.ietf.org/arch/browse/mimi/">https://mailarchive.ietf.org/arch/browse/mimi/</a></span>.
        Subscribe at <span><a href="https://www.ietf.org/mailman/listinfo/mimi/">https://www.ietf.org/mailman/listinfo/mimi/</a></span>.<a href="#section-note.1-3" class="pilcrow">¶</a></p>
<p id="section-note.1-4">Source for this draft and an issue tracker can be found at
        <span><a href="https://github.com/turt2live/ietf-mimi-linearized-matrix">https://github.com/turt2live/ietf-mimi-linearized-matrix</a></span>.<a href="#section-note.1-4" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 14 July 2024.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2024 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="auto internal xref">1</a>.  <a href="#name-introduction" class="internal xref">Introduction</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1" class="keepWithNext"><a href="#section-2" class="auto internal xref">2</a>.  <a href="#name-conventions-and-definitions" class="internal xref">Conventions and Definitions</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="auto internal xref">3</a>.  <a href="#name-architecture" class="internal xref">Architecture</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1" class="keepWithNext"><a href="#section-3.1" class="auto internal xref">3.1</a>.  <a href="#name-server-names" class="internal xref">Server Names</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="auto internal xref">3.2</a>.  <a href="#name-rooms" class="internal xref">Rooms</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2.2.1">
                    <p id="section-toc.1-1.3.2.2.2.1.1"><a href="#section-3.2.1" class="auto internal xref">3.2.1</a>.  <a href="#name-room-versions" class="internal xref">Room Versions</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.3">
                <p id="section-toc.1-1.3.2.3.1"><a href="#section-3.3" class="auto internal xref">3.3</a>.  <a href="#name-users" class="internal xref">Users</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.4">
                <p id="section-toc.1-1.3.2.4.1"><a href="#section-3.4" class="auto internal xref">3.4</a>.  <a href="#name-devices" class="internal xref">Devices</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.5">
                <p id="section-toc.1-1.3.2.5.1"><a href="#section-3.5" class="auto internal xref">3.5</a>.  <a href="#name-events" class="internal xref">Events</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.5.2.1">
                    <p id="section-toc.1-1.3.2.5.2.1.1"><a href="#section-3.5.1" class="auto internal xref">3.5.1</a>.  <a href="#name-linearized-pdu" class="internal xref">Linearized PDU</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.5.2.2">
                    <p id="section-toc.1-1.3.2.5.2.2.1"><a href="#section-3.5.2" class="auto internal xref">3.5.2</a>.  <a href="#name-state-events" class="internal xref">State Events</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.5.2.3">
                    <p id="section-toc.1-1.3.2.5.2.3.1"><a href="#section-3.5.3" class="auto internal xref">3.5.3</a>.  <a href="#name-event-types" class="internal xref">Event Types</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="auto internal xref">4</a>.  <a href="#name-mls-considerations" class="internal xref">MLS Considerations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a href="#section-4.1" class="auto internal xref">4.1</a>.  <a href="#name-device-credentials" class="internal xref">Device Credentials</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2">
                <p id="section-toc.1-1.4.2.2.1"><a href="#section-4.2" class="auto internal xref">4.2</a>.  <a href="#name-group-creation" class="internal xref">Group Creation</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.3">
                <p id="section-toc.1-1.4.2.3.1"><a href="#section-4.3" class="auto internal xref">4.3</a>.  <a href="#name-updating-group-state" class="internal xref">Updating Group State</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.4">
                <p id="section-toc.1-1.4.2.4.1"><a href="#section-4.4" class="auto internal xref">4.4</a>.  <a href="#name-key-packages" class="internal xref">Key Packages</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.5">
                <p id="section-toc.1-1.4.2.5.1"><a href="#section-4.5" class="auto internal xref">4.5</a>.  <a href="#name-room-event-types" class="internal xref">Room Event Types</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.5.2.1">
                    <p id="section-toc.1-1.4.2.5.2.1.1"><a href="#section-4.5.1" class="auto internal xref">4.5.1</a>.  <a href="#name-mmlscommit" class="internal xref"><code>m.mls.commit</code></a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.5.2.2">
                    <p id="section-toc.1-1.4.2.5.2.2.1"><a href="#section-4.5.2" class="auto internal xref">4.5.2</a>.  <a href="#name-mroomencrypted" class="internal xref"><code>m.room.encrypted</code></a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="auto internal xref">5</a>.  <a href="#name-processing-events" class="internal xref">Processing Events</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a href="#section-5.1" class="auto internal xref">5.1</a>.  <a href="#name-receiving-events-pdus" class="internal xref">Receiving Events/PDUs</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2">
                <p id="section-toc.1-1.5.2.2.1"><a href="#section-5.2" class="auto internal xref">5.2</a>.  <a href="#name-authorization-rules" class="internal xref">Authorization Rules</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2.2.1">
                    <p id="section-toc.1-1.5.2.2.2.1.1"><a href="#section-5.2.1" class="auto internal xref">5.2.1</a>.  <a href="#name-auth-events-selection" class="internal xref">Auth Events Selection</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2.2.2">
                    <p id="section-toc.1-1.5.2.2.2.2.1"><a href="#section-5.2.2" class="auto internal xref">5.2.2</a>.  <a href="#name-calculating-power-levels" class="internal xref">Calculating Power Levels</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2.2.3">
                    <p id="section-toc.1-1.5.2.2.2.3.1"><a href="#section-5.2.3" class="auto internal xref">5.2.3</a>.  <a href="#name-auth-rules-algorithm" class="internal xref">Auth Rules Algorithm</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="auto internal xref">6</a>.  <a href="#name-signing" class="internal xref">Signing</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1">
                <p id="section-toc.1-1.6.2.1.1"><a href="#section-6.1" class="auto internal xref">6.1</a>.  <a href="#name-signing-events" class="internal xref">Signing Events</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.2">
                <p id="section-toc.1-1.6.2.2.1"><a href="#section-6.2" class="auto internal xref">6.2</a>.  <a href="#name-signing-arbitrary-objects" class="internal xref">Signing Arbitrary Objects</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.3">
                <p id="section-toc.1-1.6.2.3.1"><a href="#section-6.3" class="auto internal xref">6.3</a>.  <a href="#name-checking-signatures" class="internal xref">Checking Signatures</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="auto internal xref">7</a>.  <a href="#name-canonical-json" class="internal xref">Canonical JSON</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="auto internal xref">8</a>.  <a href="#name-event-redactions" class="internal xref">Event Redactions</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9" class="auto internal xref">9</a>.  <a href="#name-hashes" class="internal xref">Hashes</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.1">
                <p id="section-toc.1-1.9.2.1.1"><a href="#section-9.1" class="auto internal xref">9.1</a>.  <a href="#name-content-hash-calculation" class="internal xref">Content Hash Calculation</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.2">
                <p id="section-toc.1-1.9.2.2.1"><a href="#section-9.2" class="auto internal xref">9.2</a>.  <a href="#name-reference-hash-calculation" class="internal xref">Reference Hash Calculation</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#section-10" class="auto internal xref">10</a>. <a href="#name-unpadded-base64" class="internal xref">Unpadded Base64</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#section-11" class="auto internal xref">11</a>. <a href="#name-hub-selection" class="internal xref">Hub Selection</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.1">
                <p id="section-toc.1-1.11.2.1.1"><a href="#section-11.1" class="auto internal xref">11.1</a>.  <a href="#name-hub-transfers" class="internal xref">Hub Transfers</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12">
            <p id="section-toc.1-1.12.1"><a href="#section-12" class="auto internal xref">12</a>. <a href="#name-transport" class="internal xref">Transport</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.1">
                <p id="section-toc.1-1.12.2.1.1"><a href="#section-12.1" class="auto internal xref">12.1</a>.  <a href="#name-tls-certificates" class="internal xref">TLS Certificates</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.2">
                <p id="section-toc.1-1.12.2.2.1"><a href="#section-12.2" class="auto internal xref">12.2</a>.  <a href="#name-api-standards" class="internal xref">API Standards</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.2.2.1">
                    <p id="section-toc.1-1.12.2.2.2.1.1"><a href="#section-12.2.1" class="auto internal xref">12.2.1</a>.  <a href="#name-requests-and-responses" class="internal xref">Requests and Responses</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.2.2.2">
                    <p id="section-toc.1-1.12.2.2.2.2.1"><a href="#section-12.2.2" class="auto internal xref">12.2.2</a>.  <a href="#name-errors" class="internal xref">Errors</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.2.2.3">
                    <p id="section-toc.1-1.12.2.2.2.3.1"><a href="#section-12.2.3" class="auto internal xref">12.2.3</a>.  <a href="#name-unsupported-endpoints" class="internal xref">Unsupported Endpoints</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.2.2.4">
                    <p id="section-toc.1-1.12.2.2.2.4.1"><a href="#section-12.2.4" class="auto internal xref">12.2.4</a>.  <a href="#name-malformed-requests" class="internal xref">Malformed Requests</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.2.2.5">
                    <p id="section-toc.1-1.12.2.2.2.5.1"><a href="#section-12.2.5" class="auto internal xref">12.2.5</a>.  <a href="#name-transaction-identifiers" class="internal xref">Transaction Identifiers</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.2.2.6">
                    <p id="section-toc.1-1.12.2.2.2.6.1"><a href="#section-12.2.6" class="auto internal xref">12.2.6</a>.  <a href="#name-rate-limiting" class="internal xref">Rate Limiting</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.3">
                <p id="section-toc.1-1.12.2.3.1"><a href="#section-12.3" class="auto internal xref">12.3</a>.  <a href="#name-resolving-server-names" class="internal xref">Resolving Server Names</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.3.2.1">
                    <p id="section-toc.1-1.12.2.3.2.1.1"><a href="#section-12.3.1" class="auto internal xref">12.3.1</a>.  <a href="#name-get-well-known-matrix-serve" class="internal xref"><code>GET /.well-known/matrix/server</code></a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.4">
                <p id="section-toc.1-1.12.2.4.1"><a href="#section-12.4" class="auto internal xref">12.4</a>.  <a href="#name-request-authentication" class="internal xref">Request Authentication</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.4.2.1">
                    <p id="section-toc.1-1.12.2.4.2.1.1"><a href="#section-12.4.1" class="auto internal xref">12.4.1</a>.  <a href="#name-retrieving-server-keys" class="internal xref">Retrieving Server Keys</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.5">
                <p id="section-toc.1-1.12.2.5.1"><a href="#section-12.5" class="auto internal xref">12.5</a>.  <a href="#name-sending-events" class="internal xref">Sending Events</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.5.2.1">
                    <p id="section-toc.1-1.12.2.5.2.1.1"><a href="#section-12.5.1" class="auto internal xref">12.5.1</a>.  <a href="#name-put-_matrix-federation-v2-s" class="internal xref"><code>PUT /_matrix/federation/v2/send/:txnId</code></a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.6">
                <p id="section-toc.1-1.12.2.6.1"><a href="#section-12.6" class="auto internal xref">12.6</a>.  <a href="#name-event-and-state-apis" class="internal xref">Event and State APIs</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.6.2.1">
                    <p id="section-toc.1-1.12.2.6.2.1.1"><a href="#section-12.6.1" class="auto internal xref">12.6.1</a>.  <a href="#name-get-_matrix-federation-v2-e" class="internal xref"><code>GET /_matrix/federation/v2/event/:eventId</code></a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.6.2.2">
                    <p id="section-toc.1-1.12.2.6.2.2.1"><a href="#section-12.6.2" class="auto internal xref">12.6.2</a>.  <a href="#name-get-_matrix-federation-v1-s" class="internal xref"><code>GET /_matrix/federation/v1/state/:roomId</code></a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.6.2.3">
                    <p id="section-toc.1-1.12.2.6.2.3.1"><a href="#section-12.6.3" class="auto internal xref">12.6.3</a>.  <a href="#name-get-_matrix-federation-v1-st" class="internal xref"><code>GET /_matrix/federation/v1/state_ids/:roomId</code></a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.6.2.4">
                    <p id="section-toc.1-1.12.2.6.2.4.1"><a href="#section-12.6.4" class="auto internal xref">12.6.4</a>.  <a href="#name-get-_matrix-federation-v2-b" class="internal xref"><code>GET /_matrix/federation/v2/backfill/:roomId</code></a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.7">
                <p id="section-toc.1-1.12.2.7.1"><a href="#section-12.7" class="auto internal xref">12.7</a>.  <a href="#name-room-membership" class="internal xref">Room Membership</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.7.2.1">
                    <p id="section-toc.1-1.12.2.7.2.1.1"><a href="#section-12.7.1" class="auto internal xref">12.7.1</a>.  <a href="#name-make-and-send-handshake" class="internal xref">Make and Send Handshake</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.7.2.2">
                    <p id="section-toc.1-1.12.2.7.2.2.1"><a href="#section-12.7.2" class="auto internal xref">12.7.2</a>.  <a href="#name-invites" class="internal xref">Invites</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.7.2.3">
                    <p id="section-toc.1-1.12.2.7.2.3.1"><a href="#section-12.7.3" class="auto internal xref">12.7.3</a>.  <a href="#name-joins" class="internal xref">Joins</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.7.2.4">
                    <p id="section-toc.1-1.12.2.7.2.4.1"><a href="#section-12.7.4" class="auto internal xref">12.7.4</a>.  <a href="#name-knocks" class="internal xref">Knocks</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.8">
                <p id="section-toc.1-1.12.2.8.1"><a href="#section-12.8" class="auto internal xref">12.8</a>.  <a href="#name-content-repository" class="internal xref">Content Repository</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.9">
                <p id="section-toc.1-1.12.2.9.1"><a href="#section-12.9" class="auto internal xref">12.9</a>.  <a href="#name-ephemeral-data-units-edus" class="internal xref">Ephemeral Data Units (EDUs)</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.10">
                <p id="section-toc.1-1.12.2.10.1"><a href="#section-12.10" class="auto internal xref">12.10</a>. <a href="#name-mls" class="internal xref">MLS</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.10.2.1">
                    <p id="section-toc.1-1.12.2.10.2.1.1"><a href="#section-12.10.1" class="auto internal xref">12.10.1</a>.  <a href="#name-device-info-publishing" class="internal xref">Device Info Publishing</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.10.2.2">
                    <p id="section-toc.1-1.12.2.10.2.2.1"><a href="#section-12.10.2" class="auto internal xref">12.10.2</a>.  <a href="#name-to-device-messaging" class="internal xref">To-Device Messaging</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.10.2.3">
                    <p id="section-toc.1-1.12.2.10.2.3.1"><a href="#section-12.10.3" class="auto internal xref">12.10.3</a>.  <a href="#name-one-time-key-claiming" class="internal xref">One Time Key Claiming</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.11">
                <p id="section-toc.1-1.12.2.11.1"><a href="#section-12.11" class="auto internal xref">12.11</a>. <a href="#name-todo-remainder-of-transport" class="internal xref">TODO: Remainder of Transport</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.11.2.1">
                    <p id="section-toc.1-1.12.2.11.2.1.1"><a href="#section-12.11.1" class="auto internal xref">12.11.1</a>.  <a href="#name-open-questions" class="internal xref">Open Questions</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13">
            <p id="section-toc.1-1.13.1"><a href="#section-13" class="auto internal xref">13</a>. <a href="#name-user-privacy" class="internal xref">User Privacy</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.14">
            <p id="section-toc.1-1.14.1"><a href="#section-14" class="auto internal xref">14</a>. <a href="#name-spam-prevention" class="internal xref">Spam Prevention</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.15">
            <p id="section-toc.1-1.15.1"><a href="#section-15" class="auto internal xref">15</a>. <a href="#name-security-considerations" class="internal xref">Security Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16">
            <p id="section-toc.1-1.16.1"><a href="#section-16" class="auto internal xref">16</a>. <a href="#name-mimi-protocol-comparison" class="internal xref">MIMI Protocol Comparison</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.17">
            <p id="section-toc.1-1.17.1"><a href="#section-17" class="auto internal xref">17</a>. <a href="#name-iana-considerations" class="internal xref">IANA Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.18">
            <p id="section-toc.1-1.18.1"><a href="#section-18" class="auto internal xref">18</a>. <a href="#name-references" class="internal xref">References</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.18.2.1">
                <p id="section-toc.1-1.18.2.1.1"><a href="#section-18.1" class="auto internal xref">18.1</a>.  <a href="#name-normative-references" class="internal xref">Normative References</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.18.2.2">
                <p id="section-toc.1-1.18.2.2.1"><a href="#section-18.2" class="auto internal xref">18.2</a>.  <a href="#name-informative-references" class="internal xref">Informative References</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.19">
            <p id="section-toc.1-1.19.1"><a href="#appendix-A" class="auto internal xref"></a><a href="#name-acknowledgments" class="internal xref">Acknowledgments</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.20">
            <p id="section-toc.1-1.20.1"><a href="#appendix-B" class="auto internal xref"></a><a href="#name-authors-addresses" class="internal xref">Authors' Addresses</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="int-intro">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">Linearized Matrix derives from Matrix (<a href="https://matrix.org">matrix.org</a>). Matrix is an interoperable
decentralized communications protocol with an open specification. Matrix uses a Directed Acyclic Graph
(DAG) to persist rooms, synchronizing the DAG between servers. Linearized Matrix uses an append-only
doubly-linked list. A hub server is present in each room to persist the linked list, and to handle
linearization of events (user/application messages, as well as room configuration changes) from other
servers.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">The hub server in a room does not act as an owner for the room. All rooms support the doubly-linked
list and a DAG at the same time. The precise details of DAG and linked list interconnection are not
covered by this document; they are out of scope for the More Instant Messaging Interoperability (MIMI)
working group. Full details are available within the Matrix specification process as <span>[<a href="#MSC3995" class="cite xref">MSC3995</a>]</span>. Where
applicable, this document covers the mandatory components.<a href="#section-1-2" class="pilcrow">¶</a></p>
<p id="section-1-3">As rooms support these two representations, this permits a variable threat model. Messaging providers
who want to deliver all their messages/don't trust other servers to deliver their messages would choose
the DAG representation, at the cost of implementation complexity. Providers using the Linearized Matrix
representation place trust in the hub server to deliver the messages. Those providers attach verifiable
hashes and signatures to each event as a safeguard against the hub server modifying the events.<a href="#section-1-3" class="pilcrow">¶</a></p>
<p id="section-1-4">The primary exports of Linearized Matrix are the room model and the rules which govern how a room
accepts events. This document specifies a server-centric approach, where one or more servers perform
access control. With some changes, it can become client-centric too. This document also specifies a
transport for synchronizing the doubly-linked list to other servers. More efficient and scalable
transport methods should replace this example.<a href="#section-1-4" class="pilcrow">¶</a></p>
<p id="section-1-5">In a similar fashion, this document specifies how Messaging Layer Security (MLS) <span>[<a href="#I-D.ietf-mls-protocol" class="cite xref">I-D.ietf-mls-protocol</a>]</span>
        <span>[<a href="#I-D.ietf-mls-architecture" class="cite xref">I-D.ietf-mls-architecture</a>]</span> could run over a Linearized Matrix room. User messages use MLS, while
state events (room configuration information) are plain-text in this iteration of the document. Clients
synchronize room and MLS group membership, while servers verify those memberships. This ensures that
users who are not in the room are unable to gain access to encrypted messages.<a href="#section-1-5" class="pilcrow">¶</a></p>
<p id="section-1-6">A key component for interoperability is consistent access control semantics. Where a single server
'owns' a room, it can establish arbitrary measures. For example, an owning provider might decide that
a different kind of password is required to join a room. This diminishes the user experience on providers
who do not (or can not) support those custom measures. With decentralization, all participating servers
must use the same consistent set of access controls. Linearized Matrix uses a decentralized room model
for this reason, with linear room history for ease of implementation.<a href="#section-1-6" class="pilcrow">¶</a></p>
<p id="section-1-7">Linearized Matrix also supports transferring a hub to a different server in the room. This enables
two major features: a hub server that wishes to leave the room can do so, as it is no longer responsible
for handling events for the room, and because the hub could change at any time, access control semantics
must remain consistent. As a bonus, hub transfers make it possible for a (non-linearized) Matrix server
to take hub status. When it becomes the hub, it takes responsibility for linearizing the room's DAG
for other Linearized Matrix servers in the room. The DAG linearization algorithm is not specified in
this document; it is out of scope for the MIMI working group.<a href="#section-1-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="conventions-and-definitions">
<section id="section-2">
      <h2 id="name-conventions-and-definitions">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-conventions-and-definitions" class="section-name selfRef">Conventions and Definitions</a>
      </h2>
<p id="section-2-1">The key words "<span class="bcp14">MUST</span>", "<span class="bcp14">MUST NOT</span>", "<span class="bcp14">REQUIRED</span>", "<span class="bcp14">SHALL</span>", "<span class="bcp14">SHALL NOT</span>", "<span class="bcp14">SHOULD</span>", "<span class="bcp14">SHOULD NOT</span>", "<span class="bcp14">RECOMMENDED</span>", "<span class="bcp14">NOT RECOMMENDED</span>",
"<span class="bcp14">MAY</span>", and "<span class="bcp14">OPTIONAL</span>" in this document are to be interpreted as
described in BCP 14 <span>[<a href="#RFC2119" class="cite xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="cite xref">RFC8174</a>]</span> when, and only when, they
appear in all capitals, as shown here.<a href="#section-2-1" class="pilcrow">¶</a></p>
<p id="section-2-2">This document uses <span>[<a href="#I-D.ralston-mimi-terminology" class="cite xref">I-D.ralston-mimi-terminology</a>]</span> for the majority of terminology.<a href="#section-2-2" class="pilcrow">¶</a></p>
<p id="section-2-3">This document additionally defines:<a href="#section-2-3" class="pilcrow">¶</a></p>
<p id="section-2-4"><strong>Rejection</strong>: An event which is "rejected" is not relayed to any local clients and is not appended
to the room in any way.<a href="#section-2-4" class="pilcrow">¶</a></p>
<p id="section-2-5"><strong>Soft Failure</strong>: An event which is "soft-failed" <span class="bcp14">SHOULD NOT</span> be relayed to any local clients, nor be
used as in <code>auth_events</code> if possible. The event is otherwise appended to the room as per usual.<a href="#section-2-5" class="pilcrow">¶</a></p>
<p id="section-2-6">Further terms are introduced in-context within this document.<a href="#section-2-6" class="pilcrow">¶</a></p>
<p id="section-2-7"><strong>TODO</strong>: We should move/copy those definitions up here anyways.<a href="#section-2-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="architecture">
<section id="section-3">
      <h2 id="name-architecture">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-architecture" class="section-name selfRef">Architecture</a>
      </h2>
<p id="section-3-1">For a given conversation/room:<a href="#section-3-1" class="pilcrow">¶</a></p>
<div id="section-3-2">
        <div class="alignLeft art-svg artwork" id="section-3-2.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="400" width="552" viewBox="0 0 552 400" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
            <path d="M 8,128 L 8,192" fill="none" stroke="black"></path>
            <path d="M 56,72 L 56,128" fill="none" stroke="black"></path>
            <path d="M 56,192 L 56,272" fill="none" stroke="black"></path>
            <path d="M 104,200 L 104,240" fill="none" stroke="black"></path>
            <path d="M 112,64 L 112,120" fill="none" stroke="black"></path>
            <path d="M 160,128 L 160,192" fill="none" stroke="black"></path>
            <path d="M 288,224 L 288,288" fill="none" stroke="black"></path>
            <path d="M 336,296 L 336,352" fill="none" stroke="black"></path>
            <path d="M 392,128 L 392,192" fill="none" stroke="black"></path>
            <path d="M 392,288 L 392,344" fill="none" stroke="black"></path>
            <path d="M 440,72 L 440,128" fill="none" stroke="black"></path>
            <path d="M 440,224 L 440,288" fill="none" stroke="black"></path>
            <path d="M 496,64 L 496,120" fill="none" stroke="black"></path>
            <path d="M 544,128 L 544,192" fill="none" stroke="black"></path>
            <path d="M 40,32 L 128,32" fill="none" stroke="black"></path>
            <path d="M 424,32 L 512,32" fill="none" stroke="black"></path>
            <path d="M 40,64 L 128,64" fill="none" stroke="black"></path>
            <path d="M 424,64 L 512,64" fill="none" stroke="black"></path>
            <path d="M 8,128 L 160,128" fill="none" stroke="black"></path>
            <path d="M 392,128 L 544,128" fill="none" stroke="black"></path>
            <path d="M 160,144 L 248,144" fill="none" stroke="black"></path>
            <path d="M 320,144 L 384,144" fill="none" stroke="black"></path>
            <path d="M 168,176 L 248,176" fill="none" stroke="black"></path>
            <path d="M 320,176 L 392,176" fill="none" stroke="black"></path>
            <path d="M 8,192 L 160,192" fill="none" stroke="black"></path>
            <path d="M 392,192 L 544,192" fill="none" stroke="black"></path>
            <path d="M 288,224 L 440,224" fill="none" stroke="black"></path>
            <path d="M 104,240 L 144,240" fill="none" stroke="black"></path>
            <path d="M 216,240 L 288,240" fill="none" stroke="black"></path>
            <path d="M 56,272 L 144,272" fill="none" stroke="black"></path>
            <path d="M 216,272 L 280,272" fill="none" stroke="black"></path>
            <path d="M 288,288 L 440,288" fill="none" stroke="black"></path>
            <path d="M 320,352 L 408,352" fill="none" stroke="black"></path>
            <path d="M 320,384 L 408,384" fill="none" stroke="black"></path>
            <path d="M 40,32 C 31.16936,32 24,39.16936 24,48" fill="none" stroke="black"></path>
            <path d="M 128,32 C 136.83064,32 144,39.16936 144,48" fill="none" stroke="black"></path>
            <path d="M 424,32 C 415.16936,32 408,39.16936 408,48" fill="none" stroke="black"></path>
            <path d="M 512,32 C 520.83064,32 528,39.16936 528,48" fill="none" stroke="black"></path>
            <path d="M 40,64 C 31.16936,64 24,56.83064 24,48" fill="none" stroke="black"></path>
            <path d="M 128,64 C 136.83064,64 144,56.83064 144,48" fill="none" stroke="black"></path>
            <path d="M 424,64 C 415.16936,64 408,56.83064 408,48" fill="none" stroke="black"></path>
            <path d="M 512,64 C 520.83064,64 528,56.83064 528,48" fill="none" stroke="black"></path>
            <path d="M 320,352 C 311.16936,352 304,359.16936 304,368" fill="none" stroke="black"></path>
            <path d="M 408,352 C 416.83064,352 424,359.16936 424,368" fill="none" stroke="black"></path>
            <path d="M 320,384 C 311.16936,384 304,376.83064 304,368" fill="none" stroke="black"></path>
            <path d="M 408,384 C 416.83064,384 424,376.83064 424,368" fill="none" stroke="black"></path>
            <polygon class="arrowhead" points="504,120 492,114.4 492,125.6" fill="black" transform="rotate(90,496,120)"></polygon>
            <polygon class="arrowhead" points="448,72 436,66.4 436,77.6" fill="black" transform="rotate(270,440,72)"></polygon>
            <polygon class="arrowhead" points="400,344 388,338.4 388,349.6" fill="black" transform="rotate(90,392,344)"></polygon>
            <polygon class="arrowhead" points="392,144 380,138.4 380,149.6" fill="black" transform="rotate(0,384,144)"></polygon>
            <polygon class="arrowhead" points="344,296 332,290.4 332,301.6" fill="black" transform="rotate(270,336,296)"></polygon>
            <polygon class="arrowhead" points="288,272 276,266.4 276,277.6" fill="black" transform="rotate(0,280,272)"></polygon>
            <polygon class="arrowhead" points="176,176 164,170.4 164,181.6" fill="black" transform="rotate(180,168,176)"></polygon>
            <polygon class="arrowhead" points="120,120 108,114.4 108,125.6" fill="black" transform="rotate(90,112,120)"></polygon>
            <polygon class="arrowhead" points="112,200 100,194.4 100,205.6" fill="black" transform="rotate(270,104,200)"></polygon>
            <polygon class="arrowhead" points="64,72 52,66.4 52,77.6" fill="black" transform="rotate(270,56,72)"></polygon>
            <g class="text">
              <text x="76" y="52">Client</text>
              <text x="112" y="52">A</text>
              <text x="460" y="52">Client</text>
              <text x="496" y="52">B</text>
              <text x="184" y="100">Client-Server</text>
              <text x="256" y="100">API</text>
              <text x="284" y="148">events</text>
              <text x="80" y="164">Provider/Server</text>
              <text x="464" y="164">Provider/Server</text>
              <text x="80" y="180">A</text>
              <text x="284" y="180">events</text>
              <text x="464" y="180">B</text>
              <text x="240" y="196">Server-Server</text>
              <text x="332" y="196">Protocol</text>
              <text x="180" y="244">events</text>
              <text x="360" y="260">Provider/Server</text>
              <text x="180" y="276">events</text>
              <text x="360" y="276">C</text>
              <text x="356" y="372">Client</text>
              <text x="392" y="372">C</text>
            </g>
          </svg><a href="#section-3-2.1" class="pilcrow">¶</a>
</div>
</div>
<p id="section-3-3">In this diagram, events (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>) are objects which carry information about the room as well as messages
between users within that room.<a href="#section-3-3" class="pilcrow">¶</a></p>
<p id="section-3-4">Server A is acting as a hub for the other two servers in the diagram. Servers B and C do
not converse directly when sending events to the room: those events are instead sent to the
hub which then distributes them back out to all participating servers. Servers communicate
with each other using the API surface described by <a href="#int-transport" class="auto internal xref">Section 12</a>.<a href="#section-3-4" class="pilcrow">¶</a></p>
<p id="section-3-5">Clients are shown in the diagram here for demonstrative purposes only. No Client-Server API
or other requirements of clients are specified in this document.<a href="#section-3-5" class="pilcrow">¶</a></p>
<p id="section-3-6">This leads to two distinct roles:<a href="#section-3-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3-7.1">
          <p id="section-3-7.1.1"><strong>Hub server</strong>: the server responsible for holding conversation history on behalf of
other servers in the room.<a href="#section-3-7.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-7.2">
          <p id="section-3-7.2.1"><strong>Participant server</strong>: any non-hub server. This server <span class="bcp14">MAY</span> persist conversation history
or rely on the hub server instead.<a href="#section-3-7.2.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-3-8"><strong>OPEN QUESTION</strong>: Should we support having multiple hubs for increased trust between
participant and hub? (participant can pick the hub it wants to use rather than being
forced to use a single hub)<a href="#section-3-8" class="pilcrow">¶</a></p>
<p id="section-3-9"><strong>OPEN QUESTION</strong>: Should we instead require that each server persist events they create, with the hub
being responsible for purely distribution/fetching? It'd be in the hub's best interest to store all
history, but equally if it can rebuild the room by reaching out to origin servers then it might be
fine enough (it'd only be storing event IDs rather than whole events).<a href="#section-3-9" class="pilcrow">¶</a></p>
<div id="int-server-names">
<section id="section-3.1">
        <h3 id="name-server-names">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-server-names" class="section-name selfRef">Server Names</a>
        </h3>
<p id="section-3.1-1">Each messaging provider is referred to as a "server" and has a "domain name" or "server name"
to uniquely identify it. This server name is then used to namespace user IDs, room IDs/aliases,
etc.<a href="#section-3.1-1" class="pilcrow">¶</a></p>
<p id="section-3.1-2">A server name <span class="bcp14">MUST</span> be compliant with <span><a href="https://rfc-editor.org/rfc/rfc1123#section-2.1" class="relref">Section 2.1</a> of [<a href="#RFC1123" class="cite xref">RFC1123</a>]</span>. Improper server names <span class="bcp14">MUST</span> be
considered "uncontactable" by a server.<a href="#section-3.1-2" class="pilcrow">¶</a></p>
<p id="section-3.1-3">A server <span class="bcp14">MUST NOT</span> use a literal IPv4 or IPv6 address as a server name. Doing so reduces the ability
for the server to move to another internet address later, and IP addresses are generally difficult
to acquire a certificate for (required in <a href="#int-transport" class="auto internal xref">Section 12</a>). Additionally, servers <span class="bcp14">SHOULD NOT</span> use
an explicit port in their server name for similar portability reasons.<a href="#section-3.1-3" class="pilcrow">¶</a></p>
<p id="section-3.1-4">The approximate ABNF <span>[<a href="#RFC5234" class="cite xref">RFC5234</a>]</span> grammar for a server name is:<a href="#section-3.1-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3.1-5">
<pre>
server_name = hostname [ ":" port ]
port        = 1*5DIGIT
hostname    = 1*255dns-char
dns-char    = DIGIT / ALPHA / "-" / "."
</pre><a href="#section-3.1-5" class="pilcrow">¶</a>
</div>
<p id="section-3.1-6">Server names <span class="bcp14">MUST</span> be treated as case sensitive (<code>eXaMpLe.OrG</code>, <code>example.org</code>, and <code>EXAMPLE.ORG</code>
are 3 different servers). Server names <span class="bcp14">SHOULD</span> be lower case (<code>example.org</code>) and <span class="bcp14">SHOULD NOT</span> exceed
230 characters for ease of use. The 230 characters specifically gives room for a suitably long
localpart while being within the 255 allowable characters from <span><a href="https://rfc-editor.org/rfc/rfc1123#section-2.1" class="relref">Section 2.1</a> of [<a href="#RFC1123" class="cite xref">RFC1123</a>]</span>.<a href="#section-3.1-6" class="pilcrow">¶</a></p>
<p id="section-3.1-7">Examples:<a href="#section-3.1-7" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.1-8.1">
            <p id="section-3.1-8.1.1"><code>example.org</code> (DNS host name)<a href="#section-3.1-8.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.1-8.2">
            <p id="section-3.1-8.2.1"><code>example.org:5678</code> (DNS host name with explicit port)<a href="#section-3.1-8.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="int-room-id">
<section id="section-3.2">
        <h3 id="name-rooms">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-rooms" class="section-name selfRef">Rooms</a>
        </h3>
<p id="section-3.2-1">Rooms hold the same definition under <span>[<a href="#I-D.ralston-mimi-terminology" class="cite xref">I-D.ralston-mimi-terminology</a>]</span>: a conceptual place
where users send and receive events. All users with sufficient access to the room receive
events sent to that room.<a href="#section-3.2-1" class="pilcrow">¶</a></p>
<p id="section-3.2-2">The different chat types are represented by rooms through state events (<a href="#int-state-events" class="auto internal xref">Section 3.5.2</a>), which
ultimately change how the different algorithms in the room version (<a href="#int-room-versions" class="auto internal xref">Section 3.2.1</a>) behave.<a href="#section-3.2-2" class="pilcrow">¶</a></p>
<p id="section-3.2-3">Rooms have a single internal "Room ID" to identify them from another room. The ABNF <span>[<a href="#RFC5234" class="cite xref">RFC5234</a>]</span>
grammar for a room ID is:<a href="#section-3.2-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3.2-4">
<pre>
room_id = "!" room_id_localpart ":" server_name
room_id_localpart = 1*opaque
opaque = DIGIT / ALPHA / "-" / "." / "~" / "_"
</pre><a href="#section-3.2-4" class="pilcrow">¶</a>
</div>
<p id="section-3.2-5"><code>server_name</code> is inherited from <a href="#int-server-names" class="auto internal xref">Section 3.1</a>.<a href="#section-3.2-5" class="pilcrow">¶</a></p>
<p id="section-3.2-6"><code>room_id</code> <span class="bcp14">MUST NOT</span> exceed 255 characters and <span class="bcp14">MUST</span> be treated as case sensitive.<a href="#section-3.2-6" class="pilcrow">¶</a></p>
<p id="section-3.2-7">Example: <code>!abc:example.org</code>.<a href="#section-3.2-7" class="pilcrow">¶</a></p>
<p id="section-3.2-8">The <code>server_name</code> for a room ID does <em>NOT</em> indicate the room is "hosted" or served by that
domain. The domain is used as a namespace to prevent another server from maliciously taking
over a room. The server represented by that domain may no longer be participating in the room.<a href="#section-3.2-8" class="pilcrow">¶</a></p>
<p id="section-3.2-9">The entire room ID after the <code>!</code> sigil <span class="bcp14">MUST</span> be treated as opaque. No part of the room ID should
be parsed, and cannot be assumed to be human-readable.<a href="#section-3.2-9" class="pilcrow">¶</a></p>
<div id="int-room-versions">
<section id="section-3.2.1">
          <h4 id="name-room-versions">
<a href="#section-3.2.1" class="section-number selfRef">3.2.1. </a><a href="#name-room-versions" class="section-name selfRef">Room Versions</a>
          </h4>
<p id="section-3.2.1-1"><strong>TODO</strong>: We should consider naming this something else.<a href="#section-3.2.1-1" class="pilcrow">¶</a></p>
<p id="section-3.2.1-2">Each room declares which room version it's using, and each room version (identified by a single
string) describes the specific algorithms a server needs to follow in order to particpate in rooms
with that version. Room versions are immutable once specified, as otherwise a change in algorithms
could cause a split-brain between servers participating in affected rooms.<a href="#section-3.2.1-2" class="pilcrow">¶</a></p>
<p id="section-3.2.1-3">Room versions prefixed with <code>I.</code> <span class="bcp14">MUST</span> only be used within the IETF specification process.
Room versions consisting solely of <code>0-9</code> and <code>.</code> <span class="bcp14">MUST</span> only be used by the Matrix protocol.<a href="#section-3.2.1-3" class="pilcrow">¶</a></p>
<p id="section-3.2.1-4">This document as a whole describes <code>I.1</code> as a room version.<a href="#section-3.2.1-4" class="pilcrow">¶</a></p>
<p id="section-3.2.1-5">Servers <span class="bcp14">MUST</span> implement support for <code>I.1</code> at a minimum. Servers <span class="bcp14">SHOULD</span> use <code>I.1</code> when creating
new rooms.<a href="#section-3.2.1-5" class="pilcrow">¶</a></p>
<p id="section-3.2.1-6"><strong>Implementation note</strong>: Currently <code>I.1</code> is not a real thing. Use
<code>org.matrix.i-d.ralston-mimi-linearized-matrix.02</code> when testing against other Linearized Matrix
implementations. This string may be updated later to account for breaking changes.<a href="#section-3.2.1-6" class="pilcrow">¶</a></p>
<p id="section-3.2.1-7"><strong>Implementation note</strong>: <code>org.matrix.i-d.ralston-mimi-linearized-matrix.00</code> also exists in the
wild, defining a set of algorithms which exist in a prior version of this document (00 and 01).<a href="#section-3.2.1-7" class="pilcrow">¶</a></p>
<p id="section-3.2.1-8"><strong>TODO</strong>: Remove implementation notes.<a href="#section-3.2.1-8" class="pilcrow">¶</a></p>
<p id="section-3.2.1-9">There is no implicit ordering or hierarchy to room versions. Future room versions, such as an <code>I.2</code>,
can choose to build upon <code>I.1</code>'s algorithms or start completely from scratch if they prefer.<a href="#section-3.2.1-9" class="pilcrow">¶</a></p>
<p id="section-3.2.1-10">A room version has the following algorithms defined:<a href="#section-3.2.1-10" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.2.1-11.1">
              <p id="section-3.2.1-11.1.1">Event authorization - Rules which govern when events are accepted, rejected, or soft-failed
by a server. For <code>I.1</code>, this is <a href="#int-auth-rules" class="auto internal xref">Section 5.2</a>.<a href="#section-3.2.1-11.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-3.2.1-11.2">
              <p id="section-3.2.1-11.2.1">Redaction - Description of which fields to keep on an event during redaction. Redaction is
used by the signing and hash algorithms, meaning they need to be consistent across implementations.
For <code>I.1</code>, this is <a href="#int-redactions" class="auto internal xref">Section 8</a>.<a href="#section-3.2.1-11.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-3.2.1-11.3">
              <p id="section-3.2.1-11.3.1">Event format - Which fields are expected to be present on an event, and the schema for each. For
<code>I.1</code>, this is <a href="#int-pdu" class="auto internal xref">Section 3.5</a>.<a href="#section-3.2.1-11.3.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-3.2.1-11.4">
              <p id="section-3.2.1-11.4.1">Canonical JSON - Specific details about how to canonicalize an event as JSON. This is used
by the signing algorithm and must be consistent between implementations. For <code>I.1</code>, this is
<a href="#int-canonical-json" class="auto internal xref">Section 7</a>.<a href="#section-3.2.1-11.4.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-3.2.1-11.5">
              <p id="section-3.2.1-11.5.1">Hub selection - Rules around picking the hub server and transferring to a new hub. For <code>I.1</code>,
this is <a href="#int-hub-selection" class="auto internal xref">Section 11</a>.<a href="#section-3.2.1-11.5.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-3.2.1-11.6">
              <p id="section-3.2.1-11.6.1">Identifier grammar - All identifiers (room IDs, user IDs, event IDs, etc) can change grammar
within a room version. As such, they <span class="bcp14">SHOULD</span> generally be treated as opaque as possible over a
transport. For <code>I.1</code>, these details are described in <a href="#int-server-names" class="auto internal xref">Section 3.1</a>, <a href="#int-room-id" class="auto internal xref">Section 3.2</a>,
<a href="#int-user-id" class="auto internal xref">Section 3.3</a>, <a href="#int-device-id" class="auto internal xref">Section 3.4</a>, and <a href="#int-pdu" class="auto internal xref">Section 3.5</a>.<a href="#section-3.2.1-11.6.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-3.2.1-12">The transport between servers is decoupled from the algorithms above. For example, events are
treated as blobs with no specific format over the wire but have strict schema in the context
of a room or room version. Endpoints <span class="bcp14">MUST</span> be designed with this distinction in mind.<a href="#section-3.2.1-12" class="pilcrow">¶</a></p>
<p id="section-3.2.1-13">Each room version has a "stable" or "unstable" designation. Stable room versions <span class="bcp14">SHOULD</span> be used
in production by messaging providers. Unstable room versions might contain bugs or are not yet
fully specified and <span class="bcp14">SHOULD NOT</span> be used in production by messaging providers.<a href="#section-3.2.1-13" class="pilcrow">¶</a></p>
<p id="section-3.2.1-14"><code>I.1</code> shall be considered "stable".<a href="#section-3.2.1-14" class="pilcrow">¶</a></p>
<p id="section-3.2.1-15"><strong>Implementation note</strong>: <code>org.matrix.i-d.ralston-mimi-linearized-matrix.02</code> is considered "unstable".<a href="#section-3.2.1-15" class="pilcrow">¶</a></p>
<p id="section-3.2.1-16"><strong>TODO</strong>: Remove implementation notes.<a href="#section-3.2.1-16" class="pilcrow">¶</a></p>
<p id="section-3.2.1-17"><strong>TODO</strong>: Matrix considers a version as stable once accepted through FCP. When would be the
process equivalent for the IETF?<a href="#section-3.2.1-17" class="pilcrow">¶</a></p>
<p id="section-3.2.1-18">The ABNF <span>[<a href="#RFC5234" class="cite xref">RFC5234</a>]</span> grammar for a room version is:<a href="#section-3.2.1-18" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3.2.1-19">
<pre>
room_version = 1*128room_version_char
room_version_char = DIGIT
                  / %x61-7A         ; a-z
                  / "-" / "."
</pre><a href="#section-3.2.1-19" class="pilcrow">¶</a>
</div>
<p id="section-3.2.1-20">Examples:<a href="#section-3.2.1-20" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.2.1-21.1">
              <p id="section-3.2.1-21.1.1"><code>1</code><a href="#section-3.2.1-21.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-3.2.1-21.2">
              <p id="section-3.2.1-21.2.1"><code>I.1</code><a href="#section-3.2.1-21.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-3.2.1-21.3">
              <p id="section-3.2.1-21.3.1"><code>org.example.my-room-version</code><a href="#section-3.2.1-21.3.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-3.2.1-22">Room versions not formally specified <span class="bcp14">SHOULD</span> be prefixed using reverse domain name notation,
creating a sort of namespace. <code>org.example.my-room-version</code> is an example of this.<a href="#section-3.2.1-22" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="int-user-id">
<section id="section-3.3">
        <h3 id="name-users">
<a href="#section-3.3" class="section-number selfRef">3.3. </a><a href="#name-users" class="section-name selfRef">Users</a>
        </h3>
<p id="section-3.3-1">As described by <span>[<a href="#I-D.ralston-mimi-terminology" class="cite xref">I-D.ralston-mimi-terminology</a>]</span>, a user is typically a human which operates
a client. Each user has a distinct user ID.<a href="#section-3.3-1" class="pilcrow">¶</a></p>
<p id="section-3.3-2">The ABNF <span>[<a href="#RFC5234" class="cite xref">RFC5234</a>]</span> grammar for a user ID is:<a href="#section-3.3-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3.3-3">
<pre>
user_id = "@" user_id_localpart ":" server_name
user_id_localpart = 1*user_id_char
user_id_char = DIGIT
             / %x61-7A                   ; a-z
             / "-" / "." / "="
             / "_" / "/" / "+"
</pre><a href="#section-3.3-3" class="pilcrow">¶</a>
</div>
<p id="section-3.3-4"><code>server_name</code> is inherited from <a href="#int-server-names" class="auto internal xref">Section 3.1</a>.<a href="#section-3.3-4" class="pilcrow">¶</a></p>
<p id="section-3.3-5"><code>user_id</code> <span class="bcp14">MUST NOT</span> exceed 255 characters and <span class="bcp14">MUST</span> be treated as case sensitive.<a href="#section-3.3-5" class="pilcrow">¶</a></p>
<p id="section-3.3-6">Examples:<a href="#section-3.3-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.3-7.1">
            <p id="section-3.3-7.1.1"><code>@alice:example.org</code><a href="#section-3.3-7.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.3-7.2">
            <p id="section-3.3-7.2.1"><code>@watch/for/slashes:example.org</code><a href="#section-3.3-7.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-3.3-8"><code>user_id_localpart</code> <span class="bcp14">SHOULD</span> be human-readable and notably <span class="bcp14">MUST NOT</span> contain uppercase letters.<a href="#section-3.3-8" class="pilcrow">¶</a></p>
<p id="section-3.3-9"><code>server_name</code> denotes the domain name (<a href="#int-server-names" class="auto internal xref">Section 3.1</a>) which allocated the ID, or would allocate
the ID if the user doesn't exist yet.<a href="#section-3.3-9" class="pilcrow">¶</a></p>
<p id="section-3.3-10">Identity systems and messaging providers <span class="bcp14">SHOULD NOT</span> use a phone number in a localpart. Using a phone
number would mean that when a human operator's changes their phone number then they'd lose access to
their existing chats and potentially gain access to any chats the new number is participating in.
Providers which use phone numbers <span class="bcp14">SHOULD</span> ensure the new user ID is not in chats belonging to a different
logical user. To prevent this case, a GUID (scoped to the allocating server) or an account ID is
recommended as a localpart, allowing users to change their phone number without losing chats.<a href="#section-3.3-10" class="pilcrow">¶</a></p>
<p id="section-3.3-11">This document does not define how a user ID is acquired. It is expected that an identity specification
under MIMI will handle resolving email addresses, phone numbers, names, and other common queries
to user IDs.<a href="#section-3.3-11" class="pilcrow">¶</a></p>
<p id="section-3.3-12">User IDs are sometimes informally referenced as "MXIDs", short for "Matrix User IDs".<a href="#section-3.3-12" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-device-id">
<section id="section-3.4">
        <h3 id="name-devices">
<a href="#section-3.4" class="section-number selfRef">3.4. </a><a href="#name-devices" class="section-name selfRef">Devices</a>
        </h3>
<p id="section-3.4-1">Each user can have zero or more devices/active clients. These devices are intended to be members
of the MLS group and thus have their own key package material associated with them.<a href="#section-3.4-1" class="pilcrow">¶</a></p>
<p id="section-3.4-2">Because device IDs are used as "key versions" in a key ID (<a href="#int-signing" class="auto internal xref">Section 6</a>), they have a compatible
ABNF <span>[<a href="#RFC5234" class="cite xref">RFC5234</a>]</span> grammar:<a href="#section-3.4-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3.4-3">
<pre>
device_id = 1*key_version_char
device_id_char = ALPHA / DIGIT / "_"
</pre><a href="#section-3.4-3" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="int-pdu">
<section id="section-3.5">
        <h3 id="name-events">
<a href="#section-3.5" class="section-number selfRef">3.5. </a><a href="#name-events" class="section-name selfRef">Events</a>
        </h3>
<p id="section-3.5-1">All data exchanged over Linearized Matrix is expressed as an "event". Each client action
(such as sending a message) correlates with exactly one event. All events have a <code>type</code>
to distinguish them, and use reverse domain name notation to namespace custom events
(for example, <code>org.example.appname.eventname</code>).<a href="#section-3.5-1" class="pilcrow">¶</a></p>
<p id="section-3.5-2">Event types using <code>m.</code> as a prefix <span class="bcp14">MUST</span> only be used by the protocol.<a href="#section-3.5-2" class="pilcrow">¶</a></p>
<p id="section-3.5-3">When events are traversing a transport to another server they are referred to as a
<strong>Persistent Data Unit</strong> or <strong>PDU</strong>. Structurally, an event and PDU are the same.<a href="#section-3.5-3" class="pilcrow">¶</a></p>
<p id="section-3.5-4">An event has the following minimum fields:<a href="#section-3.5-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.5-5.1">
            <p id="section-3.5-5.1.1"><code>room_id</code> (string; required) - The room ID for where the event is being sent. This <span class="bcp14">MUST</span> be
a valid room ID (<a href="#int-room-id" class="auto internal xref">Section 3.2</a>).<a href="#section-3.5-5.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.5-5.2">
            <p id="section-3.5-5.2.1"><code>type</code> (string; required) - A UTF-8 <span>[<a href="#RFC3629" class="cite xref">RFC3629</a>]</span> string to distinguish different data types
being carried by events. Event types are case sensitive. This <span class="bcp14">MUST NOT</span> exceed 255 characters.<a href="#section-3.5-5.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.5-5.3">
            <p id="section-3.5-5.3.1"><code>state_key</code> (string; optional) - A UTF-8 <span>[<a href="#RFC3629" class="cite xref">RFC3629</a>]</span> string to further distinguish an event
as a state event (see <a href="#int-state-events" class="auto internal xref">Section 3.5.2</a>). Can be an empty string. This <span class="bcp14">MUST NOT</span> exceed 255
characters.<a href="#section-3.5-5.3.1" class="pilcrow">¶</a></p>
<p id="section-3.5-5.3.2">
Each event type specifies its own state key requirements. For <code>m.room.member</code> (<a href="#int-ev-member" class="auto internal xref">Section 3.5.3.3</a>),
the state key is the user ID (<a href="#int-user-id" class="auto internal xref">Section 3.3</a>) for which the membership applies to. For
<code>m.room.join_rules</code> (<a href="#int-ev-join-rules" class="auto internal xref">Section 3.5.3.2</a>), this is an empty string. For a custom event type
this may be an opaque string such as a UUID or randomly generated string.<a href="#section-3.5-5.3.2" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.5-5.4">
            <p id="section-3.5-5.4.1"><code>sender</code> (string; required) - The user ID which is sending this event. This <span class="bcp14">MUST</span> be a valid
user ID (<a href="#int-user-id" class="auto internal xref">Section 3.3</a>).<a href="#section-3.5-5.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.5-5.5">
            <p id="section-3.5-5.5.1"><code>origin_server_ts</code> (64-bit integer; required) - The milliseconds since the unix epoch for when this
event was created.<a href="#section-3.5-5.5.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.5-5.6">
            <p id="section-3.5-5.6.1"><code>hub_server</code> (string; optional) - When a hub server is converting an LPDU (<a href="#int-lpdu" class="auto internal xref">Section 3.5.1</a>) to a
formal event, it <span class="bcp14">MUST</span> specify its own server name (<a href="#int-server-names" class="auto internal xref">Section 3.1</a>) here. The value <span class="bcp14">MUST</span> be
a valid server name.<a href="#section-3.5-5.6.1" class="pilcrow">¶</a></p>
<p id="section-3.5-5.6.2">
To support interconnection with non-linearized Matrix, as discussed in <a href="#int-intro" class="auto internal xref">Section 1</a>, events
created outside of a hub server <span class="bcp14">MUST NOT</span> populate this field.<a href="#section-3.5-5.6.2" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.5-5.7">
            <p id="section-3.5-5.7.1"><code>content</code> (object; required) - The event content. The specific schema depends on the event
type. Clients and servers processing an event <span class="bcp14">MUST NOT</span> assume the <code>content</code> is safe or
accurately represented. Malicious clients and servers are able to send payloads which don't
comply with a given schema, which may cause unexpected behaviour on the receiving side.
For example, a field marked as "required" might be missing.<a href="#section-3.5-5.7.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.5-5.8">
            <p id="section-3.5-5.8.1"><code>hashes</code> (object; required) - The content hashes (<a href="#int-content-hashes" class="auto internal xref">Section 9.1</a>) for the event. There is
a special <code>lpdu</code> key to contain the LPDU (partial PDU schema; see <a href="#int-lpdu" class="auto internal xref">Section 3.5.1</a>) hashes, which is
itself keyed by hash algorithm and has the encoded hash as the value. The <code>hashes</code> object, outside
of <code>lpdu</code>, similarly is keyed by hash algorithm with encoded hash values.<a href="#section-3.5-5.8.1" class="pilcrow">¶</a></p>
<p id="section-3.5-5.8.2">
Events which specify a <code>hub_server</code> <span class="bcp14">MUST</span> additionally contain an <code>lpdu</code> hash. All other events <span class="bcp14">MUST NOT</span> contain <code>lpdu</code> hashes. This is to support interconnection with non-linearized Matrix, as discussed
in <a href="#int-intro" class="auto internal xref">Section 1</a>.<a href="#section-3.5-5.8.2" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.5-5.9">
            <p id="section-3.5-5.9.1"><code>signatures</code> (object; required) - Keyed first by domain name then by key ID, the signatures for
the event.<a href="#section-3.5-5.9.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.5-5.10">
            <p id="section-3.5-5.10.1"><code>auth_events</code> (array of strings; required) - The event IDs which prove the sender is able to
send this event in the room. Which specific events are put here are defined by the auth events
selection algorithm (<a href="#int-auth-selection" class="auto internal xref">Section 5.2.1</a>).<a href="#section-3.5-5.10.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.5-5.11">
            <p id="section-3.5-5.11.1"><code>prev_events</code> (array of strings; required) - This field is to support interconnection with
non-linearized Matrix, discussed in <a href="#int-intro" class="auto internal xref">Section 1</a>. Events which specify a <code>hub_server</code> are expected
to have exactly 1 entry in this array, while other events <span class="bcp14">MAY</span> have 1 or more entries.<a href="#section-3.5-5.11.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-3.5-6">Note that an event ID is not specified on the schema. Event IDs are calculated to ensure accuracy
and consistency between servers. To determine the ID for an event, calculate the reference hash
(<a href="#int-reference-hashes" class="auto internal xref">Section 9.2</a>) then encode it using URL-safe Unpadded Base64 (<a href="#int-unpadded-base64" class="auto internal xref">Section 10</a>)
and prefix that with the event ID sigil, <code>$</code>. For example, <code>$nKHVqt3iyLA_HEE8lT1yUaaVjjBRR-fAqpN4t7opadc</code>.<a href="#section-3.5-6" class="pilcrow">¶</a></p>
<p id="section-3.5-7">Using a reference hash in the event ID prevents other servers from changing what that event ID represents.
If an event ID was just a UUID (or similar), any server along the send or receive path could swap the
actual event payload out for a different event. The hashes and signatures in this case do nothing to
protect the actual event, as a malicious server can simply generate legal hashes/signatures as part of
their modification. If we add a namespace condition where the event ID <em>must</em> reference the same server
name as the <code>sender</code> (<code>$uuid:example.org</code>) then the sending server is free to re-assign the event ID
to a different payload during the sending of that event, though all other servers along the send/receive
path cannot change the event. This is particularly problematic if the event's sender is the hub for
the room: the hub can send one copy of an event to half the room, and a very different copy to the other
half while still maintaining the same event ID for both halves. To fix this, a hash of the event itself
would need to become part of the event ID such that any modification or reassignment of the event ID
is made obvious to receipient servers. This could be a tuple of <code>(uuid, hash)</code>, though for simplicity
this document uses just the reference hash on its own.<a href="#section-3.5-7" class="pilcrow">¶</a></p>
<p id="section-3.5-8">With event IDs containing hashes of the events it's theoretically possible for a sufficiently motivated
person to build a database of event IDs. With that database, they could eventually determine enough
information to identify parts of the event payload itself. There is not enough anchoring information
on an event (or sent over the transport) for this to be efficient or effective, however.<a href="#section-3.5-8" class="pilcrow">¶</a></p>
<p id="section-3.5-9">The ABNF <span>[<a href="#RFC5234" class="cite xref">RFC5234</a>]</span> for an event ID is:<a href="#section-3.5-9" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3.5-10">
<pre>
event_id = "$" reference_hash
reference_hash = 1*urlsafe_unpadded_base64_char
urlsafe_unpadded_base64_char = ALPHA / DIGIT / "-" / "_"
</pre><a href="#section-3.5-10" class="pilcrow">¶</a>
</div>
<p id="section-3.5-11">If both the sender and receiver are implementing the algorithms correctly, the event ID will be
the same. When different, the receiver will have issues accepting the event (none of the <code>auth_events</code>
will make sense, for example). The sender and receiver will need to review that their implementation
matches the specification in this case.<a href="#section-3.5-11" class="pilcrow">¶</a></p>
<p id="section-3.5-12">Events are treated as JSON <span>[<a href="#RFC8259" class="cite xref">RFC8259</a>]</span> within the protocol, but can be encoded and represented by
any binary-compatible format. Additional overhead may be introduced when converting between formats,
however.<a href="#section-3.5-12" class="pilcrow">¶</a></p>
<p id="section-3.5-13">An example event is:<a href="#section-3.5-13" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-3.5-14">
<pre>
{
  "room_id": "!abc:example.org",
  "type": "m.room.member",
  "state_key": "@alice:first.example.org",
  "sender": "@bob:second.example.org",
  "origin_server_ts": 1681340188825,
  "hub_server": "first.example.org",
  "content": {
    "membership": "invite"
  },
  "hashes": {
    "lpdu": {
      "sha256": "&lt;unpadded base64&gt;"
    },
    "sha256": "&lt;unpadded base64&gt;"
  },
  "signatures": {
    "first.example.org": {
      "ed25519:1": "&lt;unpadded base64 signature covering whole event&gt;"
    },
    "second.example.org": {
      "ed25519:1": "&lt;unpadded base64 signature covering LPDU&gt;"
    }
  },
  "auth_events": ["$first", "$second"],
  "prev_events": ["$parent"]
}
</pre><a href="#section-3.5-14" class="pilcrow">¶</a>
</div>
<p id="section-3.5-15">An event/PDU <span class="bcp14">MUST NOT</span> exceed 65536 bytes when formatted using Canonical JSON (<a href="#int-canonical-json" class="auto internal xref">Section 7</a>).
Note that this includes all <code>signatures</code> on the event.<a href="#section-3.5-15" class="pilcrow">¶</a></p>
<p id="section-3.5-16">Fields have no size limit unless specified above, other than the maximum 65536 bytes for the whole
event.<a href="#section-3.5-16" class="pilcrow">¶</a></p>
<div id="int-lpdu">
<section id="section-3.5.1">
          <h4 id="name-linearized-pdu">
<a href="#section-3.5.1" class="section-number selfRef">3.5.1. </a><a href="#name-linearized-pdu" class="section-name selfRef">Linearized PDU</a>
          </h4>
<p id="section-3.5.1-1">All events generated by participant servers are routed through the hub, but the participant servers
themselves are unable to populate fields like <code>prev_events</code> because they can't guarantee order and
those fields contribute to the event ID, signatures, and overall validity. To fix this, participant
servers send the hub server a "Linearized PDU" or "LPDU" which does not include the fields they cannot
set while still ensuring integrity of the event contents themselves.<a href="#section-3.5.1-1" class="pilcrow">¶</a></p>
<p id="section-3.5.1-2">The participant server <span class="bcp14">MUST NOT</span> populate the following fields on events (LPDUs) they are sending to
the hub:<a href="#section-3.5.1-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.5.1-3.1">
              <p id="section-3.5.1-3.1.1"><code>auth_events</code> - the participant cannot reliably determine what allows it to send the event.<a href="#section-3.5.1-3.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-3.5.1-3.2">
              <p id="section-3.5.1-3.2.1"><code>prev_events</code> - the participant cannot reliably know what event precedes theirs.<a href="#section-3.5.1-3.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-3.5.1-3.3">
              <p id="section-3.5.1-3.3.1"><code>hashes</code> (except <code>hashes.lpdu</code>) - top-level hashes cover the above two fields.<a href="#section-3.5.1-3.3.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-3.5.1-4">The participant server <span class="bcp14">MUST</span> populate the <code>hashes.lpdu</code> object, covering a content hash
(<a href="#int-content-hashes" class="auto internal xref">Section 9.1</a>) of the partial event, giving authenticity to the sender's contents. The
participant server additionally signs this partial event before sending it to the hub.<a href="#section-3.5.1-4" class="pilcrow">¶</a></p>
<p id="section-3.5.1-5">The participant server will receive an echo of the fully-formed event from the hub once appended
to the room.<a href="#section-3.5.1-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-state-events">
<section id="section-3.5.2">
          <h4 id="name-state-events">
<a href="#section-3.5.2" class="section-number selfRef">3.5.2. </a><a href="#name-state-events" class="section-name selfRef">State Events</a>
          </h4>
<p id="section-3.5.2-1">State events track metadata for the room, such as name, topic, and members. State is keyed by a
tuple of <code>type</code> and <code>state_key</code>. The state "at" an event is the set of state events which have
the most recent (in terms of event ordering, not timestamp) state tuple.<a href="#section-3.5.2-1" class="pilcrow">¶</a></p>
<p id="section-3.5.2-2">For example, consider the following (simplified) room history:<a href="#section-3.5.2-2" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-3.5.2-3">
<pre>
[
   /* in all events, irrelevant fields are not shown for brevity */

   /* 0 */ {
      "type": "m.room.create", "state_key": ""
   },

   /* 1 */ {
      "type": "m.room.member", "state_key": "@alice:example.org"
   },

   /* 2 */ {
      "type": "m.room.encrypted"
   },

   /* 3 */ {
      "type": "m.room.member", "state_key": "@bob:example.org"
   },

   /* 4 */ {
      "type": "m.room.member", "state_key": "@alice:example.org"
   }
]
</pre><a href="#section-3.5.2-3" class="pilcrow">¶</a>
</div>
<p id="section-3.5.2-4">The state at index 2 consists of Alice's <code>m.room.member</code> event (<a href="#int-ev-member" class="auto internal xref">Section 3.5.3.3</a>) and the <code>m.room.create</code>
event (<a href="#int-ev-create" class="auto internal xref">Section 3.5.3.1</a>) from the room. The <code>m.room.encrypted</code> event itself is not a state event
and therefore does not get appended to the state "at" any particular event.<a href="#section-3.5.2-4" class="pilcrow">¶</a></p>
<p id="section-3.5.2-5">The state at index 4 would have Alice's new <code>m.room.member</code> event, Bob's <code>m.room.member</code> event, and the
<code>m.room.create</code> event from before. Alice's old membership event is overridden due to having the same
<code>type</code> and <code>state_key</code> as the previous event. Note however that the state at index 3 still contains
the older membership event, as the new event happens later with respect to event ordering.<a href="#section-3.5.2-5" class="pilcrow">¶</a></p>
<p id="section-3.5.2-6">"Current state" is the state at the most recent event in the room. Calculating the state at a given
event is needed for the authorization rules (<a href="#int-auth-rules" class="auto internal xref">Section 5.2</a>) and event visibility (<a href="#int-calc-event-visibility" class="auto internal xref">Section 3.5.3.5.1</a>)
algorithms. Clients additionally need to know current state to show accurate room names, topics,
avatars, etc.<a href="#section-3.5.2-6" class="pilcrow">¶</a></p>
<div id="int-stripped-state">
<section id="section-3.5.2.1">
            <h5 id="name-stripped-state">
<a href="#section-3.5.2.1" class="section-number selfRef">3.5.2.1. </a><a href="#name-stripped-state" class="section-name selfRef">Stripped State</a>
            </h5>
<p id="section-3.5.2.1-1">Stripped state events are extremely simplified state events to provide context to a user for an invite
(<a href="#int-transport-invites" class="auto internal xref">Section 12.7.2</a>) or knock (<a href="#int-transport-knocks" class="auto internal xref">Section 12.7.4</a>). Servers and clients have no ability
to verify the events outside of the context for a room, so all such fields are removed. Servers and
clients <span class="bcp14">MUST NOT</span> rely on the events being accurate because they cannot independently verify them.<a href="#section-3.5.2.1-1" class="pilcrow">¶</a></p>
<p id="section-3.5.2.1-2">When generating stripped state for an invite or knock, the following events <span class="bcp14">SHOULD</span> be included
if present in the current room state itself:<a href="#section-3.5.2.1-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.5.2.1-3.1">
                <p id="section-3.5.2.1-3.1.1"><code>m.room.create</code> (<a href="#int-ev-create" class="auto internal xref">Section 3.5.3.1</a>)<a href="#section-3.5.2.1-3.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-3.5.2.1-3.2">
                <p id="section-3.5.2.1-3.2.1"><code>m.room.name</code> (<strong>TODO</strong>: Link)<a href="#section-3.5.2.1-3.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-3.5.2.1-3.3">
                <p id="section-3.5.2.1-3.3.1"><code>m.room.avatar</code> (<strong>TODO</strong>: Link)<a href="#section-3.5.2.1-3.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-3.5.2.1-3.4">
                <p id="section-3.5.2.1-3.4.1"><code>m.room.topic</code> (<strong>TODO</strong>: Link)<a href="#section-3.5.2.1-3.4.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-3.5.2.1-3.5">
                <p id="section-3.5.2.1-3.5.1"><code>m.room.join_rules</code> (<a href="#int-ev-join-rules" class="auto internal xref">Section 3.5.3.2</a>)<a href="#section-3.5.2.1-3.5.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-3.5.2.1-3.6">
                <p id="section-3.5.2.1-3.6.1"><code>m.room.canonical_alias</code> (<strong>TODO</strong>: Link)<a href="#section-3.5.2.1-3.6.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-3.5.2.1-4">Servers <span class="bcp14">MAY</span> include other event types/state keys. The above set gives users enough context to determine
if they'd like to knock/join the room, as features such as the name and avatar are generally key pieces
of information for a user.<a href="#section-3.5.2.1-4" class="pilcrow">¶</a></p>
<p id="section-3.5.2.1-5">Stripped state events <span class="bcp14">MUST</span> only have <code>sender</code>, <code>type</code>, <code>state_key</code>, and <code>content</code> from the event
schema (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>).<a href="#section-3.5.2.1-5" class="pilcrow">¶</a></p>
<p id="section-3.5.2.1-6">Example:<a href="#section-3.5.2.1-6" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-3.5.2.1-7">
<pre>
{
   "type": "m.room.create",
   "sender": "@alice:example.org",
   "state_key": "",
   "content": {
      "room_version": "I.1"
   }
}
</pre><a href="#section-3.5.2.1-7" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
<div id="event-types">
<section id="section-3.5.3">
          <h4 id="name-event-types">
<a href="#section-3.5.3" class="section-number selfRef">3.5.3. </a><a href="#name-event-types" class="section-name selfRef">Event Types</a>
          </h4>
<p id="section-3.5.3-1">Linearized Matrix defines the following event types. The section headers are the event <code>type</code>.<a href="#section-3.5.3-1" class="pilcrow">¶</a></p>
<div id="int-ev-create">
<section id="section-3.5.3.1">
            <h5 id="name-mroomcreate">
<a href="#section-3.5.3.1" class="section-number selfRef">3.5.3.1. </a><a href="#name-mroomcreate" class="section-name selfRef"><code>m.room.create</code></a>
            </h5>
<p id="section-3.5.3.1-1">The very first event in the room. It <span class="bcp14">MUST NOT</span> have any <code>auth_events</code> or <code>prev_events</code>, and the
domain of the <code>sender</code> <span class="bcp14">MUST</span> be the same as the domain in the <code>room_id</code>. The <code>state_key</code> <span class="bcp14">MUST</span>
be an empty string.<a href="#section-3.5.3.1-1" class="pilcrow">¶</a></p>
<p id="section-3.5.3.1-2">The <code>content</code> for a create event <span class="bcp14">MUST</span> have at least a <code>room_version</code> field to denote what set
of algorithms the room is using.<a href="#section-3.5.3.1-2" class="pilcrow">¶</a></p>
<p id="section-3.5.3.1-3">These conditions are checked as part of the event authorization rules (<a href="#int-auth-rules" class="auto internal xref">Section 5.2</a>).<a href="#section-3.5.3.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-ev-join-rules">
<section id="section-3.5.3.2">
            <h5 id="name-mroomjoin_rules">
<a href="#section-3.5.3.2" class="section-number selfRef">3.5.3.2. </a><a href="#name-mroomjoin_rules" class="section-name selfRef"><code>m.room.join_rules</code></a>
            </h5>
<p id="section-3.5.3.2-1">Defines whether users can join without an invite and other similar conditions. The <code>state_key</code>
              <span class="bcp14">MUST</span> be an empty string. Any other state key, including lack thereof, serve no meaning and
are treated as though they were a custom event.<a href="#section-3.5.3.2-1" class="pilcrow">¶</a></p>
<p id="section-3.5.3.2-2">The <code>content</code> for a join rules event <span class="bcp14">MUST</span> have at least a <code>join_rule</code> field to denote the
join policy for the room. Allowable values are:<a href="#section-3.5.3.2-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.5.3.2-3.1">
                <p id="section-3.5.3.2-3.1.1"><code>public</code> - anyone can join without an invite.<a href="#section-3.5.3.2-3.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-3.5.3.2-3.2">
                <p id="section-3.5.3.2-3.2.1"><code>knock</code> - users must receive an invite to join, and can request an invite (knock) too.<a href="#section-3.5.3.2-3.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-3.5.3.2-3.3">
                <p id="section-3.5.3.2-3.3.1"><code>invite</code> - users must receive an invite to join.<a href="#section-3.5.3.2-3.3.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-3.5.3.2-4"><strong>TODO</strong>: Describe <code>restricted</code> (and <code>knock_restricted</code>) rooms?<a href="#section-3.5.3.2-4" class="pilcrow">¶</a></p>
<p id="section-3.5.3.2-5"><strong>TODO</strong>: What's the default?<a href="#section-3.5.3.2-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-ev-member">
<section id="section-3.5.3.3">
            <h5 id="name-mroommember">
<a href="#section-3.5.3.3" class="section-number selfRef">3.5.3.3. </a><a href="#name-mroommember" class="section-name selfRef"><code>m.room.member</code></a>
            </h5>
<p id="section-3.5.3.3-1">Defines the membership for a user in the room. If the user does not have a membership event then
they are presumed to be in the <code>leave</code> state.<a href="#section-3.5.3.3-1" class="pilcrow">¶</a></p>
<p id="section-3.5.3.3-2">The <code>state_key</code> <span class="bcp14">MUST</span> be a non-empty string denotating the user ID the membership is affecting.<a href="#section-3.5.3.3-2" class="pilcrow">¶</a></p>
<p id="section-3.5.3.3-3">The <code>content</code> for a membership event <span class="bcp14">MUST</span> have at least a <code>membership</code> field to denote the
membership state for the user. Allowable values are:<a href="#section-3.5.3.3-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.5.3.3-4.1">
                <p id="section-3.5.3.3-4.1.1"><code>leave</code> - not participating in the room. If the <code>state_key</code> and <code>sender</code> do not match, this was
a kick rather than voluntary leave.<a href="#section-3.5.3.3-4.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-3.5.3.3-4.2">
                <p id="section-3.5.3.3-4.2.1"><code>join</code> - participating in the room.<a href="#section-3.5.3.3-4.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-3.5.3.3-4.3">
                <p id="section-3.5.3.3-4.3.1"><code>knock</code> - requesting an invite to the room.<a href="#section-3.5.3.3-4.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-3.5.3.3-4.4">
                <p id="section-3.5.3.3-4.4.1"><code>invite</code> - invited to participate in the room.<a href="#section-3.5.3.3-4.4.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-3.5.3.3-4.5">
                <p id="section-3.5.3.3-4.5.1"><code>ban</code> - implies kicked/not participating. Cannot be invited or join the room without being
unbanned first (moderator sends a kick, essentially).<a href="#section-3.5.3.3-4.5.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-3.5.3.3-5">These conditions are checked as part of the event authorization rules (<a href="#int-auth-rules" class="auto internal xref">Section 5.2</a>),
as are the rules for moving between membership states.<a href="#section-3.5.3.3-5" class="pilcrow">¶</a></p>
<p id="section-3.5.3.3-6">The <code>content</code> for a membership event <span class="bcp14">MAY</span> additionally have a <code>reason</code> field containing a human-readable
(and usually human-supplied) description for why the membership change happened. For example, the reason
why a user was kicked/banned or why they are requesting an invite by knocking.<a href="#section-3.5.3.3-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-ev-power-levels">
<section id="section-3.5.3.4">
            <h5 id="name-mroompower_levels">
<a href="#section-3.5.3.4" class="section-number selfRef">3.5.3.4. </a><a href="#name-mroompower_levels" class="section-name selfRef"><code>m.room.power_levels</code></a>
            </h5>
<p id="section-3.5.3.4-1">Defines what given users can and can't do, as well as which event types they are able to send.
The enforcement of these power levels is determined by the event authorization rules (<a href="#int-auth-rules" class="auto internal xref">Section 5.2</a>).<a href="#section-3.5.3.4-1" class="pilcrow">¶</a></p>
<p id="section-3.5.3.4-2">The <code>state_key</code> <span class="bcp14">MUST</span> be an empty string.<a href="#section-3.5.3.4-2" class="pilcrow">¶</a></p>
<p id="section-3.5.3.4-3">The <code>content</code> for a power levels event <span class="bcp14">SHOULD</span> have at least the following:<a href="#section-3.5.3.4-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.5.3.4-4.1">
                <p id="section-3.5.3.4-4.1.1"><code>ban</code> (integer) - the level required to ban a user. Defaults to <code>50</code> if unspecified.<a href="#section-3.5.3.4-4.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-3.5.3.4-4.2">
                <p id="section-3.5.3.4-4.2.1"><code>kick</code> (integer) - the level required to kick a user. Defaults to <code>50</code> if unspecified.<a href="#section-3.5.3.4-4.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-3.5.3.4-4.3">
                <p id="section-3.5.3.4-4.3.1"><code>invite</code> (integer) - the level required to invite a user. Defaults to <code>0</code> if unspecified.<a href="#section-3.5.3.4-4.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-3.5.3.4-4.4">
                <p id="section-3.5.3.4-4.4.1"><code>redact</code> (integer) - the level required to redact an event sent by another user. Defaults
to <code>50</code> if unspecified.<a href="#section-3.5.3.4-4.4.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-3.5.3.4-4.5">
                <p id="section-3.5.3.4-4.5.1"><code>events</code> (map) - keyed by event type string, the level required to send that event type to
the room. Defaults to an empty map if unspecified.<a href="#section-3.5.3.4-4.5.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-3.5.3.4-4.6">
                <p id="section-3.5.3.4-4.6.1"><code>events_default</code> (integer) - the level required to send events in the room. Overridden by
the <code>events</code> map. Defaults to <code>0</code> if unspecified.<a href="#section-3.5.3.4-4.6.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-3.5.3.4-4.7">
                <p id="section-3.5.3.4-4.7.1"><code>state_default</code> (integer) - the level required to send state events in the room. Overridden
by the <code>events</code> map. Defaults to <code>50</code> if unspecified.<a href="#section-3.5.3.4-4.7.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-3.5.3.4-4.8">
                <p id="section-3.5.3.4-4.8.1"><code>users</code> (map) - keyed by user ID, the level of that user. Defaults to an empty map if
unspecified.<a href="#section-3.5.3.4-4.8.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-3.5.3.4-4.9">
                <p id="section-3.5.3.4-4.9.1"><code>users_default</code> (integer) - the level for users. Overridden by the <code>users</code> map. Defaults to
<code>0</code> if unspecified.<a href="#section-3.5.3.4-4.9.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-3.5.3.4-5"><strong>TODO</strong>: Include notifications for at-room here too?<a href="#section-3.5.3.4-5" class="pilcrow">¶</a></p>
<p id="section-3.5.3.4-6">Note that if no power levels event is specified in the room then the room creator (<code>sender</code> of
the <code>m.room.create</code> state event) has a default power level of 100.<a href="#section-3.5.3.4-6" class="pilcrow">¶</a></p>
<p id="section-3.5.3.4-7">These conditions are checked as part of the event authorization rules (<a href="#int-auth-rules" class="auto internal xref">Section 5.2</a>).<a href="#section-3.5.3.4-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="mroomhistoryvisibility">
<section id="section-3.5.3.5">
            <h5 id="name-mroomhistory_visibility">
<a href="#section-3.5.3.5" class="section-number selfRef">3.5.3.5. </a><a href="#name-mroomhistory_visibility" class="section-name selfRef"><code>m.room.history_visibility</code></a>
            </h5>
<p id="section-3.5.3.5-1"><strong>TODO</strong>: Describe.<a href="#section-3.5.3.5-1" class="pilcrow">¶</a></p>
<div id="int-calc-event-visibility">
<section id="section-3.5.3.5.1">
              <h6 id="name-calculating-event-visibilit">
<a href="#section-3.5.3.5.1" class="section-number selfRef">3.5.3.5.1. </a><a href="#name-calculating-event-visibilit" class="section-name selfRef">Calculating Event Visibility</a>
              </h6>
<p id="section-3.5.3.5.1-1"><strong>TODO</strong>: Describe. (when can a server see an event?). Mention that <code>m.mls.commit</code> is exempt.<a href="#section-3.5.3.5.1-1" class="pilcrow">¶</a></p>
<p id="section-3.5.3.5.1-2"><strong>TODO</strong>: This section feels like it's in the wrong place. Bring it closer to on-receive-event sections.<a href="#section-3.5.3.5.1-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="todo-other-events">
<section id="section-3.5.3.6">
            <h5 id="name-todo-other-events">
<a href="#section-3.5.3.6" class="section-number selfRef">3.5.3.6. </a><a href="#name-todo-other-events" class="section-name selfRef">TODO: Other events</a>
            </h5>
<p id="section-3.5.3.6-1"><strong>TODO</strong>: <code>m.room.name</code>, <code>m.room.topic</code>, <code>m.room.avatar</code>, <code>m.room.canonical_alias</code><a href="#section-3.5.3.6-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="int-mls-considerations">
<section id="section-4">
      <h2 id="name-mls-considerations">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-mls-considerations" class="section-name selfRef">MLS Considerations</a>
      </h2>
<p id="section-4-1"><strong>TODO</strong>: We should consider running <span>[<a href="#I-D.robert-mimi-delivery-service" class="cite xref">I-D.robert-mimi-delivery-service</a>]</span> over LM instead.
Using something like <span>[<a href="#I-D.mahy-mimi-group-chat" class="cite xref">I-D.mahy-mimi-group-chat</a>]</span> would be good for more of a client-side
representation of the LM room model.<a href="#section-4-1" class="pilcrow">¶</a></p>
<p id="section-4-2">The MIMI working group is chartered to use Messaging Layer Security (MLS) <span>[<a href="#I-D.ietf-mls-protocol" class="cite xref">I-D.ietf-mls-protocol</a>]</span>
        <span>[<a href="#I-D.ietf-mls-architecture" class="cite xref">I-D.ietf-mls-architecture</a>]</span> for encryption in chats, and this document specifies no different.
Each room has a single MLS Group associated with it, both identified by the room ID (<a href="#int-room-id" class="auto internal xref">Section 3.2</a>).<a href="#section-4-2" class="pilcrow">¶</a></p>
<p id="section-4-3">Rooms additionally track membership at a per-user level while MLS tracks group membership at a
per-device level. With this consideration, commits to the MLS Group <span class="bcp14">MUST</span> use <code>PublicMessage</code>, giving
the hub server an ability to inspect MLS group membership changes for illegal joins and leaves.<a href="#section-4-3" class="pilcrow">¶</a></p>
<p id="section-4-4">Encryption can only be enabled at the time the room is created. This prevents the room having encryption
disabled or downgraded without an entirely new room being created. The exact ciphersuite and other
algorithmic details are contained in the <code>content</code> for the <code>m.room.create</code> event (<a href="#int-ev-create" class="auto internal xref">Section 3.5.3.1</a>):<a href="#section-4-4" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-4-5">
<pre>
{
   "encryption": {
      "algorithm": "m.mls.v1.dhkemx25519-aes128gcm-sha256-ed25519"
   }
}
</pre><a href="#section-4-5" class="pilcrow">¶</a>
</div>
<p id="section-4-6"><code>algorithm</code> denotes which specific algorithm clients <span class="bcp14">MUST</span> use for sending and receiving encrypted
events in the room. If a received event is encrypted using a different algorithm, it <span class="bcp14">MUST</span> be treated
as undecryptable (even if the client has sufficient key information to decrypt it).<a href="#section-4-6" class="pilcrow">¶</a></p>
<p id="section-4-7"><code>m.mls.v1.</code> as a prefix describes the behaviour for encrypted clients, with the remainder of the
algorithm string covering the exact ciphersuite. This document uses the same mandatory ciphersuite
as MLS: <code>MLS_128_DHKEMX25519_AES128GCM_SHA256_Ed25519</code>. Thus, this is encoded as
<code>m.mls.v1.dhkemx25519-aes128gcm-sha256-ed25519</code>. Other ciphersuites can be represented similarly,
though are considered to be entirely new encryption algorithms for the purposes of this document.<a href="#section-4-7" class="pilcrow">¶</a></p>
<p id="section-4-8">Custom or non-standard encryption algorithms are possible with this approach, however out of scope
for MIMI. If such an algorithm is used, it <span class="bcp14">SHOULD</span> be prefixed using reverse domain name notation.
For example, <code>org.example.my-encryption</code>.<a href="#section-4-8" class="pilcrow">¶</a></p>
<p id="section-4-9">Mentioned in the introduction (<a href="#int-intro" class="auto internal xref">Section 1</a>), this document does not explore the details for what is
needed to interconnect Linearized Matrix and Matrix's existing room model. However, for interconnection
to be successful, extensions to MLS are needed to support decentralization. One possible extension
is "Decentralised MLS" <span>[<a href="#DMLS" class="cite xref">DMLS</a>]</span>.<a href="#section-4-9" class="pilcrow">¶</a></p>
<div id="int-mls-credentials">
<section id="section-4.1">
        <h3 id="name-device-credentials">
<a href="#section-4.1" class="section-number selfRef">4.1. </a><a href="#name-device-credentials" class="section-name selfRef">Device Credentials</a>
        </h3>
<p id="section-4.1-1">Under Section 5.3 of <span>[<a href="#I-D.ietf-mls-protocol" class="cite xref">I-D.ietf-mls-protocol</a>]</span>, each MLS group member (a device, <a href="#int-device-id" class="auto internal xref">Section 3.4</a>)
has a "credential" or signing key associated with it. These are published to each client's local server
and available over federation (<a href="#int-transport-mls" class="auto internal xref">Section 12.10</a>).<a href="#section-4.1-1" class="pilcrow">¶</a></p>
<p id="section-4.1-2">This document relies upon out-of-band verification and therefore uses basic credentials. The format
for the credential is:<a href="#section-4.1-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4.1-3">
<pre>
struct {
    opaque user_id&lt;V&gt;;
    opaque device_id&lt;V&gt;;
    opaque signature_key&lt;V&gt;;
} BasicCredential;
</pre><a href="#section-4.1-3" class="pilcrow">¶</a>
</div>
<p id="section-4.1-4"><code>user_id</code> is as described by <a href="#int-user-id" class="auto internal xref">Section 3.3</a>, and <code>device_id</code> is as described by <a href="#int-device-id" class="auto internal xref">Section 3.4</a>.
<code>signature_key</code> is from MLS.<a href="#section-4.1-4" class="pilcrow">¶</a></p>
<p id="section-4.1-5">The device then constructs the following object, signs it using each of the listed <code>keys</code>, and publishes
it through its local server (<a href="#int-transport-devices" class="auto internal xref">Section 12.10.1</a>):<a href="#section-4.1-5" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-4.1-6">
<pre>
{
   "device_id": "ABCDEF",
   "user_id": "@alice:example.org",
   "algorithms": [
      "m.mls.v1.dhkemx25519-aes128gcm-sha256-ed25519"
   ],
   "keys": {
      "m.mls.v1.credential.ed25519:ABCDEF":
         "&lt;unpadded base64 BasicCredential&gt;"
   },
   "signatures": {
      "@alice:example.org": {
         "m.mls.v1.credential.ed25519:ABCDEF":
            "&lt;unpadded base64 signature&gt;"
      }
   }
}
</pre><a href="#section-4.1-6" class="pilcrow">¶</a>
</div>
<p id="section-4.1-7"><code>device_id</code> is the client's device ID (<a href="#int-device-id" class="auto internal xref">Section 3.4</a>). <code>user_id</code> is the user ID (<a href="#int-user-id" class="auto internal xref">Section 3.3</a>)
to which the device ID belongs. <code>algorithms</code> are the encryption algorithms the device supports, and
<span class="bcp14">SHOULD</span> contain at least <code>m.mls.v1.dhkemx25519-aes128gcm-sha256-ed25519</code>.<a href="#section-4.1-7" class="pilcrow">¶</a></p>
<p id="section-4.1-8">When a device supports <code>m.mls.v1.dhkemx25519-aes128gcm-sha256-ed25519</code>, it <span class="bcp14">MUST</span> specify its basic
credential with the <code>m.mls.v1.credential.ed25519</code> key algorithm.<a href="#section-4.1-8" class="pilcrow">¶</a></p>
<p id="section-4.1-9"><code>keys</code> is an object containing each algorithm-specific key (or keys) for the device. The fields for
the object form a key ID, with the device ID representing the "key version", as per <a href="#int-signing" class="auto internal xref">Section 6</a>.<a href="#section-4.1-9" class="pilcrow">¶</a></p>
<p id="section-4.1-10">All top-level fields in the object above <span class="bcp14">MUST</span> be supplied.<a href="#section-4.1-10" class="pilcrow">¶</a></p>
<p id="section-4.1-11">For each of the device's <code>keys</code>, a valid signature <span class="bcp14">MUST</span> be produced. If there is a missing signature
from any of the keys, or from the <code>user_id</code>, the device information is considered invalid. Invalid
devices <span class="bcp14">MUST NOT</span> be members of the MLS group, and are removed if already members prior to the device
information becoming invalid.<a href="#section-4.1-11" class="pilcrow">¶</a></p>
</section>
</div>
<div id="group-creation">
<section id="section-4.2">
        <h3 id="name-group-creation">
<a href="#section-4.2" class="section-number selfRef">4.2. </a><a href="#name-group-creation" class="section-name selfRef">Group Creation</a>
        </h3>
<p id="section-4.2-1">After the <code>m.room.create</code> event and other initial state events for the room are sent, the room creator
<span class="bcp14">MUST</span> establish the appropriate MLS group. This is sent as an <code>m.mls.commit</code> event (<a href="#int-ev-mls-commit" class="auto internal xref">Section 4.5.1</a>).
Afterwards, the remaining devices are added as normal (<a href="#int-mls-add-remove" class="auto internal xref">Section 4.3</a>).<a href="#section-4.2-1" class="pilcrow">¶</a></p>
<p id="section-4.2-2">Ideally, the <code>m.room.create</code> event would also contain the initial public group state, however doing
so would mean either tracking an independent MLS group ID or allowing the client to specify the room
ID. While servers <span class="bcp14">MAY</span> allow the client to specify the room ID, servers usually have better context
for which localparts (see <a href="#int-room-id" class="auto internal xref">Section 3.2</a>) are already claimed by other rooms. Having independent
group IDs and room IDs can lead to confusion and a similar sort of namespacing issue (a room creator
can create a conflicting group ID). Instead, the server (usually) creates the room on behalf of the
client, allowing the client to then send the initial public group state to the room for other MLS
members.<a href="#section-4.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-mls-add-remove">
<section id="section-4.3">
        <h3 id="name-updating-group-state">
<a href="#section-4.3" class="section-number selfRef">4.3. </a><a href="#name-updating-group-state" class="section-name selfRef">Updating Group State</a>
        </h3>
<p id="section-4.3-1">This document does not provide a way to send proposals to the MLS group, meaning all commits <span class="bcp14">MUST</span> only
contain proposals which are sent by the same member (see <span><a href="https://datatracker.ietf.org/doc/html/draft-ietf-mls-protocol-20#section-12" class="relref">Section 12</a> of [<a href="#I-D.ietf-mls-protocol" class="cite xref">I-D.ietf-mls-protocol</a>]</span>).<a href="#section-4.3-1" class="pilcrow">¶</a></p>
<p id="section-4.3-2">All commits are encoded as <code>m.mls.commit</code> events (<a href="#int-ev-mls-commit" class="auto internal xref">Section 4.5.1</a>) and are sent to the room.
These commits are additionally encoded using <code>PublicMessage</code>, giving servers visibility on the contents
of the commits. Upon receiving the event (see <a href="#int-receiving-events" class="auto internal xref">Section 5.1</a>), the hub server <span class="bcp14">MUST</span> additionally
validate that any membership changes match what is possible with the room membership:<a href="#section-4.3-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.3-3.1">
            <p id="section-4.3-3.1.1">Devices can only be added to the group if they belong to a user which is joined to the room, or if the
room is "world readable" (<a href="#int-calc-event-visibility" class="auto internal xref">Section 3.5.3.5.1</a>). It is generally not enough to be invited,
knocking, etc on the room - the user ID must usually be in the <code>join</code> state.<a href="#section-4.3-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-4.3-3.2">
            <p id="section-4.3-3.2.1">Devices can be removed in two ways:<a href="#section-4.3-3.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.3-3.2.2.1">
                <p id="section-4.3-3.2.2.1.1">A device can remove another device if they both belong to the same user ID.<a href="#section-4.3-3.2.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.3-3.2.2.2">
                <p id="section-4.3-3.2.2.2.1">A device can be removed by anyone if the user ID to which it belongs is no longer in the <code>join</code> state.
This condition is required to satisfy a case in MLS where a device cannot self-remove itself from
the group.<a href="#section-4.3-3.2.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
        </ul>
<p id="section-4.3-4">If this validation fails, the hub server <span class="bcp14">MUST</span> reject the request if it's shaped as an LPDU (<a href="#int-lpdu" class="auto internal xref">Section 3.5.1</a>)
and soft-fail the event if it's a PDU (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>).<a href="#section-4.3-4" class="pilcrow">¶</a></p>
<p id="section-4.3-5">Welcome messages are sent to devices over to-device messaging (<a href="#int-transport-to-device" class="auto internal xref">Section 12.10.2</a>). The <code>message_type</code>
for the message is <code>m.room.encrypted</code> [<strong>TODO</strong>: Rename to avoid confusion with room event?] and <code>message</code>
of:<a href="#section-4.3-5" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-4.3-6">
<pre>
{
   "algorithm": "m.mls.v1.welcome.[ciphersuite]",
   "ciphertext": "&lt;unpadded base64 encoded welcome message&gt;",
   "commit_event_id": "&lt;event ID of the m.mls.commit event&gt;"
}
</pre><a href="#section-4.3-6" class="pilcrow">¶</a>
</div>
<p id="section-4.3-7"><code>algorithm</code> is the ciphersuite, <code>dhkemx25519-aes128gcm-sha256-ed25519</code>, prefixed with <code>m.mls.v1.welcome</code>.<a href="#section-4.3-7" class="pilcrow">¶</a></p>
<p id="section-4.3-8">The remaining fields are as described in the example. See <a href="#int-unpadded-base64" class="auto internal xref">Section 10</a> for "unpadded base64".<a href="#section-4.3-8" class="pilcrow">¶</a></p>
<p id="section-4.3-9">All fields <span class="bcp14">MUST</span> be supplied. Note that the sender's user ID and device ID are made available over the
to-device messaging endpoints (<a href="#int-transport-to-device" class="auto internal xref">Section 12.10.2</a>).<a href="#section-4.3-9" class="pilcrow">¶</a></p>
<p id="section-4.3-10">In all cases, a device remembers the event ID (either from the <code>m.mls.commit</code> event or <code>commit_event_id</code>
from a to-device message) after decryption to associate it with the MLS epoch. The device can then do
a reverse lookup of epoch to event ID to MLS group state. Note that a client <em>always</em> has access to
<code>m.mls.commit</code> events, even when hidden by history visibility (<a href="#int-calc-event-visibility" class="auto internal xref">Section 3.5.3.5.1</a>).<a href="#section-4.3-10" class="pilcrow">¶</a></p>
<p id="section-4.3-11"><strong>TODO</strong>: Is it correct to say all commits are visible as "shared"?<a href="#section-4.3-11" class="pilcrow">¶</a></p>
<p id="section-4.3-12"><strong>TODO</strong>: We may need to store the group state in the media repo if it gets to be too big, or otherwise
allow oversized events.<a href="#section-4.3-12" class="pilcrow">¶</a></p>
<p id="section-4.3-13"><strong>TODO</strong>: The server also likely needs to prevent devices being added to the group which don't support
the ciphersuite/algorithm.<a href="#section-4.3-13" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-mls-key-packages">
<section id="section-4.4">
        <h3 id="name-key-packages">
<a href="#section-4.4" class="section-number selfRef">4.4. </a><a href="#name-key-packages" class="section-name selfRef">Key Packages</a>
        </h3>
<p id="section-4.4-1">Clients "claim" another device's key package through their server (<a href="#int-transport-key-claim" class="auto internal xref">Section 12.10.3</a>). Clients
will typically generate several key packages and upload them to their server, making them available even
if the client goes offline.<a href="#section-4.4-1" class="pilcrow">¶</a></p>
<p id="section-4.4-2">The algorithm for a key package is <code>m.mls.v1.key_package.dhkemx25519-aes128gcm-sha256-ed25519</code> and is
combined with a device-generated key version, forming a key ID described by <a href="#int-signing" class="auto internal xref">Section 6</a>. The key
version <span class="bcp14">SHOULD</span> be generated based upon the key package itself rather than using an unrelated string,
such as a hash or the public key of the key package.<a href="#section-4.4-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="room-event-types">
<section id="section-4.5">
        <h3 id="name-room-event-types">
<a href="#section-4.5" class="section-number selfRef">4.5. </a><a href="#name-room-event-types" class="section-name selfRef">Room Event Types</a>
        </h3>
<p id="section-4.5-1"><strong>TODO</strong>: Should these be defined with the other event types rather than here?<a href="#section-4.5-1" class="pilcrow">¶</a></p>
<p id="section-4.5-2">This document describes the following event types for use with MLS-encrypted rooms. The section headers
are the event <code>type</code>. See <a href="#int-pdu" class="auto internal xref">Section 3.5</a> for more information on events.<a href="#section-4.5-2" class="pilcrow">¶</a></p>
<p id="section-4.5-3">These event types are non-state events, also called "room events".<a href="#section-4.5-3" class="pilcrow">¶</a></p>
<div id="int-ev-mls-commit">
<section id="section-4.5.1">
          <h4 id="name-mmlscommit">
<a href="#section-4.5.1" class="section-number selfRef">4.5.1. </a><a href="#name-mmlscommit" class="section-name selfRef"><code>m.mls.commit</code></a>
          </h4>
<p id="section-4.5.1-1">Represents an MLS commit, which may be rejected by the hub server.<a href="#section-4.5.1-1" class="pilcrow">¶</a></p>
<p id="section-4.5.1-2"><code>content</code> for the event <span class="bcp14">MUST</span> contain at least the following example:<a href="#section-4.5.1-2" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-4.5.1-3">
<pre>
{
   "message": "&lt;unpadded base64 encoded PublicMessage&gt;",
   "public_group_state": "&lt;unpadded base64 encoded public group state&gt;"
}
</pre><a href="#section-4.5.1-3" class="pilcrow">¶</a>
</div>
<p id="section-4.5.1-4">As mentioned, <code>message</code> is a <code>PublicMessage</code> from MLS. <code>public_group_state</code> is to enable external
joins.<a href="#section-4.5.1-4" class="pilcrow">¶</a></p>
<p id="section-4.5.1-5">An optional field, <code>prev_commit_event_id</code>, <span class="bcp14">SHOULD</span> be specified when a parent commit exists. This is
to enable clients to find the commit they have keys for upon joining the room, as the most recent one
may not be decryptable to them. The client can then work forwards from where they can decrypt the
message.<a href="#section-4.5.1-5" class="pilcrow">¶</a></p>
<p id="section-4.5.1-6"><strong>TODO</strong>: Should we use the <code>RatchetTree</code> extension? It might make the group state massive...<a href="#section-4.5.1-6" class="pilcrow">¶</a></p>
<p id="section-4.5.1-7"><strong>TODO</strong>: Which fields from this need to be protected by <a href="#int-redactions" class="auto internal xref">Section 8</a>?<a href="#section-4.5.1-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-ev-encrypted">
<section id="section-4.5.2">
          <h4 id="name-mroomencrypted">
<a href="#section-4.5.2" class="section-number selfRef">4.5.2. </a><a href="#name-mroomencrypted" class="section-name selfRef"><code>m.room.encrypted</code></a>
          </h4>
<p id="section-4.5.2-1">Represents an encrypted MLS application message. The sender first encrypts the message per the content
format then <span class="bcp14">MUST</span> send an event with <code>content</code> matching:<a href="#section-4.5.2-1" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-4.5.2-2">
<pre>
{
   "algorithm": "m.mls.v1.[ciphersuite]",
   "ciphertext": "&lt;unpadded base64 encoded MLS ciphertext&gt;",
   "commit_event_id": "&lt;event ID of applicable m.mls.commit event&gt;"
}
</pre><a href="#section-4.5.2-2" class="pilcrow">¶</a>
</div>
<p id="section-4.5.2-3">Within this document, <code>algorithm</code> will be <code>m.mls.v1.dhkemx25519-aes128gcm-sha256-ed25519</code>. The other
fields are as described in the example.<a href="#section-4.5.2-3" class="pilcrow">¶</a></p>
<p id="section-4.5.2-4">Clients <span class="bcp14">SHOULD</span> treat <code>m.room.encrypted</code> events which are improperly structured as undecryptable events.<a href="#section-4.5.2-4" class="pilcrow">¶</a></p>
<p id="section-4.5.2-5"><strong>TODO</strong>: Which fields from this need to be protected by <a href="#int-redactions" class="auto internal xref">Section 8</a>?<a href="#section-4.5.2-5" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="processing-events">
<section id="section-5">
      <h2 id="name-processing-events">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-processing-events" class="section-name selfRef">Processing Events</a>
      </h2>
<p id="section-5-1">An event has several authenticity properties:<a href="#section-5-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5-2.1">
          <p id="section-5-2.1.1">Content hashes (<a href="#int-content-hashes" class="auto internal xref">Section 9.1</a>) to cover the LPDU (<a href="#int-lpdu" class="auto internal xref">Section 3.5.1</a>) and event (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>)
contents.<a href="#section-5-2.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-5-2.2">
          <p id="section-5-2.2.1">Reference hashes (<a href="#int-reference-hashes" class="auto internal xref">Section 9.2</a>) which double as the event ID, covering the
redacted event.<a href="#section-5-2.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-5-2.3">
          <p id="section-5-2.3.1">Signatures from the direct senders (server name of the <code>sender</code> and the <code>hub_server</code> if
present), ensuring the entities did actually produce that event.<a href="#section-5-2.3.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-5-3"><strong>TODO</strong>: Does the hub's signature actually guard anything?<a href="#section-5-3" class="pilcrow">¶</a></p>
<p id="section-5-4">These properties are validated throughout this document. Each property has different behaviour
when violated. For example, a difference in content hash ultimately causes the event to be
stored as a redacted copy.<a href="#section-5-4" class="pilcrow">¶</a></p>
<div id="int-receiving-events">
<section id="section-5.1">
        <h3 id="name-receiving-events-pdus">
<a href="#section-5.1" class="section-number selfRef">5.1. </a><a href="#name-receiving-events-pdus" class="section-name selfRef">Receiving Events/PDUs</a>
        </h3>
<p id="section-5.1-1"><strong>TODO</strong>: This section conflates sending and receiving a bit more than it should. Split sending
out to its own section.<a href="#section-5.1-1" class="pilcrow">¶</a></p>
<p id="section-5.1-2">When a hub receives an LPDU from a participant it <span class="bcp14">MUST</span> add the missing fields to create a fully
formed PDU then <span class="bcp14">MUST</span> send that PDU back out to all participants, including the original sender.<a href="#section-5.1-2" class="pilcrow">¶</a></p>
<p id="section-5.1-3">A server is considered to have "received" an event when it does not recognize the event ID. This
may be because the event has not yet been persisted, or the server is not persisting anything (in
the case of a participant server). This includes when the server asks another server for an event
it might be missing.<a href="#section-5.1-3" class="pilcrow">¶</a></p>
<p id="section-5.1-4">When a server (hub or participant) receives an event, it <span class="bcp14">MUST</span>:<a href="#section-5.1-4" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.1-5">
<li id="section-5.1-5.1">
            <p id="section-5.1-5.1.1">Verify the event matches the schema for the room version (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>), without considering
type-specific schemas applied to <code>content</code>. If an event fails to meet this requirement, it is
dropped/ignored.<a href="#section-5.1-5.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-5.1-5.2">
            <p id="section-5.1-5.2.1">Ensure the required signatures are present and that they are valid (<a href="#int-checking-signatures" class="auto internal xref">Section 6.3</a>).
If the event has a <code>hub_server</code> field, the event <span class="bcp14">MUST</span> be signed by that server. The event
<span class="bcp14">MUST</span> also be signed by the server implied by the <code>sender</code>, noting that this will be an LPDU
if <code>hub_server</code> is present. All other signatures <span class="bcp14">MUST NOT</span> be considered for signature
validation, regardless of their individual validity. If the event fails to meet this
requirement, it is dropped/ignored.<a href="#section-5.1-5.2.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-5.1-5.3">
            <p id="section-5.1-5.3.1">Ensure the event has a valid content hashes (<a href="#int-content-hashes" class="auto internal xref">Section 9.1</a>). If the event has a
<code>hub_server</code> field, it <span class="bcp14">MUST</span> have a content hash which covers the LPDU. If either the LPDU
or PDU content hash doesn't match what the receiving server calculations, the event is
redacted before further processing. The server will ultimately persist the redacted copy.<a href="#section-5.1-5.3.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-5.1-6">Additionally, a hub server <span class="bcp14">MUST</span> complete the following checks. Participant servers <span class="bcp14">SHOULD</span>
also perform the following checks to validate that the hub server is acting in a compliant
manner. If the hub is not acting appropriately (for example, by sending the participant an
event which never should have been accepted), the participant server <span class="bcp14">MAY</span> choose to warn its
local users that the room history may have been tampered with.<a href="#section-5.1-6" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.1-7">
<li id="section-5.1-7.1">
            <p id="section-5.1-7.1.1">The constraints described by <a href="#int-mls-add-remove" class="auto internal xref">Section 4.3</a> validated, if the room is encrypted.<a href="#section-5.1-7.1.1" class="pilcrow">¶</a></p>
</li>
        </ol>
</section>
</div>
<div id="int-auth-rules">
<section id="section-5.2">
        <h3 id="name-authorization-rules">
<a href="#section-5.2" class="section-number selfRef">5.2. </a><a href="#name-authorization-rules" class="section-name selfRef">Authorization Rules</a>
        </h3>
<p id="section-5.2-1">These are the rules which govern whether an event is accepted into the room, depending on
the state events surrounding that event. A given event is checked against multiple different
sets of state.<a href="#section-5.2-1" class="pilcrow">¶</a></p>
<div id="int-auth-selection">
<section id="section-5.2.1">
          <h4 id="name-auth-events-selection">
<a href="#section-5.2.1" class="section-number selfRef">5.2.1. </a><a href="#name-auth-events-selection" class="section-name selfRef">Auth Events Selection</a>
          </h4>
<p id="section-5.2.1-1">The <code>auth_events</code> on an event <span class="bcp14">MUST</span> consist of the following state events, with the exception
of an <code>m.room.create</code> event which has no <code>auth_events</code>.<a href="#section-5.2.1-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.1-2">
<li id="section-5.2.1-2.1">
              <p id="section-5.2.1-2.1.1">The <code>m.room.create</code> state event.<a href="#section-5.2.1-2.1.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-5.2.1-2.2">
              <p id="section-5.2.1-2.2.1">The current <code>m.room.power_levels</code> state event, if any.<a href="#section-5.2.1-2.2.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-5.2.1-2.3">
              <p id="section-5.2.1-2.3.1">The sender's current <code>m.room.member</code> state event, if any.<a href="#section-5.2.1-2.3.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-5.2.1-2.4">
              <p id="section-5.2.1-2.4.1">If the <code>type</code> is <code>m.room.member</code>:<a href="#section-5.2.1-2.4.1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.1-2.4.2">
<li id="section-5.2.1-2.4.2.1">
                  <p id="section-5.2.1-2.4.2.1.1">The target's (<code>state_key</code>) current <code>m.room.member</code> state event, if any.<a href="#section-5.2.1-2.4.2.1.1" class="pilcrow">¶</a></p>
</li>
                <li id="section-5.2.1-2.4.2.2">
                  <p id="section-5.2.1-2.4.2.2.1">If <code>content.membership</code> is <code>join</code> or <code>invite</code>, the current <code>m.room.join_rules</code> state
event, if any.<a href="#section-5.2.1-2.4.2.2.1" class="pilcrow">¶</a></p>
</li>
              </ol>
</li>
          </ol>
<p id="section-5.2.1-3"><strong>TODO</strong>: Talk about restricted room joins here?<a href="#section-5.2.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-calc-power-levels">
<section id="section-5.2.2">
          <h4 id="name-calculating-power-levels">
<a href="#section-5.2.2" class="section-number selfRef">5.2.2. </a><a href="#name-calculating-power-levels" class="section-name selfRef">Calculating Power Levels</a>
          </h4>
<p id="section-5.2.2-1">A requirement of the authorization rules is being able to determine the current/future "power level"
for a user. All power levels are calculated with reference to the <code>content</code> of an <code>m.room.power_levels</code>
state event (<a href="#int-ev-power-levels" class="auto internal xref">Section 3.5.3.4</a>).<a href="#section-5.2.2-1" class="pilcrow">¶</a></p>
<p id="section-5.2.2-2">To calculate a user's current power level:<a href="#section-5.2.2-2" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.2-3">
<li id="section-5.2.2-3.1">
              <p id="section-5.2.2-3.1.1">If <code>users</code> is present, use the power level for the user ID, if present.<a href="#section-5.2.2-3.1.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-5.2.2-3.2">
              <p id="section-5.2.2-3.2.1">If <code>users</code> is not present, or the user ID is not present in <code>users</code>, use <code>users_default</code>.<a href="#section-5.2.2-3.2.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-5.2.2-3.3">
              <p id="section-5.2.2-3.3.1">If <code>users_default</code> is not present, use <code>0</code>.<a href="#section-5.2.2-3.3.1" class="pilcrow">¶</a></p>
</li>
          </ol>
<p id="section-5.2.2-4">To calculate the required power level to do an action:<a href="#section-5.2.2-4" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.2-5">
<li id="section-5.2.2-5.1">
              <p id="section-5.2.2-5.1.1">If the action (<code>kick</code>, <code>ban</code>, <code>invite</code>, or <code>redact</code>) is present, use that power level.<a href="#section-5.2.2-5.1.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-5.2.2-5.2">
              <p id="section-5.2.2-5.2.1">If not present, use the default for the action (<code>50</code> for <code>kick</code>, <code>ban</code>, and <code>redact</code>, <code>0</code>
for <code>invite</code>).<a href="#section-5.2.2-5.2.1" class="pilcrow">¶</a></p>
</li>
          </ol>
<p id="section-5.2.2-6">To calculate the required power level to send an event:<a href="#section-5.2.2-6" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.2-7">
<li id="section-5.2.2-7.1">
              <p id="section-5.2.2-7.1.1">If <code>events</code> is present, use the power level for the event <code>type</code>, if present.<a href="#section-5.2.2-7.1.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-5.2.2-7.2">
              <p id="section-5.2.2-7.2.1">If <code>events</code> is not present, or the event <code>type</code> is not present in <code>events</code>:<a href="#section-5.2.2-7.2.1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.2-7.2.2">
<li id="section-5.2.2-7.2.2.1">
                  <p id="section-5.2.2-7.2.2.1.1">If <code>state_key</code> is present (including empty), use <code>state_default</code>.<a href="#section-5.2.2-7.2.2.1.1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.2-7.2.2.1.2">
<li id="section-5.2.2-7.2.2.1.2.1">
                      <p id="section-5.2.2-7.2.2.1.2.1.1">If <code>state_default</code> is not specified, use <code>50</code>.<a href="#section-5.2.2-7.2.2.1.2.1.1" class="pilcrow">¶</a></p>
</li>
                  </ol>
</li>
                <li id="section-5.2.2-7.2.2.2">
                  <p id="section-5.2.2-7.2.2.2.1">If <code>state_key</code> is not present, use <code>events_default</code>.<a href="#section-5.2.2-7.2.2.2.1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.2-7.2.2.2.2">
<li id="section-5.2.2-7.2.2.2.2.1">
                      <p id="section-5.2.2-7.2.2.2.2.1.1">If <code>events_default</code> is not specified, use <code>0</code>.<a href="#section-5.2.2-7.2.2.2.2.1.1" class="pilcrow">¶</a></p>
</li>
                  </ol>
</li>
              </ol>
</li>
          </ol>
</section>
</div>
<div id="auth-rules-algorithm">
<section id="section-5.2.3">
          <h4 id="name-auth-rules-algorithm">
<a href="#section-5.2.3" class="section-number selfRef">5.2.3. </a><a href="#name-auth-rules-algorithm" class="section-name selfRef">Auth Rules Algorithm</a>
          </h4>
<p id="section-5.2.3-1">With consideration for default/calculated power levels (<a href="#int-calc-power-levels" class="auto internal xref">Section 5.2.2</a>), each event <span class="bcp14">MUST</span>
pass the following rules. "Current state" (and "current membership", etc) are the state of the room
<em>before</em> the event being checked is applied.<a href="#section-5.2.3-1" class="pilcrow">¶</a></p>
<p id="section-5.2.3-2"><strong>TODO</strong>: should we reference <code>m.federate</code>?<a href="#section-5.2.3-2" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.3-3">
<li id="section-5.2.3-3.1">
              <p id="section-5.2.3-3.1.1">Events must be signed (<a href="#int-checking-signatures" class="auto internal xref">Section 6.3</a>) by the server denoted by the <code>sender</code>
field. Note that this may be an LPDU if the <code>hub_server</code> is specified and not the same server.
If the event is improperly signed, reject the event.<a href="#section-5.2.3-3.1.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-5.2.3-3.2">
              <p id="section-5.2.3-3.2.1">If <code>hub_server</code> is present on the event, the event must be signed (<a href="#int-checking-signatures" class="auto internal xref">Section 6.3</a>)
by that server. If it is improperly signed, reject the event.<a href="#section-5.2.3-3.2.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-5.2.3-3.3">
              <p id="section-5.2.3-3.3.1">If the event's <code>type</code> is <code>m.room.create</code>:<a href="#section-5.2.3-3.3.1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.3-3.3.2">
<li id="section-5.2.3-3.3.2.1">
                  <p id="section-5.2.3-3.3.2.1.1">If it has any <code>prev_events</code>, reject the event.<a href="#section-5.2.3-3.3.2.1.1" class="pilcrow">¶</a></p>
</li>
                <li id="section-5.2.3-3.3.2.2">
                  <p id="section-5.2.3-3.3.2.2.1">If the domain of the <code>room_id</code> is not the same domain as the <code>sender</code>, reject the event.<a href="#section-5.2.3-3.3.2.2.1" class="pilcrow">¶</a></p>
</li>
                <li id="section-5.2.3-3.3.2.3">
                  <p id="section-5.2.3-3.3.2.3.1">If <code>content.room_version</code> is not <code>I.1</code>, reject the event.<a href="#section-5.2.3-3.3.2.3.1" class="pilcrow">¶</a></p>
</li>
                <li id="section-5.2.3-3.3.2.4">
                  <p id="section-5.2.3-3.3.2.4.1">Otherwise, allow the event.<a href="#section-5.2.3-3.3.2.4.1" class="pilcrow">¶</a></p>
</li>
              </ol>
</li>
            <li id="section-5.2.3-3.4">
              <p id="section-5.2.3-3.4.1">Considering the event's <code>auth_events</code>:<a href="#section-5.2.3-3.4.1" class="pilcrow">¶</a></p>
<p id="section-5.2.3-3.4.2"><strong>TODO</strong>: Does this check make sense for Linearized Matrix? We already removed what was #3 because
it talked about rejecting events which reference rejected events.<a href="#section-5.2.3-3.4.2" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.3-3.4.3">
<li id="section-5.2.3-3.4.3.1">
                  <p id="section-5.2.3-3.4.3.1.1">If there are duplicate entries for a given <code>type</code> and <code>state_key</code> pair, reject the event.<a href="#section-5.2.3-3.4.3.1.1" class="pilcrow">¶</a></p>
</li>
                <li id="section-5.2.3-3.4.3.2">
                  <p id="section-5.2.3-3.4.3.2.1">If there are entries whose <code>type</code> and <code>state_key</code> do not match those specified by the
auth events selection algorithm (<a href="#int-auth-selection" class="auto internal xref">Section 5.2.1</a>), reject the event.<a href="#section-5.2.3-3.4.3.2.1" class="pilcrow">¶</a></p>
</li>
                <li id="section-5.2.3-3.4.3.3">
                  <p id="section-5.2.3-3.4.3.3.1">If there is no <code>m.room.create</code> event among the entries, reject.<a href="#section-5.2.3-3.4.3.3.1" class="pilcrow">¶</a></p>
</li>
              </ol>
</li>
            <li id="section-5.2.3-3.5">
              <p id="section-5.2.3-3.5.1">If the event's <code>type</code> is <code>m.room.member</code>:<a href="#section-5.2.3-3.5.1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.3-3.5.2">
<li id="section-5.2.3-3.5.2.1">
                  <p id="section-5.2.3-3.5.2.1.1">If there is no <code>state_key</code> property, or no <code>membership</code> in <code>content</code>, reject the event.<a href="#section-5.2.3-3.5.2.1.1" class="pilcrow">¶</a></p>
</li>
                <li id="section-5.2.3-3.5.2.2">
                  <p id="section-5.2.3-3.5.2.2.1">If the event <code>content</code>'s <code>membership</code> field is <code>join</code>:<a href="#section-5.2.3-3.5.2.2.1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.3-3.5.2.2.2">
<li id="section-5.2.3-3.5.2.2.2.1">
                      <p id="section-5.2.3-3.5.2.2.2.1.1">If the previous event is an <code>m.room.create</code> event and the <code>state_key</code> is the
creator, allow the event.<a href="#section-5.2.3-3.5.2.2.2.1.1" class="pilcrow">¶</a></p>
</li>
                    <li id="section-5.2.3-3.5.2.2.2.2">
                      <p id="section-5.2.3-3.5.2.2.2.2.1">If <code>sender</code> does not match <code>state_key</code>, reject the event.<a href="#section-5.2.3-3.5.2.2.2.2.1" class="pilcrow">¶</a></p>
</li>
                    <li id="section-5.2.3-3.5.2.2.2.3">
                      <p id="section-5.2.3-3.5.2.2.2.3.1">If the <code>sender</code> is banned, reject the event.<a href="#section-5.2.3-3.5.2.2.2.3.1" class="pilcrow">¶</a></p>
</li>
                    <li id="section-5.2.3-3.5.2.2.2.4">
                      <p id="section-5.2.3-3.5.2.2.2.4.1">If the <code>join_rule</code> for <code>m.room.join_rules</code> is <code>invite</code> or <code>knock</code>, then allow the event if
the current membership state is <code>invite</code> or <code>join</code>.<a href="#section-5.2.3-3.5.2.2.2.4.1" class="pilcrow">¶</a></p>
</li>
                    <li id="section-5.2.3-3.5.2.2.2.5">
                      <p id="section-5.2.3-3.5.2.2.2.5.1">If the <code>join_rule</code> for <code>m.room.join_rules</code> is <code>public</code>, allow the event.<a href="#section-5.2.3-3.5.2.2.2.5.1" class="pilcrow">¶</a></p>
</li>
                    <li id="section-5.2.3-3.5.2.2.2.6">
                      <p id="section-5.2.3-3.5.2.2.2.6.1">Otherwise, reject the event.<a href="#section-5.2.3-3.5.2.2.2.6.1" class="pilcrow">¶</a></p>
</li>
                  </ol>
</li>
                <li id="section-5.2.3-3.5.2.3">
                  <p id="section-5.2.3-3.5.2.3.1">If the event <code>content</code>'s <code>membership</code> field is <code>invite</code>:<a href="#section-5.2.3-3.5.2.3.1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.3-3.5.2.3.2">
<li id="section-5.2.3-3.5.2.3.2.1">
                      <p id="section-5.2.3-3.5.2.3.2.1.1">If the <code>sender</code>'s current membership state is not <code>join</code>, reject the event.<a href="#section-5.2.3-3.5.2.3.2.1.1" class="pilcrow">¶</a></p>
</li>
                    <li id="section-5.2.3-3.5.2.3.2.2">
                      <p id="section-5.2.3-3.5.2.3.2.2.1">If the target user's (<code>state_key</code>) membership is <code>join</code> or <code>ban</code>, reject the event.<a href="#section-5.2.3-3.5.2.3.2.2.1" class="pilcrow">¶</a></p>
</li>
                    <li id="section-5.2.3-3.5.2.3.2.3">
                      <p id="section-5.2.3-3.5.2.3.2.3.1">If the <code>sender</code>'s power level is greater than or equal to the power level needed
to send invites, allow the event.<a href="#section-5.2.3-3.5.2.3.2.3.1" class="pilcrow">¶</a></p>
</li>
                    <li id="section-5.2.3-3.5.2.3.2.4">
                      <p id="section-5.2.3-3.5.2.3.2.4.1">Otherwise, reject the event.<a href="#section-5.2.3-3.5.2.3.2.4.1" class="pilcrow">¶</a></p>
</li>
                  </ol>
</li>
                <li id="section-5.2.3-3.5.2.4">
                  <p id="section-5.2.3-3.5.2.4.1">If the event <code>content</code>'s <code>membership</code> field is <code>leave</code>:<a href="#section-5.2.3-3.5.2.4.1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.3-3.5.2.4.2">
<li id="section-5.2.3-3.5.2.4.2.1">
                      <p id="section-5.2.3-3.5.2.4.2.1.1">If the <code>sender</code> matches the <code>state_key</code>, allow the event if and only if that user's current
membership state is <code>knock</code>, <code>join</code>, or <code>invite</code>.<a href="#section-5.2.3-3.5.2.4.2.1.1" class="pilcrow">¶</a></p>
</li>
                    <li id="section-5.2.3-3.5.2.4.2.2">
                      <p id="section-5.2.3-3.5.2.4.2.2.1">If the <code>sender</code>'s current membership state is not <code>join</code>, reject the event.<a href="#section-5.2.3-3.5.2.4.2.2.1" class="pilcrow">¶</a></p>
</li>
                    <li id="section-5.2.3-3.5.2.4.2.3">
                      <p id="section-5.2.3-3.5.2.4.2.3.1">If the target user's (<code>state_key</code>) current membership state is <code>ban</code>, and the
<code>sender</code>'s power level is less than the power level needed to ban other users, reject the event.<a href="#section-5.2.3-3.5.2.4.2.3.1" class="pilcrow">¶</a></p>
</li>
                    <li id="section-5.2.3-3.5.2.4.2.4">
                      <p id="section-5.2.3-3.5.2.4.2.4.1">If the <code>sender</code>'s power level is greater than or equal to the power level needed to
kick users, and the target user's (<code>state_key</code>) power level is less than the <code>sender</code>'s,
allow the event.<a href="#section-5.2.3-3.5.2.4.2.4.1" class="pilcrow">¶</a></p>
</li>
                    <li id="section-5.2.3-3.5.2.4.2.5">
                      <p id="section-5.2.3-3.5.2.4.2.5.1">Otherwise, reject the event.<a href="#section-5.2.3-3.5.2.4.2.5.1" class="pilcrow">¶</a></p>
</li>
                  </ol>
</li>
                <li id="section-5.2.3-3.5.2.5">
                  <p id="section-5.2.3-3.5.2.5.1">If the event <code>content</code>'s <code>membership</code> field is <code>ban</code>:<a href="#section-5.2.3-3.5.2.5.1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.3-3.5.2.5.2">
<li id="section-5.2.3-3.5.2.5.2.1">
                      <p id="section-5.2.3-3.5.2.5.2.1.1">If the <code>sender</code>'s current membership state is not <code>join</code>, reject the event.<a href="#section-5.2.3-3.5.2.5.2.1.1" class="pilcrow">¶</a></p>
</li>
                    <li id="section-5.2.3-3.5.2.5.2.2">
                      <p id="section-5.2.3-3.5.2.5.2.2.1">If the <code>sender</code>'s power level is greater than or equal to the power level needed
to ban users, and the target user's (<code>state_key</code>) power level is less than the
<code>sender</code>'s power level, allow the event.<a href="#section-5.2.3-3.5.2.5.2.2.1" class="pilcrow">¶</a></p>
</li>
                    <li id="section-5.2.3-3.5.2.5.2.3">
                      <p id="section-5.2.3-3.5.2.5.2.3.1">Otherwise, reject the event.<a href="#section-5.2.3-3.5.2.5.2.3.1" class="pilcrow">¶</a></p>
</li>
                  </ol>
</li>
                <li id="section-5.2.3-3.5.2.6">
                  <p id="section-5.2.3-3.5.2.6.1">If the event <code>content</code>'s <code>membership</code> field is <code>knock</code>:<a href="#section-5.2.3-3.5.2.6.1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.3-3.5.2.6.2">
<li id="section-5.2.3-3.5.2.6.2.1">
                      <p id="section-5.2.3-3.5.2.6.2.1.1">If the <code>join_rule</code> for <code>m.room.join_rules</code> is anything other than <code>knock</code>, reject the event.<a href="#section-5.2.3-3.5.2.6.2.1.1" class="pilcrow">¶</a></p>
</li>
                    <li id="section-5.2.3-3.5.2.6.2.2">
                      <p id="section-5.2.3-3.5.2.6.2.2.1">If the <code>sender</code> does not match the <code>state_key</code>, reject the event.<a href="#section-5.2.3-3.5.2.6.2.2.1" class="pilcrow">¶</a></p>
</li>
                    <li id="section-5.2.3-3.5.2.6.2.3">
                      <p id="section-5.2.3-3.5.2.6.2.3.1">If the <code>sender</code>'s current membership state is not <code>ban</code> or <code>join</code>, allow the event.<a href="#section-5.2.3-3.5.2.6.2.3.1" class="pilcrow">¶</a></p>
</li>
                    <li id="section-5.2.3-3.5.2.6.2.4">
                      <p id="section-5.2.3-3.5.2.6.2.4.1">Otherwise, reject the event.<a href="#section-5.2.3-3.5.2.6.2.4.1" class="pilcrow">¶</a></p>
</li>
                  </ol>
</li>
                <li id="section-5.2.3-3.5.2.7">
                  <p id="section-5.2.3-3.5.2.7.1">Otherwise, the <code>membership</code> is unknown. reject the event.<a href="#section-5.2.3-3.5.2.7.1" class="pilcrow">¶</a></p>
</li>
              </ol>
</li>
            <li id="section-5.2.3-3.6">
              <p id="section-5.2.3-3.6.1">If the <code>sender</code>'s current membership state is not <code>join</code>, reject the event.<a href="#section-5.2.3-3.6.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-5.2.3-3.7">
              <p id="section-5.2.3-3.7.1">If the event <code>type</code>'s required power level to send it is greater than the <code>sender</code>'s power level,
reject the event.<a href="#section-5.2.3-3.7.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-5.2.3-3.8">
              <p id="section-5.2.3-3.8.1">If the event has a <code>state_key</code> which starts with an <code>@</code> and does not match the <code>sender</code>,
reject the event.<a href="#section-5.2.3-3.8.1" class="pilcrow">¶</a></p>
<p id="section-5.2.3-3.8.2"><strong>TODO</strong>: Do we care? This is theoretically to allow for owned state events, but in practice nothing
which uses this concept makes it this far into the auth rules (membership events are validated above).<a href="#section-5.2.3-3.8.2" class="pilcrow">¶</a></p>
</li>
            <li id="section-5.2.3-3.9">
              <p id="section-5.2.3-3.9.1">If the event's <code>type</code> is <code>m.room.power_levels</code>:<a href="#section-5.2.3-3.9.1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.3-3.9.2">
<li id="section-5.2.3-3.9.2.1">
                  <p id="section-5.2.3-3.9.2.1.1">If any of the fields <code>users_default</code>, <code>events_default</code>, <code>state_default</code>, <code>ban</code>, <code>redact</code>,
<code>kick</code>, or <code>invite</code> in <code>content</code> are present and not an integer, reject the event.<a href="#section-5.2.3-3.9.2.1.1" class="pilcrow">¶</a></p>
</li>
                <li id="section-5.2.3-3.9.2.2">
                  <p id="section-5.2.3-3.9.2.2.1">If <code>events</code> in <code>content</code> is present and not an object with values that are integers,
reject the event.<a href="#section-5.2.3-3.9.2.2.1" class="pilcrow">¶</a></p>
</li>
                <li id="section-5.2.3-3.9.2.3">
                  <p id="section-5.2.3-3.9.2.3.1">If the <code>users</code> in <code>content</code> is present and not an object with valid user IDs as keys and
integers as values, reject the event.<a href="#section-5.2.3-3.9.2.3.1" class="pilcrow">¶</a></p>
</li>
                <li id="section-5.2.3-3.9.2.4">
                  <p id="section-5.2.3-3.9.2.4.1">If there is no previous <code>m.room.power_levels</code> event in the room, allow the event.<a href="#section-5.2.3-3.9.2.4.1" class="pilcrow">¶</a></p>
</li>
                <li id="section-5.2.3-3.9.2.5">
                  <p id="section-5.2.3-3.9.2.5.1">For the fields <code>users_default</code>, <code>events_default</code>, <code>state_default</code>, <code>ban</code>, <code>redact</code>, <code>kick</code>,
and <code>invite</code>, check if they were added, changed, or removed. For each found alteration:<a href="#section-5.2.3-3.9.2.5.1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.3-3.9.2.5.2">
<li id="section-5.2.3-3.9.2.5.2.1">
                      <p id="section-5.2.3-3.9.2.5.2.1.1">If the current value is higher than the <code>sender</code>'s current power level, reject the event.<a href="#section-5.2.3-3.9.2.5.2.1.1" class="pilcrow">¶</a></p>
</li>
                    <li id="section-5.2.3-3.9.2.5.2.2">
                      <p id="section-5.2.3-3.9.2.5.2.2.1">If the new value is higher than the <code>sender</code>'s current power level, reject the event.<a href="#section-5.2.3-3.9.2.5.2.2.1" class="pilcrow">¶</a></p>
</li>
                  </ol>
</li>
                <li id="section-5.2.3-3.9.2.6">
                  <p id="section-5.2.3-3.9.2.6.1">For each entry being changed in or removed from <code>events</code>:<a href="#section-5.2.3-3.9.2.6.1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.3-3.9.2.6.2">
<li id="section-5.2.3-3.9.2.6.2.1">
                      <p id="section-5.2.3-3.9.2.6.2.1.1">If the current value is higher than the <code>sender</code>'s current power level, reject the event.<a href="#section-5.2.3-3.9.2.6.2.1.1" class="pilcrow">¶</a></p>
</li>
                  </ol>
</li>
                <li id="section-5.2.3-3.9.2.7">
                  <p id="section-5.2.3-3.9.2.7.1">For each entry being added to or changed in <code>events</code>:<a href="#section-5.2.3-3.9.2.7.1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.3-3.9.2.7.2">
<li id="section-5.2.3-3.9.2.7.2.1">
                      <p id="section-5.2.3-3.9.2.7.2.1.1">If the new value is greater than the <code>sender</code>'s current power level, reject the event.<a href="#section-5.2.3-3.9.2.7.2.1.1" class="pilcrow">¶</a></p>
</li>
                  </ol>
</li>
                <li id="section-5.2.3-3.9.2.8">
                  <p id="section-5.2.3-3.9.2.8.1">For each entry being changed in or removed from <code>users</code>, other than the <code>sender</code>'s own
entry:<a href="#section-5.2.3-3.9.2.8.1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.3-3.9.2.8.2">
<li id="section-5.2.3-3.9.2.8.2.1">
                      <p id="section-5.2.3-3.9.2.8.2.1.1">If the current value is higher than the <code>sender</code>'s current power level, reject the event.<a href="#section-5.2.3-3.9.2.8.2.1.1" class="pilcrow">¶</a></p>
</li>
                  </ol>
</li>
                <li id="section-5.2.3-3.9.2.9">
                  <p id="section-5.2.3-3.9.2.9.1">For each entry being added to or changed in <code>users</code>:<a href="#section-5.2.3-3.9.2.9.1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.2.3-3.9.2.9.2">
<li id="section-5.2.3-3.9.2.9.2.1">
                      <p id="section-5.2.3-3.9.2.9.2.1.1">If the new value is greater than the <code>sender</code>'s current power level, reject the event.<a href="#section-5.2.3-3.9.2.9.2.1.1" class="pilcrow">¶</a></p>
</li>
                  </ol>
</li>
                <li id="section-5.2.3-3.9.2.10">
                  <p id="section-5.2.3-3.9.2.10.1">Otherwise, allow the event.<a href="#section-5.2.3-3.9.2.10.1" class="pilcrow">¶</a></p>
</li>
              </ol>
</li>
            <li id="section-5.2.3-3.10">
              <p id="section-5.2.3-3.10.1">Otherwise, allow the event.<a href="#section-5.2.3-3.10.1" class="pilcrow">¶</a></p>
</li>
          </ol>
<p id="section-5.2.3-4">There are some consequences to these rules:<a href="#section-5.2.3-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.2.3-5.1">
              <p id="section-5.2.3-5.1.1">Unless you are already a member of the room, the only permitted operations (aside from
the initial create/join) are being able to join public rooms, accept invites to rooms,
and reject invites to rooms.<a href="#section-5.2.3-5.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-5.2.3-5.2">
              <p id="section-5.2.3-5.2.1">To unban another user, the sender must have a power level greater than or equal to both
the kick and ban power levels, <em>and</em> greater than the target user's power level.<a href="#section-5.2.3-5.2.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-5.2.3-6"><strong>TODO</strong>: If we want to enforce a single hub in a room, we'd do so here with auth rules.<a href="#section-5.2.3-6" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="int-signing">
<section id="section-6">
      <h2 id="name-signing">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-signing" class="section-name selfRef">Signing</a>
      </h2>
<p id="section-6-1">All servers, including hubs and participants, publish an ed25519 <span>[<a href="#RFC8032" class="cite xref">RFC8032</a>]</span> signing key
to be used by other servers when verifying signatures. These keys can then be fetched over
the transport as needed (<a href="#int-transport-get-server-keys" class="auto internal xref">Section 12.4.1</a>).<a href="#section-6-1" class="pilcrow">¶</a></p>
<p id="section-6-2"><strong>TODO</strong>: Verify RFC reference. We might be using a slightly different ed25519 key today?
See https://hdevalence.ca/blog/2020-10-04-its-25519am<a href="#section-6-2" class="pilcrow">¶</a></p>
<p id="section-6-3">Each key ID consists of an algorithm name and version. Signing keys <span class="bcp14">MUST</span> use an algorithm
of <code>ed25519</code> (and therefore <span class="bcp14">MUST</span> be an ed25519 key). The key version <span class="bcp14">MUST</span> be valid under
the following ABNF <span>[<a href="#RFC5234" class="cite xref">RFC5234</a>]</span>:<a href="#section-6-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6-4">
<pre>
key_version = 1*key_version_char
key_version_char = ALPHA / DIGIT / "_"
</pre><a href="#section-6-4" class="pilcrow">¶</a>
</div>
<p id="section-6-5">An algorithm and version combined is a "key ID", deliminated by <code>:</code> as per the following
ABNF <span>[<a href="#RFC5234" class="cite xref">RFC5234</a>]</span>:<a href="#section-6-5" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6-6">
<pre>
key_id = key_algorithm ":" key_version
key_algorithm = "ed25519"
</pre><a href="#section-6-6" class="pilcrow">¶</a>
</div>
<p id="section-6-7">Additional key algorithms may be supported by future documents.<a href="#section-6-7" class="pilcrow">¶</a></p>
<div id="int-signing-events">
<section id="section-6.1">
        <h3 id="name-signing-events">
<a href="#section-6.1" class="section-number selfRef">6.1. </a><a href="#name-signing-events" class="section-name selfRef">Signing Events</a>
        </h3>
<p id="section-6.1-1">To sign an event:<a href="#section-6.1-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-6.1-2">
<li id="section-6.1-2.1">
            <p id="section-6.1-2.1.1">Redact it (<a href="#int-redactions" class="auto internal xref">Section 8</a>).<a href="#section-6.1-2.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-6.1-2.2">
            <p id="section-6.1-2.2.1">Sign the result as an arbitrary object (<a href="#int-signing-objects" class="auto internal xref">Section 6.2</a>).<a href="#section-6.1-2.2.1" class="pilcrow">¶</a></p>
</li>
        </ol>
</section>
</div>
<div id="int-signing-objects">
<section id="section-6.2">
        <h3 id="name-signing-arbitrary-objects">
<a href="#section-6.2" class="section-number selfRef">6.2. </a><a href="#name-signing-arbitrary-objects" class="section-name selfRef">Signing Arbitrary Objects</a>
        </h3>
<p id="section-6.2-1">To sign an object:<a href="#section-6.2-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-6.2-2">
<li id="section-6.2-2.1">
            <p id="section-6.2-2.1.1">Remove <code>signatures</code> if present.<a href="#section-6.2-2.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-6.2-2.2">
            <p id="section-6.2-2.2.1">Encode the result with Canonical JSON (<a href="#int-canonical-json" class="auto internal xref">Section 7</a>).<a href="#section-6.2-2.2.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-6.2-2.3">
            <p id="section-6.2-2.3.1">Using the relevant ed25519 signing key (usually the server's), sign the object.<a href="#section-6.2-2.3.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-6.2-2.4">
            <p id="section-6.2-2.4.1">Encode that signature under <code>signatures</code> using unpadded base64 (<a href="#int-unpadded-base64" class="auto internal xref">Section 10</a>).<a href="#section-6.2-2.4.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-6.2-3">Note that <code>signatures</code> is an object with keys being the entity which did the signing and value
being the key ID to encoded signature pair. See <a href="#int-pdu" class="auto internal xref">Section 3.5</a> for details on the <code>signatures</code>
structure for events specifically.<a href="#section-6.2-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-checking-signatures">
<section id="section-6.3">
        <h3 id="name-checking-signatures">
<a href="#section-6.3" class="section-number selfRef">6.3. </a><a href="#name-checking-signatures" class="section-name selfRef">Checking Signatures</a>
        </h3>
<p id="section-6.3-1">If the <code>signatures</code> field is missing, doesn't contain the entity that is expected to have done
the signing (usually a server name), doesn't have a known key ID, or is otherwise structurally invalid
then the signature check fails.<a href="#section-6.3-1" class="pilcrow">¶</a></p>
<p id="section-6.3-2">If decoding the base64 fails, the check fails.<a href="#section-6.3-2" class="pilcrow">¶</a></p>
<p id="section-6.3-3">If the object is an event, redact (<a href="#int-redactions" class="auto internal xref">Section 8</a>) it before continuing.<a href="#section-6.3-3" class="pilcrow">¶</a></p>
<p id="section-6.3-4">If removing the <code>signatures</code> property, canonicalizing the JSON (<a href="#int-canonical-json" class="auto internal xref">Section 7</a>),
and verifying the signature fails, the check fails. Note that to verify the signature the server
may need to fetch another server's key first (<a href="#int-transport-get-server-keys" class="auto internal xref">Section 12.4.1</a>).<a href="#section-6.3-4" class="pilcrow">¶</a></p>
<p id="section-6.3-5">Otherwise, the check passes.<a href="#section-6.3-5" class="pilcrow">¶</a></p>
<p id="section-6.3-6"><strong>TODO</strong>: Which specific signatures are required? If a server has multiple signing keys, possibly
a combination of new and old, do we require all or some of them to sign?<a href="#section-6.3-6" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="int-canonical-json">
<section id="section-7">
      <h2 id="name-canonical-json">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-canonical-json" class="section-name selfRef">Canonical JSON</a>
      </h2>
<p id="section-7-1">When signing a JSON object, such as an event, it is important that the bytes be ordered in
the same way for everyone. Otherwise, the signatures will never match.<a href="#section-7-1" class="pilcrow">¶</a></p>
<p id="section-7-2">To canonicalize a JSON object, use <span>[<a href="#RFC8785" class="cite xref">RFC8785</a>]</span>.<a href="#section-7-2" class="pilcrow">¶</a></p>
<p id="section-7-3"><strong>TODO</strong>: Matrix currently doesn't use RFC8785, but it should (or similar).<a href="#section-7-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-redactions">
<section id="section-8">
      <h2 id="name-event-redactions">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-event-redactions" class="section-name selfRef">Event Redactions</a>
      </h2>
<p id="section-8-1">All fields at the top level except the following are stripped from the event:<a href="#section-8-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8-2.1">
          <p id="section-8-2.1.1"><code>type</code><a href="#section-8-2.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-8-2.2">
          <p id="section-8-2.2.1"><code>room_id</code><a href="#section-8-2.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-8-2.3">
          <p id="section-8-2.3.1"><code>sender</code><a href="#section-8-2.3.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-8-2.4">
          <p id="section-8-2.4.1"><code>state_key</code><a href="#section-8-2.4.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-8-2.5">
          <p id="section-8-2.5.1"><code>content</code><a href="#section-8-2.5.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-8-2.6">
          <p id="section-8-2.6.1"><code>origin_server_ts</code><a href="#section-8-2.6.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-8-2.7">
          <p id="section-8-2.7.1"><code>hashes</code><a href="#section-8-2.7.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-8-2.8">
          <p id="section-8-2.8.1"><code>signatures</code><a href="#section-8-2.8.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-8-2.9">
          <p id="section-8-2.9.1"><code>prev_events</code><a href="#section-8-2.9.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-8-2.10">
          <p id="section-8-2.10.1"><code>auth_events</code><a href="#section-8-2.10.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-8-2.11">
          <p id="section-8-2.11.1"><code>hub_server</code><a href="#section-8-2.11.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-8-3">Additionally, some event types retain specific fields under the event's <code>content</code>. All other
fields are stripped.<a href="#section-8-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8-4.1">
          <p id="section-8-4.1.1"><code>m.room.create</code> retains all fields in <code>content</code>.<a href="#section-8-4.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-8-4.2">
          <p id="section-8-4.2.1"><code>m.room.member</code> retains <code>membership</code>.<a href="#section-8-4.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-8-4.3">
          <p id="section-8-4.3.1"><code>m.room.join_rules</code> retains <code>join_rule</code>.<a href="#section-8-4.3.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-8-4.4">
          <p id="section-8-4.4.1"><code>m.room.power_levels</code> retains <code>ban</code>, <code>events</code>, <code>events_default</code>, <code>kick</code>, <code>redact</code>, <code>state_default</code>,
<code>users</code>, <code>users_default</code>, and <code>invite</code>.<a href="#section-8-4.4.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-8-4.5">
          <p id="section-8-4.5.1"><code>m.room.history_visibility</code> retains <code>history_visibility</code>.<a href="#section-8-4.5.1" class="pilcrow">¶</a></p>
</li>
      </ul>
</section>
</div>
<div id="hashes">
<section id="section-9">
      <h2 id="name-hashes">
<a href="#section-9" class="section-number selfRef">9. </a><a href="#name-hashes" class="section-name selfRef">Hashes</a>
      </h2>
<p id="section-9-1">An event is covered by two hashes: a content hash and a reference hash. The content hash covers the
unredacted event to ensure it was not modified in transit. The reference hash covers the essential
fields of the event, including content hashes, and serves as the event's ID.<a href="#section-9-1" class="pilcrow">¶</a></p>
<div id="int-content-hashes">
<section id="section-9.1">
        <h3 id="name-content-hash-calculation">
<a href="#section-9.1" class="section-number selfRef">9.1. </a><a href="#name-content-hash-calculation" class="section-name selfRef">Content Hash Calculation</a>
        </h3>
<p id="section-9.1-1"><strong>TODO</strong>: Describe what this protects, and why it matters.<a href="#section-9.1-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-9.1-2">
<li id="section-9.1-2.1">
            <p id="section-9.1-2.1.1">Remove any existing <code>signatures</code> field.<a href="#section-9.1-2.1.1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-9.1-2.1.2">
<li id="section-9.1-2.1.2.1">
                <p id="section-9.1-2.1.2.1.1">If calculating an LPDU's (<a href="#int-lpdu" class="auto internal xref">Section 3.5.1</a>) content hash, remove any existing <code>hashes</code> field as well.<a href="#section-9.1-2.1.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li id="section-9.1-2.1.2.2">
                <p id="section-9.1-2.1.2.2.1">If <em>not</em> calculating an LPDU's content hash, remove any existing fields under <code>hashes</code> except
for <code>lpdu</code>.<a href="#section-9.1-2.1.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ol>
</li>
          <li id="section-9.1-2.2">
            <p id="section-9.1-2.2.1">Encode the object using canonical JSON.<a href="#section-9.1-2.2.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-9.1-2.3">
            <p id="section-9.1-2.3.1">Hash the resulting bytes with SHA-256 <span>[<a href="#RFC6234" class="cite xref">RFC6234</a>]</span>.<a href="#section-9.1-2.3.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-9.1-2.4">
            <p id="section-9.1-2.4.1">Encode the hash using unpadded base64 (<a href="#int-unpadded-base64" class="auto internal xref">Section 10</a>).<a href="#section-9.1-2.4.1" class="pilcrow">¶</a></p>
</li>
        </ol>
</section>
</div>
<div id="int-reference-hashes">
<section id="section-9.2">
        <h3 id="name-reference-hash-calculation">
<a href="#section-9.2" class="section-number selfRef">9.2. </a><a href="#name-reference-hash-calculation" class="section-name selfRef">Reference Hash Calculation</a>
        </h3>
<p id="section-9.2-1"><strong>TODO</strong>: Describe what this protects, and why it matters.<a href="#section-9.2-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-9.2-2">
<li id="section-9.2-2.1">
            <p id="section-9.2-2.1.1">Redact the event.<a href="#section-9.2-2.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-9.2-2.2">
            <p id="section-9.2-2.2.1">Remove <code>signatures</code> field.<a href="#section-9.2-2.2.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-9.2-2.3">
            <p id="section-9.2-2.3.1">Encode the object using canonical JSON.<a href="#section-9.2-2.3.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-9.2-2.4">
            <p id="section-9.2-2.4.1">Hash the resulting bytes with SHA-256 <span>[<a href="#RFC6234" class="cite xref">RFC6234</a>]</span>.<a href="#section-9.2-2.4.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-9.2-2.5">
            <p id="section-9.2-2.5.1">Encode the hash using URL-safe unpadded base64 (<a href="#int-unpadded-base64" class="auto internal xref">Section 10</a>).<a href="#section-9.2-2.5.1" class="pilcrow">¶</a></p>
</li>
        </ol>
</section>
</div>
</section>
</div>
<div id="int-unpadded-base64">
<section id="section-10">
      <h2 id="name-unpadded-base64">
<a href="#section-10" class="section-number selfRef">10. </a><a href="#name-unpadded-base64" class="section-name selfRef">Unpadded Base64</a>
      </h2>
<p id="section-10-1">Throughout this document, "unpadded base64" is used to represent binary values as strings. Base64 is
as specified by <span><a href="https://rfc-editor.org/rfc/rfc4648#section-4" class="relref">Section 4</a> of [<a href="#RFC4648" class="cite xref">RFC4648</a>]</span>, and "unpadded base64" simply removes any <code>=</code> padding from
the resulting string.<a href="#section-10-1" class="pilcrow">¶</a></p>
<p id="section-10-2">Implementations <span class="bcp14">SHOULD</span> accept input with or without padding on base64 values, where possible.<a href="#section-10-2" class="pilcrow">¶</a></p>
<p id="section-10-3"><span><a href="https://rfc-editor.org/rfc/rfc4648#section-5" class="relref">Section 5</a> of [<a href="#RFC4648" class="cite xref">RFC4648</a>]</span> describes <em>URL-safe</em> base64. The same changes are adopted here. Namely, the
62nd and 63rd characters are replaced with <code>-</code> and <code>_</code> respectively. The unpadded behaviour is as
described above.<a href="#section-10-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-hub-selection">
<section id="section-11">
      <h2 id="name-hub-selection">
<a href="#section-11" class="section-number selfRef">11. </a><a href="#name-hub-selection" class="section-name selfRef">Hub Selection</a>
      </h2>
<p id="section-11-1"><strong>TODO</strong>: Describe impacts of hub transfers<a href="#section-11-1" class="pilcrow">¶</a></p>
<p id="section-11-2">The hub server for a room is the server denoted by the <code>sender</code> of the <code>m.room.create</code> event
(<a href="#int-ev-create" class="auto internal xref">Section 3.5.3.1</a>). Note that this is effectively the same as the server name contained in the
room ID (<a href="#int-room-id" class="auto internal xref">Section 3.2</a>) currently, however is deliberately not defined as such. In a future
scenario where hub transfers are possible, the room ID does not change when the hub server does.<a href="#section-11-2" class="pilcrow">¶</a></p>
<div id="hub-transfers">
<section id="section-11.1">
        <h3 id="name-hub-transfers">
<a href="#section-11.1" class="section-number selfRef">11.1. </a><a href="#name-hub-transfers" class="section-name selfRef">Hub Transfers</a>
        </h3>
<p id="section-11.1-1"><strong>TODO</strong>: This section, if we want a single canonical hub in the room. Some expected problems in this
area are: who signs the transfer event? who <em>sends</em> the transfer event? how does a transfer start?<a href="#section-11.1-1" class="pilcrow">¶</a></p>
<p id="section-11.1-2"><strong>TODO</strong>: Likely to be done with an <code>m.room.hub</code> state event in the room, where the "current hub" is
either the sender of <code>m.room.hub</code> or <code>m.room.create</code> if no hub state event is present. Auth rules
would govern what makes for a legal <code>m.room.hub</code> event.<a href="#section-11.1-2" class="pilcrow">¶</a></p>
<p id="section-11.1-3"><strong>TODO</strong>: <span>[<a href="#I-D.kohbrok-mimi-portability" class="cite xref">I-D.kohbrok-mimi-portability</a>]</span> may be of help here.<a href="#section-11.1-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="int-transport">
<section id="section-12">
      <h2 id="name-transport">
<a href="#section-12" class="section-number selfRef">12. </a><a href="#name-transport" class="section-name selfRef">Transport</a>
      </h2>
<p id="section-12-1">This document specifies a wire transport which uses JSON <span>[<a href="#RFC8259" class="cite xref">RFC8259</a>]</span> over HTTPS <span>[<a href="#RFC9110" class="cite xref">RFC9110</a>]</span>. Servers
<span class="bcp14">MUST</span> support a minimum of HTTP/2 <span>[<a href="#RFC9113" class="cite xref">RFC9113</a>]</span> and TLS 1.3 <span>[<a href="#RFC8446" class="cite xref">RFC8446</a>]</span>.<a href="#section-12-1" class="pilcrow">¶</a></p>
<p id="section-12-2"><strong>TODO</strong>: This transport doesn't scale, and doesn't use RESTful endpoints. This example transport is
heavily inspired by Matrix's existing Server-Server API, largely acting as a starting point for testing
interoperability of the access control semantics. A better option might be gRPC, which might change how
events are structured but keep the overall semantics the same. <span>[<a href="#I-D.rosenberg-mimi-protocol" class="cite xref">I-D.rosenberg-mimi-protocol</a>]</span> might
have ideas here as well for REST APIs.<a href="#section-12-2" class="pilcrow">¶</a></p>
<div id="int-tls">
<section id="section-12.1">
        <h3 id="name-tls-certificates">
<a href="#section-12.1" class="section-number selfRef">12.1. </a><a href="#name-tls-certificates" class="section-name selfRef">TLS Certificates</a>
        </h3>
<p id="section-12.1-1">Servers <span class="bcp14">MUST</span> provide a TLS certificate signed by a known Certificate Authority. Requesting servers
are ultimately responsible for the Certificate Authorities they place trust in, however servers
<span class="bcp14">SHOULD</span> trust authorities which would commonly be trusted by an operating system or web browser.<a href="#section-12.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="api-standards">
<section id="section-12.2">
        <h3 id="name-api-standards">
<a href="#section-12.2" class="section-number selfRef">12.2. </a><a href="#name-api-standards" class="section-name selfRef">API Standards</a>
        </h3>
<div id="int-transport-requests-responses">
<section id="section-12.2.1">
          <h4 id="name-requests-and-responses">
<a href="#section-12.2.1" class="section-number selfRef">12.2.1. </a><a href="#name-requests-and-responses" class="section-name selfRef">Requests and Responses</a>
          </h4>
<p id="section-12.2.1-1">All HTTP <code>POST</code> and <code>PUT</code> endpoints require the sending server to supply a (potentially empty) JSON
object as the request body. Requesting servers <span class="bcp14">SHOULD</span> supply a <code>Content-Type</code> header of <code>application/json</code>
for such requests.<a href="#section-12.2.1-1" class="pilcrow">¶</a></p>
<p id="section-12.2.1-2">All endpoints which require a server to respond with a JSON object <span class="bcp14">MUST</span> include a <code>Content-Type</code> header
of <code>application/json</code>.<a href="#section-12.2.1-2" class="pilcrow">¶</a></p>
<p id="section-12.2.1-3">All JSON data, in requests or responses, <span class="bcp14">MUST</span> be encoded using UTF-8 <span>[<a href="#RFC3629" class="cite xref">RFC3629</a>]</span>.<a href="#section-12.2.1-3" class="pilcrow">¶</a></p>
<p id="section-12.2.1-4">All endpoints in this document do <em>not</em> support trailing slashes on them. When such a request is
encountered, it <span class="bcp14">MUST</span> be handled as an unknown endpoint (<a href="#int-unknown-endpoints" class="auto internal xref">Section 12.2.3</a>). Examples include:<a href="#section-12.2.1-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.2.1-5.1">
              <p id="section-12.2.1-5.1.1"><code>https://example.org/_matrix/path</code> - valid.<a href="#section-12.2.1-5.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-12.2.1-5.2">
              <p id="section-12.2.1-5.2.1"><code>https://example.org/_matrix/path/</code> - unknown/invalid.<a href="#section-12.2.1-5.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-12.2.1-5.3">
              <p id="section-12.2.1-5.3.1"><code>https://example.org//_matrix/path</code> - unknown/invalid (domain also can't have a trailing slash).<a href="#section-12.2.1-5.3.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-12.2.1-5.4">
              <p id="section-12.2.1-5.4.1"><code>https://example.org//_matrix/path/</code> - doubly unknown/invalid.<a href="#section-12.2.1-5.4.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-12.2.1-6">Servers (both hub and participants) <span class="bcp14">MUST</span> implement all endpoints unless otherwise specified.<a href="#section-12.2.1-6" class="pilcrow">¶</a></p>
<p id="section-12.2.1-7">Most endpoints have a version number as part of the path. This version number is that endpoint's version,
allowing for breaking changes to be made to the schema of that endpoint. For clarity, the version number
is <em>not</em> representative of an API version.<a href="#section-12.2.1-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-transport-errors">
<section id="section-12.2.2">
          <h4 id="name-errors">
<a href="#section-12.2.2" class="section-number selfRef">12.2.2. </a><a href="#name-errors" class="section-name selfRef">Errors</a>
          </h4>
<p id="section-12.2.2-1">All errors are represented by an error code defined by this document and an accompanied HTTP status code.
It is possible for a HTTP status code to map to multiple error codes, and it's possible for an error
code to map to multiple HTTP status codes.<a href="#section-12.2.2-1" class="pilcrow">¶</a></p>
<p id="section-12.2.2-2">When a server is returning an error to a caller, it <span class="bcp14">MUST</span> use the most appropriate error response defined
by the endpoint. If no appropriate error response is specified, the server <span class="bcp14">SHOULD</span> use <code>M_UNKNOWN</code> as the
error code and <code>500 Internal Server Error</code> as the HTTP status code.<a href="#section-12.2.2-2" class="pilcrow">¶</a></p>
<p id="section-12.2.2-3">Errors are represented as JSON objects, requiring a <code>Content-Type: application/json</code> response header:<a href="#section-12.2.2-3" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.2.2-4">
<pre>
{
  "errcode": "M_UNKNOWN",
  "error": "Something went wrong."
}
</pre><a href="#section-12.2.2-4" class="pilcrow">¶</a>
</div>
<p id="section-12.2.2-5"><code>errcode</code> is required and denotes the error code. <code>error</code> is an optional human-readable description of
the error. <code>error</code> can be as precise or vague as the responding server desires - the strings in this
document are suggestions.<a href="#section-12.2.2-5" class="pilcrow">¶</a></p>
<p id="section-12.2.2-6">Some common error codes are:<a href="#section-12.2.2-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.2.2-7.1">
              <p id="section-12.2.2-7.1.1"><code>M_UNKNOWN</code> - An unknown error has occurred.<a href="#section-12.2.2-7.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-12.2.2-7.2">
              <p id="section-12.2.2-7.2.1"><code>M_FORBIDDEN</code> - The caller is not permitted to access the resource. For example, trying to join a room
the user does not have an invite for.<a href="#section-12.2.2-7.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-12.2.2-7.3">
              <p id="section-12.2.2-7.3.1"><code>M_NOT_JSON</code> - The request did not contain valid JSON. Must be accompanied by a <code>400 Bad Request</code> HTTP
status code.<a href="#section-12.2.2-7.3.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-12.2.2-7.4">
              <p id="section-12.2.2-7.4.1"><code>M_BAD_JSON</code> - The request did contain valid JSON, but it was missing required keys or was malformed in
 another way. Must be accompanied by a <code>400 Bad Request</code> HTTP status code.<a href="#section-12.2.2-7.4.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-12.2.2-7.5">
              <p id="section-12.2.2-7.5.1"><code>M_LIMIT_EXCEEDED</code> - Too many requests have been sent. The caller should wait before trying the request
again.<a href="#section-12.2.2-7.5.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-12.2.2-7.6">
              <p id="section-12.2.2-7.6.1"><code>M_TOO_LARGE</code> - The request was too large for the receiver to handle.<a href="#section-12.2.2-7.6.1" class="pilcrow">¶</a></p>
</li>
          </ul>
</section>
</div>
<div id="int-unknown-endpoints">
<section id="section-12.2.3">
          <h4 id="name-unsupported-endpoints">
<a href="#section-12.2.3" class="section-number selfRef">12.2.3. </a><a href="#name-unsupported-endpoints" class="section-name selfRef">Unsupported Endpoints</a>
          </h4>
<p id="section-12.2.3-1">If a server receives a request for an unsupported or otherwise unknown endpoint, the server <span class="bcp14">MUST</span> respond
with an HTTP <code>404 Not Found</code> status code and <code>M_UNRECOGNIZED</code> error code. If the request was for a known
endpoint, but wrong HTTP method, a <code>405 Method Not Allowed</code> HTTP status code and <code>M_UNRECOGNIZED</code> error
code (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>).<a href="#section-12.2.3-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="malformed-requests">
<section id="section-12.2.4">
          <h4 id="name-malformed-requests">
<a href="#section-12.2.4" class="section-number selfRef">12.2.4. </a><a href="#name-malformed-requests" class="section-name selfRef">Malformed Requests</a>
          </h4>
<p id="section-12.2.4-1">If a server is expecting JSON in the request body but receives something else, it <span class="bcp14">MUST</span> respond with an
HTTP status code of <code>400 Bad Request</code> and error code <code>M_NOT_JSON</code> (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>). If the
request contains JSON, and is for a known endpoint, but otherwise missing required keys or is malformed,
the server <span class="bcp14">MUST</span> respond with an HTTP status code of <code>400 Bad Request</code> and error code <code>M_BAD_JSON</code>
(<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>). Where possible, <code>error</code> for <code>M_BAD_JSON</code> should describe the missing keys
or other parsing error.<a href="#section-12.2.4-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-txn-ids">
<section id="section-12.2.5">
          <h4 id="name-transaction-identifiers">
<a href="#section-12.2.5" class="section-number selfRef">12.2.5. </a><a href="#name-transaction-identifiers" class="section-name selfRef">Transaction Identifiers</a>
          </h4>
<p id="section-12.2.5-1">Where endpoints use HTTP <code>PUT</code>, it is typical for a "transaction ID" to be specified in the path
parameters. This transaction ID <span class="bcp14">MUST</span> ONLY be used for making requests idempotent - if a server receives
two (or more) requests with the same transaction ID, it <span class="bcp14">MUST</span> return the same response for each and only
process the request body once. It is assumed that requests using the same transaction ID also contain
the same request body between calls.<a href="#section-12.2.5-1" class="pilcrow">¶</a></p>
<p id="section-12.2.5-2">A transaction ID only needs to be unique per-endpoint and per-sending server. A server's transaction IDs
do not affect requests made by other servers or made to other endpoints by the same server.<a href="#section-12.2.5-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="rate-limiting">
<section id="section-12.2.6">
          <h4 id="name-rate-limiting">
<a href="#section-12.2.6" class="section-number selfRef">12.2.6. </a><a href="#name-rate-limiting" class="section-name selfRef">Rate Limiting</a>
          </h4>
<p id="section-12.2.6-1">Servers <span class="bcp14">SHOULD</span> implement rate limiting semantics to reduce the risk of being overloaded. Endpoints which
support being rate limited are annotated in this document.<a href="#section-12.2.6-1" class="pilcrow">¶</a></p>
<p id="section-12.2.6-2">If a rate limit is encountered, the server <span class="bcp14">MUST</span> respond with an HTTP <code>429 Too Many Requests</code> status code
and <code>M_LIMIT_EXCEEDED</code> error code (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>). If applicable, the server should additionally
include a <code>retry_after_ms</code> integer field on the error response to denote how long the caller should
wait before retrying, in milliseconds.<a href="#section-12.2.6-2" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.2.6-3">
<pre>
{
  "errcode": "M_LIMIT_EXCEEDED",
  "error": "Too many requests. Try again later.",
  "retry_after_ms": 10254
}
</pre><a href="#section-12.2.6-3" class="pilcrow">¶</a>
</div>
<p id="section-12.2.6-4">The exact rate limit mechanics are left as an implementation detail. A potential approach may be to
prevent repeated requests for the same resource at a high rate and ensuring a remote server does not
request more than a defined number of resources at a time.<a href="#section-12.2.6-4" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="int-resolve-domain">
<section id="section-12.3">
        <h3 id="name-resolving-server-names">
<a href="#section-12.3" class="section-number selfRef">12.3. </a><a href="#name-resolving-server-names" class="section-name selfRef">Resolving Server Names</a>
        </h3>
<p id="section-12.3-1">Before making an API request, the caller <span class="bcp14">MUST</span> resolve a server name (<a href="#int-server-names" class="auto internal xref">Section 3.1</a>) to an IP
address and port, suitable for HTTPS <span>[<a href="#RFC9110" class="cite xref">RFC9110</a>]</span> traffic.<a href="#section-12.3-1" class="pilcrow">¶</a></p>
<p id="section-12.3-2">A server <span class="bcp14">MAY</span> change the IP/port combination used for API endpoints using SRV DNS records <span>[<a href="#RFC2782" class="cite xref">RFC2782</a>]</span>.
Servers <span class="bcp14">MAY</span> additionally change which TLS certificate is presented by using <code>.well-known</code> delegation.<a href="#section-12.3-2" class="pilcrow">¶</a></p>
<p id="section-12.3-3"><code>.well-known</code> delegation (step 3 below) is recommended for its ease of configuration over SRV DNS records.<a href="#section-12.3-3" class="pilcrow">¶</a></p>
<p id="section-12.3-4">The target server <span class="bcp14">MUST</span> present a valid TLS certificate (<a href="#int-tls" class="auto internal xref">Section 12.1</a>) for the name described in each
step. Similarly, the requesting server <span class="bcp14">MUST</span> use an HTTP <code>Host</code> header matching the description in each
step.<a href="#section-12.3-4" class="pilcrow">¶</a></p>
<p id="section-12.3-5">Server developers should note that many of the DNS requirements for the steps below are typically handled
by the software language or library implicitly. It is rare that a DNS A record needs to be resolved manually,
for example.<a href="#section-12.3-5" class="pilcrow">¶</a></p>
<p id="section-12.3-6">Per <a href="#int-server-names" class="auto internal xref">Section 3.1</a>, a server name consists of <code>&lt;hostname&gt;[:&lt;port&gt;]</code>. The steps to convert that
server name to an IP address and port are:<a href="#section-12.3-6" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-12.3-7">
<li id="section-12.3-7.1">
            <p id="section-12.3-7.1.1">If <code>&lt;hostname&gt;</code> has an explicit <code>&lt;port&gt;</code> is present, resolve <code>&lt;hostname&gt;</code> to
an IP address using CNAME <span>[<a href="#RFC1034" class="cite xref">RFC1034</a>]</span> <span>[<a href="#RFC2181" class="cite xref">RFC2181</a>]</span>, AAAA <span>[<a href="#RFC3596" class="cite xref">RFC3596</a>]</span>, or A <span>[<a href="#RFC1035" class="cite xref">RFC1035</a>]</span> DNS
records. Requests are made to the resolved IP address and port number.<a href="#section-12.3-7.1.1" class="pilcrow">¶</a></p>
<p id="section-12.3-7.1.2">
TLS certificate: <code>&lt;hostname&gt;</code> (always without port)<a href="#section-12.3-7.1.2" class="pilcrow">¶</a></p>
<p id="section-12.3-7.1.3">
Host header: <code>&lt;hostname&gt;:&lt;port&gt;</code><a href="#section-12.3-7.1.3" class="pilcrow">¶</a></p>
</li>
          <li id="section-12.3-7.2">
            <p id="section-12.3-7.2.1">A regular (non-Matrix) HTTPS request is made to <code>https://&lt;hostname&gt;/.well-known/matrix/server</code>,
expecting the schema defined by <a href="#int-wellknown" class="auto internal xref">Section 12.3.1</a>. If the response is invalid (bad/not JSON, missing
properties, non-200 response, etc), skip to Step 4. If the response is valid, the <code>m.server</code> property
is parsed as <code>&lt;delegated_hostname&gt;[:&lt;delegated_port&gt;]</code>.<a href="#section-12.3-7.2.1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-12.3-7.2.2">
<li id="section-12.3-7.2.2.1">
                <p id="section-12.3-7.2.2.1.1">If <code>&lt;delegated_hostname&gt;</code> has an explicit <code>&lt;delegated_port&gt;</code> is present, resolve
<code>&lt;delegated_hostname&gt;</code> to an IP address using CNAME, AAAA, or A DNS records. Requests are made to the
resolved IP address and port number.<a href="#section-12.3-7.2.2.1.1" class="pilcrow">¶</a></p>
<p id="section-12.3-7.2.2.1.2">
TLS certificate: <code>&lt;delegated_hostname&gt;</code> (always without port)<a href="#section-12.3-7.2.2.1.2" class="pilcrow">¶</a></p>
<p id="section-12.3-7.2.2.1.3">
Host header: <code>&lt;delegated_hostname&gt;:&lt;delegated_port&gt;</code><a href="#section-12.3-7.2.2.1.3" class="pilcrow">¶</a></p>
</li>
              <li id="section-12.3-7.2.2.2">
                <p id="section-12.3-7.2.2.2.1">An SRV DNS record is resolved for <code>_matrix._tcp.&lt;delegated_hostname&gt;</code>. This may result in another
hostname and port to be resolved using AAAA or A DNS records. Requests are made to the resolved IP
address and port number.<a href="#section-12.3-7.2.2.2.1" class="pilcrow">¶</a></p>
<p id="section-12.3-7.2.2.2.2">
TLS certificate: <code>&lt;delegated_hostname&gt;</code><a href="#section-12.3-7.2.2.2.2" class="pilcrow">¶</a></p>
<p id="section-12.3-7.2.2.2.3">
Host header: <code>&lt;delegated_hostname&gt;</code> (without port)<a href="#section-12.3-7.2.2.2.3" class="pilcrow">¶</a></p>
</li>
              <li id="section-12.3-7.2.2.3">
                <p id="section-12.3-7.2.2.3.1">If no SRV record is found, an IP address is resolved for <code>&lt;delegated_hostname&gt;</code> is resolved using
CNAME, AAAA, or A DNS records. Requests are made to the resolved IP address with port number 8448.<a href="#section-12.3-7.2.2.3.1" class="pilcrow">¶</a></p>
<p id="section-12.3-7.2.2.3.2">
TLS certificate: <code>&lt;delegated_hostname&gt;</code><a href="#section-12.3-7.2.2.3.2" class="pilcrow">¶</a></p>
<p id="section-12.3-7.2.2.3.3">
Host header: <code>&lt;delegated_hostname&gt;</code> (without port)<a href="#section-12.3-7.2.2.3.3" class="pilcrow">¶</a></p>
</li>
            </ol>
</li>
          <li id="section-12.3-7.3">
            <p id="section-12.3-7.3.1">If the <code>.well-known</code> call from Step 2 resulted in an invalid response, an SRV DNS record is resolved
for <code>_matrix._tcp.&lt;hostname&gt;</code>. This may result in another hostname and port to be resolved using AAAA
or A DNS records. Requests are made to the resolved IP address and port number.<a href="#section-12.3-7.3.1" class="pilcrow">¶</a></p>
<p id="section-12.3-7.3.2">
TLS certificate: <code>&lt;hostname&gt;</code> (always without port)<a href="#section-12.3-7.3.2" class="pilcrow">¶</a></p>
<p id="section-12.3-7.3.3">
Host header: <code>&lt;hostname&gt;</code> (without port)<a href="#section-12.3-7.3.3" class="pilcrow">¶</a></p>
</li>
          <li id="section-12.3-7.4">
            <p id="section-12.3-7.4.1">If the <code>.well-known</code> call from Step 3 resulted in an invalid response, and the SRV record from Step 4
was not found, and IP address is resolved using CNAME, AAAA, or A DNS records. Requests are made to the
resolved IP address and port 8448.<a href="#section-12.3-7.4.1" class="pilcrow">¶</a></p>
<p id="section-12.3-7.4.2">
TLS certificate: <code>&lt;hostname&gt;</code> (always without port)<a href="#section-12.3-7.4.2" class="pilcrow">¶</a></p>
<p id="section-12.3-7.4.3">
Host header: <code>&lt;hostname&gt;</code> (without port)<a href="#section-12.3-7.4.3" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-12.3-8">We require <code>&lt;[delegated_]hostname&gt;</code> rather than <code>&lt;srv_hostname&gt;</code> in Steps 2.3 and 3 for the following reasons:<a href="#section-12.3-8" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-12.3-9">
<li id="section-12.3-9.1">
            <p id="section-12.3-9.1.1">DNS is largely insecure (not all domains use DNSSEC <span>[<a href="#RFC9364" class="cite xref">RFC9364</a>]</span>), so the target of the SRV record must
prove it is a valid delegate/target for <code>&lt;[delegated_]hostname&gt;</code> via TLS.<a href="#section-12.3-9.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-12.3-9.2">
            <p id="section-12.3-9.2.1"><span><a href="https://rfc-editor.org/rfc/rfc6125#section-6.2.1" class="relref">Section 6.2.1</a> of [<a href="#RFC6125" class="cite xref">RFC6125</a>]</span> recommends this approach, and is consistent with other applications
which use SRV records (such as <span><a href="https://rfc-editor.org/rfc/rfc6120#section-13.7.2.1" class="relref">Section 13.7.2.1</a> of [<a href="#RFC6120" class="cite xref">RFC6120</a>]</span>/XMPP).<a href="#section-12.3-9.2.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-12.3-10">Server implementations and owners should additionally note that the target of a SRV record <span class="bcp14">MUST NOT</span> be a CNAME,
as per RFC 2782 <span>[<a href="#RFC2782" class="cite xref">RFC2782</a>]</span>:<a href="#section-12.3-10" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-12.3-11.1">
            <p id="section-12.3-11.1.1">the name <span class="bcp14">MUST NOT</span> be an alias (in the sense of RFC 1034 or RFC 2181)<a href="#section-12.3-11.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-12.3-12"><span>[<a href="#RFC1034" class="cite xref">RFC1034</a>]</span> <span>[<a href="#RFC2181" class="cite xref">RFC2181</a>]</span><a href="#section-12.3-12" class="pilcrow">¶</a></p>
<div id="int-wellknown">
<section id="section-12.3.1">
          <h4 id="name-get-well-known-matrix-serve">
<a href="#section-12.3.1" class="section-number selfRef">12.3.1. </a><a href="#name-get-well-known-matrix-serve" class="section-name selfRef"><code>GET /.well-known/matrix/server</code></a>
          </h4>
<p id="section-12.3.1-1">Used by the server name resolution approach to determine a delegated hostname for a given server. 30x HTTP
redirection <span class="bcp14">MUST</span> be followed, though loops <span class="bcp14">SHOULD</span> be avoided. Normal X.509 certificate validation is applied
to this endpoint (not the specific validation required by the server name resolution steps) <span>[<a href="#RFC5280" class="cite xref">RFC5280</a>]</span>.<a href="#section-12.3.1-1" class="pilcrow">¶</a></p>
<p id="section-12.3.1-2">This endpoint <span class="bcp14">MAY</span> be implemented by servers (it is optional).<a href="#section-12.3.1-2" class="pilcrow">¶</a></p>
<p id="section-12.3.1-3"><strong>Rate-limited</strong>: No.<a href="#section-12.3.1-3" class="pilcrow">¶</a></p>
<p id="section-12.3.1-4"><strong>Authentication required</strong>: No.<a href="#section-12.3.1-4" class="pilcrow">¶</a></p>
<p id="section-12.3.1-5">This HTTP endpoint does not specify any request parameters or body.<a href="#section-12.3.1-5" class="pilcrow">¶</a></p>
<p id="section-12.3.1-6"><code>200 OK</code> response:<a href="#section-12.3.1-6" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.3.1-7">
<pre>
{
   "m.server": "delegated.example.org:8448"
}
</pre><a href="#section-12.3.1-7" class="pilcrow">¶</a>
</div>
<p id="section-12.3.1-8"><code>m.server</code> is a required response field. Responses <span class="bcp14">SHOULD</span> have a <code>Content-Type</code> HTTP header of
<code>application/json</code>, however servers parsing the response should assume that the body is JSON regardless
of <code>Content-Type</code> header. Failures in parsing the JSON or otherwise invalid data that prevents parsing
<span class="bcp14">MUST NOT</span> result in discovery failure. Instead, the caller is expected to move on to the next step of
the name resolution approach.<a href="#section-12.3.1-8" class="pilcrow">¶</a></p>
<p id="section-12.3.1-9">Cache control headers <span class="bcp14">SHOULD</span> be respected on a <code>200 OK</code> response. Callers <span class="bcp14">SHOULD</span> impose a maximum
cache time of 48 hours, regardless of cache control headers. A default of 24 hours <span class="bcp14">SHOULD</span> be used
when no cache control headers are present.<a href="#section-12.3.1-9" class="pilcrow">¶</a></p>
<p id="section-12.3.1-10">Error responses (non-200) <span class="bcp14">SHOULD</span> be cached for no longer than 1 hour. Callers <span class="bcp14">SHOULD</span> exponentially
back off (to a defined limit) upon receiving repeated error responses.<a href="#section-12.3.1-10" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="int-transport-auth">
<section id="section-12.4">
        <h3 id="name-request-authentication">
<a href="#section-12.4" class="section-number selfRef">12.4. </a><a href="#name-request-authentication" class="section-name selfRef">Request Authentication</a>
        </h3>
<p id="section-12.4-1">Most endpoints in this document require authentication to prove which server is making the request.
This is done using public key digital signatures.<a href="#section-12.4-1" class="pilcrow">¶</a></p>
<p id="section-12.4-2">The request method, target, and body are represented as a JSON object, signed, and appended as an HTTP
<code>Authorization</code> header with an auth scheme of <code>X-Matrix</code>.<a href="#section-12.4-2" class="pilcrow">¶</a></p>
<p id="section-12.4-3">The object to be signed is:<a href="#section-12.4-3" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.4-4">
<pre>
{
   "method": "GET",
   "uri": "/path/to/endpoint?with_qs=true",
   "origin": "requesting.server.name.example.org",
   "destination": "target.server.name.example.org",
   "content": {"json_request_body": true}
}
</pre><a href="#section-12.4-4" class="pilcrow">¶</a>
</div>
<p id="section-12.4-5"><code>method</code> is the HTTP request method, capitalized. <code>uri</code> is the full request path, beginning with the
leading slash and containing the query string (if present). <code>uri</code> does not contain the <code>https:</code> scheme
or hostname.<a href="#section-12.4-5" class="pilcrow">¶</a></p>
<p id="section-12.4-6"><strong>TODO</strong>: Define an ordering algorithm for the query string (if we need to?).<a href="#section-12.4-6" class="pilcrow">¶</a></p>
<p id="section-12.4-7"><code>origin</code> and <code>destination</code> are the sender and receiver server names (<a href="#int-server-names" class="auto internal xref">Section 3.1</a>), respectively.<a href="#section-12.4-7" class="pilcrow">¶</a></p>
<p id="section-12.4-8"><code>content</code> is the JSON-encoded request body. When a request doesn't contain a body, such as in <code>GET</code>
requests, use an empty JSON object.<a href="#section-12.4-8" class="pilcrow">¶</a></p>
<p id="section-12.4-9">That object is then signed (<a href="#int-signing-objects" class="auto internal xref">Section 6.2</a>) by the requesting server. The resulting signature
is appended as an <code>Authentication</code> HTTP header on the request:<a href="#section-12.4-9" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-12.4-10">
<pre>
GET /path/to/endpoint?with_qs=true
Authorization: X-Matrix origin="requesting.server.name.example.org",
   destination="target.server.name.example.org",
   key="ed25519:0",
   sig="&lt;unpadded base64 encoded signature&gt;"
Content-Type: application/json

{"json_request_body": true}
</pre><a href="#section-12.4-10" class="pilcrow">¶</a>
</div>
<p id="section-12.4-11">Linebreaks within <code>Authorization</code> are for clarity and are non-normative.<a href="#section-12.4-11" class="pilcrow">¶</a></p>
<p id="section-12.4-12">The format of the Authorization header matches <span><a href="https://rfc-editor.org/rfc/rfc9110#section-11.4" class="relref">Section 11.4</a> of [<a href="#RFC9110" class="cite xref">RFC9110</a>]</span>. The header begins with an
authorization scheme of <code>X-Matrix</code>, followed by one or more spaces, followed by an (unordered)
comma-separated list of parameters written as name=value pairs. The names are case insensitive, though
the values are. The values must be enclosed in quotes if they contain characters which are not allowed
in a <code>token</code>, as defined by <span><a href="https://rfc-editor.org/rfc/rfc9110#section-5.6.2" class="relref">Section 5.6.2</a> of [<a href="#RFC9110" class="cite xref">RFC9110</a>]</span>. If a value is a valid <code>token</code> it may not be
enclosed in quotes. Quoted values <span class="bcp14">MAY</span> contain backslash-escaped characters. When parsing the header,
the recipient must unescape the characters.<a href="#section-12.4-12" class="pilcrow">¶</a></p>
<p id="section-12.4-13">The exact parameters are:<a href="#section-12.4-13" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.4-14.1">
            <p id="section-12.4-14.1.1"><code>origin</code> - The name of the sending server. <span class="bcp14">MUST</span> match the <code>origin</code> in the signed JSON.<a href="#section-12.4-14.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-12.4-14.2">
            <p id="section-12.4-14.2.1"><code>destination</code> - The name of the receiving server. <span class="bcp14">MUST</span> match the <code>destination</code> in the signed JSON.<a href="#section-12.4-14.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-12.4-14.3">
            <p id="section-12.4-14.3.1"><code>key</code> - The ID, including algorithm name, of the sending server's signing key used to sign the request.<a href="#section-12.4-14.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-12.4-14.4">
            <p id="section-12.4-14.4.1"><code>signature</code> - The unpadded base64 (<a href="#int-unpadded-base64" class="auto internal xref">Section 10</a>) encoded signature from step 2.<a href="#section-12.4-14.4.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-12.4-15">Unknown parameters are ignored and <span class="bcp14">MUST NOT</span> result in authentication errors.<a href="#section-12.4-15" class="pilcrow">¶</a></p>
<p id="section-12.4-16">A receiving server validates the Authorization header by composing the JSON object represented above
and checking the sender's signature (<a href="#int-checking-signatures" class="auto internal xref">Section 6.3</a>). Note that to comply with
<a href="#int-checking-signatures" class="auto internal xref">Section 6.3</a> the receiver may need to append a <code>signatures</code> field to the JSON object
manually. All signatures <span class="bcp14">MUST</span> use an unexpired key at the time of the request
(<a href="#int-transport-keys-validity" class="auto internal xref">Section 12.4.1.1</a>).<a href="#section-12.4-16" class="pilcrow">¶</a></p>
<p id="section-12.4-17">A server with multiple signing keys <span class="bcp14">SHOULD</span> include an <code>Authorization</code> header for each signing key.<a href="#section-12.4-17" class="pilcrow">¶</a></p>
<p id="section-12.4-18">If an endpoint requires authentication, servers <span class="bcp14">MUST</span>:<a href="#section-12.4-18" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.4-19.1">
            <p id="section-12.4-19.1.1">Validate all presented <code>Authorization</code> headers.<a href="#section-12.4-19.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-12.4-19.2">
            <p id="section-12.4-19.2.1">Ensure at least one <code>Authorization</code> header is present.<a href="#section-12.4-19.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-12.4-20">If either fails (lack of headers, or any of the headers fail validation), the request <span class="bcp14">MUST</span> be rejected
with an HTTP <code>401 Unauthorized</code> status code and <code>M_FORBIDDEN</code> error code (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>):<a href="#section-12.4-20" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.4-21">
<pre>
{
   "errcode": "M_FORBIDDEN",
   "error": "Signature error on request."
}
</pre><a href="#section-12.4-21" class="pilcrow">¶</a>
</div>
<p id="section-12.4-22">If an endpoint does <em>not</em> require authentication, <code>Authorization</code> headers are ignored entirely.<a href="#section-12.4-22" class="pilcrow">¶</a></p>
<p id="section-12.4-23">Responses from a server are authenticated using TLS and do not have additional signing requirements.<a href="#section-12.4-23" class="pilcrow">¶</a></p>
<div id="int-transport-get-server-keys">
<section id="section-12.4.1">
          <h4 id="name-retrieving-server-keys">
<a href="#section-12.4.1" class="section-number selfRef">12.4.1. </a><a href="#name-retrieving-server-keys" class="section-name selfRef">Retrieving Server Keys</a>
          </h4>
<p id="section-12.4.1-1"><strong>TODO</strong>: Explain what notaries are and what they do, if we keep this section at all.<a href="#section-12.4.1-1" class="pilcrow">¶</a></p>
<p id="section-12.4.1-2">A server's signing keys are published under <code>/_matrix/key/v2/server</code> (<a href="#int-api-self-key" class="auto internal xref">Section 12.4.1.2</a>) and can
be queried through notary servers in two ways: <a href="#int-api-notary-query" class="auto internal xref">Section 12.4.1.3</a> and <a href="#int-api-notary-query-bulk" class="auto internal xref">Section 12.4.1.4</a>.
Notary servers implicitly call <code>/_matrix/key/v2/server</code> when queried, signing and caching the response
for some time. This allows the target server to be offline without affecting their previously sent events.<a href="#section-12.4.1-2" class="pilcrow">¶</a></p>
<p id="section-12.4.1-3">The approach used here is borrowed from the Perspectives Project <span>[<a href="#PerspectivesProject" class="cite xref">PerspectivesProject</a>]</span>, modified to
cover the server's ed25519 keys and to use JSON instead of XML. The advantage of this system is it allows
each server to pick which notaries it trusts, and can contact multiple notaries to corroborate the keys
returned by any given notary.<a href="#section-12.4.1-3" class="pilcrow">¶</a></p>
<p id="section-12.4.1-4">Servers <span class="bcp14">SHOULD</span> attempt to contact the target server directly before using a notary server.<a href="#section-12.4.1-4" class="pilcrow">¶</a></p>
<p id="section-12.4.1-5">Note that these endpoints operate outside the context of a room: a server does not need to participate
in any shared rooms to be used as a notary by another server, and does not need to use the hub as a
notary.<a href="#section-12.4.1-5" class="pilcrow">¶</a></p>
<div id="int-transport-keys-validity">
<section id="section-12.4.1.1">
            <h5 id="name-validity">
<a href="#section-12.4.1.1" class="section-number selfRef">12.4.1.1. </a><a href="#name-validity" class="section-name selfRef">Validity</a>
            </h5>
<p id="section-12.4.1.1-1">A server's keys are only valid for a short time, denoted by <code>valid_until_ts</code>. Around the <code>valid_until_ts</code>
timestamp, a server would re-fetch the server's keys to discover any changes. In the vast majority of
cases, only <code>valid_until_ts</code> changes between requests (keys are long-lived, but validated frequently).<a href="#section-12.4.1.1-1" class="pilcrow">¶</a></p>
<p id="section-12.4.1.1-2"><code>valid_until_ts</code> <span class="bcp14">MUST</span> be handled as the lesser of <code>valid_until_ts</code> and 7 days into the future, preventing
attackers from publishing long-lived keys that are unable to be revoked. Servers <span class="bcp14">SHOULD</span> use a timestamp
approximately 12 hours into the future when responding with their keys.<a href="#section-12.4.1.1-2" class="pilcrow">¶</a></p>
<p id="section-12.4.1.1-3"><strong>TODO</strong>: What does it mean to require events have an <code>origin_server_ts</code> which is less than that of
<code>valid_until_ts</code>? Do we reject the event, soft-fail it, or do something else? Do we only do this on the
hub?<a href="#section-12.4.1.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-api-self-key">
<section id="section-12.4.1.2">
            <h5 id="name-get-_matrix-key-v2-server">
<a href="#section-12.4.1.2" class="section-number selfRef">12.4.1.2. </a><a href="#name-get-_matrix-key-v2-server" class="section-name selfRef"><code>GET /_matrix/key/v2/server</code></a>
            </h5>
<p id="section-12.4.1.2-1">Retrieves the server's signing keys. The server can have any number of active or inactive keys at a
time, but <span class="bcp14">SHOULD</span> have at least 1 active key at all times.<a href="#section-12.4.1.2-1" class="pilcrow">¶</a></p>
<p id="section-12.4.1.2-2"><strong>Rate-limited</strong>: No.<a href="#section-12.4.1.2-2" class="pilcrow">¶</a></p>
<p id="section-12.4.1.2-3"><strong>Authentication required</strong>: No.<a href="#section-12.4.1.2-3" class="pilcrow">¶</a></p>
<p id="section-12.4.1.2-4">This HTTP endpoint does not specify any request parameters or body.<a href="#section-12.4.1.2-4" class="pilcrow">¶</a></p>
<p id="section-12.4.1.2-5"><code>200 OK</code> response:<a href="#section-12.4.1.2-5" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.4.1.2-6">
<pre>
{
   "server_name": "example.org",
   "valid_until_ts": 1686776437176,
   "m.linearized": true,
   "verify_keys": {
      "ed25519:0": {
         "key": "&lt;unpadded base64 encoded public key&gt;"
      }
   },
   "old_verify_keys": {
      "ed25519:bad": {
         "expired_ts": 1586776437176,
         "key": "&lt;unpadded base64 encoded public key&gt;"
      }
   },
   "signatures": {
      "example.org": {
         "ed25519:0": "&lt;unpadded base64 encoded signature&gt;"
      }
   }
}
</pre><a href="#section-12.4.1.2-6" class="pilcrow">¶</a>
</div>
<p id="section-12.4.1.2-7"><code>server_name</code> <span class="bcp14">MUST</span> be the name of the server (<a href="#int-server-names" class="auto internal xref">Section 3.1</a>) which is returning the keys.<a href="#section-12.4.1.2-7" class="pilcrow">¶</a></p>
<p id="section-12.4.1.2-8"><code>valid_until_ts</code> is the integer timestamp (milliseconds since Unix epoch) for when the server's keys
should be re-fetched. See <a href="#int-transport-keys-validity" class="auto internal xref">Section 12.4.1.1</a>.<a href="#section-12.4.1.2-8" class="pilcrow">¶</a></p>
<p id="section-12.4.1.2-9"><code>m.linearized</code> is an optional boolean, but <span class="bcp14">SHOULD</span> be set to <code>true</code>. Semantics for <code>false</code> and not
being present apply to contexts outside of this document.<a href="#section-12.4.1.2-9" class="pilcrow">¶</a></p>
<p id="section-12.4.1.2-10"><code>verify_keys</code> are the current signing keys for the server, keyed by key ID (<a href="#int-signing" class="auto internal xref">Section 6</a>). The
object value for each key ID under <code>verify_keys</code> is simply the <code>key</code>, consisting of the unpadded
base64 encoded public key matching that algorithm and version.<a href="#section-12.4.1.2-10" class="pilcrow">¶</a></p>
<p id="section-12.4.1.2-11"><code>old_verify_keys</code> are similar to <code>verify_keys</code>, but have an additional required <code>expired_ts</code> property
to denote when the key ceased usage. This overrides <code>valid_until_ts</code> for the purposes of
<a href="#int-transport-keys-validity" class="auto internal xref">Section 12.4.1.1</a> at an individual key level.<a href="#section-12.4.1.2-11" class="pilcrow">¶</a></p>
<p id="section-12.4.1.2-12"><strong>TODO</strong>: What about events sent with <code>old_verify_keys</code>?<a href="#section-12.4.1.2-12" class="pilcrow">¶</a></p>
<p id="section-12.4.1.2-13">For request authentication (<a href="#int-transport-auth" class="auto internal xref">Section 12.4</a>), only keys listed under <code>verify_keys</code> are honoured.
If another key is referenced by the <code>Authorization</code> headers, the request fails authentication.<a href="#section-12.4.1.2-13" class="pilcrow">¶</a></p>
<p id="section-12.4.1.2-14">Notaries <span class="bcp14">SHOULD</span> cache a 200 OK response for half of its lifetime to avoid serving stale values.
Responding servers <span class="bcp14">SHOULD</span> avoid returning responses which expire in less than an hour to avoid
repeated requests. Requesting servers <span class="bcp14">SHOULD</span> limit how frequently they query for keys to avoid
flooding a server with requests.<a href="#section-12.4.1.2-14" class="pilcrow">¶</a></p>
<p id="section-12.4.1.2-15">If the server fails to respond to this request, notaries <span class="bcp14">SHOULD</span> continue to return the last response
they received from the server so that the signatures of old events can still be checked, even if that
response is no longer considered valid (<a href="#int-transport-keys-validity" class="auto internal xref">Section 12.4.1.1</a>).<a href="#section-12.4.1.2-15" class="pilcrow">¶</a></p>
<p id="section-12.4.1.2-16">Servers are capable of rotating their keys without populating <code>old_verify_keys</code>, though this can cause
reliability issues if other servers don't see both keys. Notaries <span class="bcp14">SHOULD</span> cache responses with distinct
key IDs indefinitely. For example, if a server has <code>ed25519:0</code> and <code>ed25519:1</code> on its first response,
and a later response returns <code>ed25519:1</code> and <code>ed25519:2</code>, the notary should cache both responses. This
gives servers an ability to validate <code>ed25519:0</code> for old events in a room.<a href="#section-12.4.1.2-16" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-api-notary-query">
<section id="section-12.4.1.3">
            <h5 id="name-get-_matrix-key-v2-query-se">
<a href="#section-12.4.1.3" class="section-number selfRef">12.4.1.3. </a><a href="#name-get-_matrix-key-v2-query-se" class="section-name selfRef"><code>GET /_matrix/key/v2/query/:serverName</code></a>
            </h5>
<p id="section-12.4.1.3-1">This is one of two endpoints for querying a server's keys through another server. The notary (receiving)
server will attempt to refresh its cached copy of the target server's keys through <code>/_matrix/key/v2/server</code>,
falling back to any cached values if needed.<a href="#section-12.4.1.3-1" class="pilcrow">¶</a></p>
<p id="section-12.4.1.3-2"><strong>Rate-limited</strong>: No.<a href="#section-12.4.1.3-2" class="pilcrow">¶</a></p>
<p id="section-12.4.1.3-3"><strong>Authentication required</strong>: No.<a href="#section-12.4.1.3-3" class="pilcrow">¶</a></p>
<p id="section-12.4.1.3-4">Path parameters:<a href="#section-12.4.1.3-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.4.1.3-5.1">
                <p id="section-12.4.1.3-5.1.1"><code>:serverName</code> - the target server's name (<a href="#int-server-names" class="auto internal xref">Section 3.1</a>) to retrieve keys for.<a href="#section-12.4.1.3-5.1.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-12.4.1.3-6">Query parameters:<a href="#section-12.4.1.3-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.4.1.3-7.1">
                <p id="section-12.4.1.3-7.1.1"><code>minimum_valid_until_ts</code> (integer; optional) - The time in milliseconds since the Unix epoch the
target server's keys will need to be valid until to be useful to the caller. If not specified the
notary server's current time will be used.<a href="#section-12.4.1.3-7.1.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-12.4.1.3-8">Request body: None applicable.<a href="#section-12.4.1.3-8" class="pilcrow">¶</a></p>
<p id="section-12.4.1.3-9"><code>200 OK</code> response:<a href="#section-12.4.1.3-9" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.4.1.3-10">
<pre>
{
   "server_keys": [
      {/* server key */}
   ]
}
</pre><a href="#section-12.4.1.3-10" class="pilcrow">¶</a>
</div>
<p id="section-12.4.1.3-11"><code>server_keys</code> is the array of keys (see <a href="#int-api-self-key" class="auto internal xref">Section 12.4.1.2</a> response format) for the target server.
If the target server could not be reached and the notary has no cached keys, this array is empty. If
the keys do not meet <code>minimum_valid_until_ts</code> per <a href="#int-transport-keys-validity" class="auto internal xref">Section 12.4.1.1</a>, they are not included.<a href="#section-12.4.1.3-11" class="pilcrow">¶</a></p>
<p id="section-12.4.1.3-12">The notary server <span class="bcp14">MUST</span> sign each key returned in <code>server_keys</code> by at least one of its own signing keys.
The calling server <span class="bcp14">MUST</span> validate all signatures on the objects.<a href="#section-12.4.1.3-12" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-api-notary-query-bulk">
<section id="section-12.4.1.4">
            <h5 id="name-post-_matrix-key-v2-query">
<a href="#section-12.4.1.4" class="section-number selfRef">12.4.1.4. </a><a href="#name-post-_matrix-key-v2-query" class="section-name selfRef"><code>POST /_matrix/key/v2/query</code></a>
            </h5>
<p id="section-12.4.1.4-1">A bulk version of <code>/_matrix/key/v2/query/:serverName</code> (<a href="#int-api-notary-query" class="auto internal xref">Section 12.4.1.3</a>). The same behaviour
applies to this endpoint.<a href="#section-12.4.1.4-1" class="pilcrow">¶</a></p>
<p id="section-12.4.1.4-2"><strong>Rate-limited</strong>: No.<a href="#section-12.4.1.4-2" class="pilcrow">¶</a></p>
<p id="section-12.4.1.4-3"><strong>Authentication required</strong>: No.<a href="#section-12.4.1.4-3" class="pilcrow">¶</a></p>
<p id="section-12.4.1.4-4">Path parameters: None applicable.<a href="#section-12.4.1.4-4" class="pilcrow">¶</a></p>
<p id="section-12.4.1.4-5">Query parameters: None applicable.<a href="#section-12.4.1.4-5" class="pilcrow">¶</a></p>
<p id="section-12.4.1.4-6">Request body:<a href="#section-12.4.1.4-6" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.4.1.4-7">
<pre>
{
   "server_keys": {
      "example.org": {
         "ed25519:0": {
            "minimum_valid_until_ts": 1686783382189
         }
      }
   }
}
</pre><a href="#section-12.4.1.4-7" class="pilcrow">¶</a>
</div>
<p id="section-12.4.1.4-8"><code>server_keys</code> is required and is the search criteria. The object value is first keyed by server name
which maps to another object keyed by Key ID, mapping to the specific criteria. If no key IDs are
given in the request, all of the server's known keys are queried. If no servers are given in the
request, the response <span class="bcp14">MUST</span> contain an empty <code>server_keys</code> array.<a href="#section-12.4.1.4-8" class="pilcrow">¶</a></p>
<p id="section-12.4.1.4-9"><code>minimum_valid_until_ts</code> holds the same meaning as in <a href="#int-api-notary-query" class="auto internal xref">Section 12.4.1.3</a>.<a href="#section-12.4.1.4-9" class="pilcrow">¶</a></p>
<p id="section-12.4.1.4-10"><code>200 OK</code> response:<a href="#section-12.4.1.4-10" class="pilcrow">¶</a></p>
<p id="section-12.4.1.4-11">Same as <a href="#int-api-notary-query" class="auto internal xref">Section 12.4.1.3</a> with the following added detail:<a href="#section-12.4.1.4-11" class="pilcrow">¶</a></p>
<p id="section-12.4.1.4-12">Responding servers <span class="bcp14">SHOULD</span> only return signed key objects for the key IDs requested by the caller, however
servers <span class="bcp14">MAY</span> respond with more keys than requested. The caller is expected to filter the response if
needed.<a href="#section-12.4.1.4-12" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="int-transport-send-events">
<section id="section-12.5">
        <h3 id="name-sending-events">
<a href="#section-12.5" class="section-number selfRef">12.5. </a><a href="#name-sending-events" class="section-name selfRef">Sending Events</a>
        </h3>
<p id="section-12.5-1">Events accepted into the room by a hub server must be sent to all other servers in that room. Similarly,
participant servers need a way to send partial events through the hub server, as mentioned by <a href="#int-lpdu" class="auto internal xref">Section 3.5.1</a>.<a href="#section-12.5-1" class="pilcrow">¶</a></p>
<p id="section-12.5-2">A single endpoint is used for all rooms on either server, and can contain both fully-formed PDUs
(<a href="#int-pdu" class="auto internal xref">Section 3.5</a>) or Linearized PDUs (partial events; <a href="#int-lpdu" class="auto internal xref">Section 3.5.1</a>) depending on the server's role in the
applicable room.<a href="#section-12.5-2" class="pilcrow">¶</a></p>
<p id="section-12.5-3">A typical event send path will be:<a href="#section-12.5-3" class="pilcrow">¶</a></p>
<div id="section-12.5-4">
          <div class="alignLeft art-svg artwork" id="section-12.5-4.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="432" width="504" viewBox="0 0 504 432" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
              <path d="M 8,32 L 8,64" fill="none" stroke="black"></path>
              <path d="M 32,72 L 32,296" fill="none" stroke="black"></path>
              <path d="M 32,312 L 32,416" fill="none" stroke="black"></path>
              <path d="M 56,32 L 56,64" fill="none" stroke="black"></path>
              <path d="M 176,240 L 176,272" fill="none" stroke="black"></path>
              <path d="M 192,32 L 192,64" fill="none" stroke="black"></path>
              <path d="M 256,72 L 256,288" fill="none" stroke="black"></path>
              <path d="M 256,320 L 256,392" fill="none" stroke="black"></path>
              <path d="M 320,32 L 320,64" fill="none" stroke="black"></path>
              <path d="M 352,112 L 352,144" fill="none" stroke="black"></path>
              <path d="M 368,32 L 368,64" fill="none" stroke="black"></path>
              <path d="M 432,72 L 432,296" fill="none" stroke="black"></path>
              <path d="M 432,312 L 432,416" fill="none" stroke="black"></path>
              <path d="M 496,32 L 496,64" fill="none" stroke="black"></path>
              <path d="M 8,32 L 56,32" fill="none" stroke="black"></path>
              <path d="M 192,32 L 320,32" fill="none" stroke="black"></path>
              <path d="M 368,32 L 496,32" fill="none" stroke="black"></path>
              <path d="M 8,64 L 56,64" fill="none" stroke="black"></path>
              <path d="M 192,64 L 320,64" fill="none" stroke="black"></path>
              <path d="M 368,64 L 496,64" fill="none" stroke="black"></path>
              <path d="M 256,112 L 352,112" fill="none" stroke="black"></path>
              <path d="M 264,144 L 352,144" fill="none" stroke="black"></path>
              <path d="M 40,192 L 256,192" fill="none" stroke="black"></path>
              <path d="M 32,240 L 176,240" fill="none" stroke="black"></path>
              <path d="M 40,272 L 176,272" fill="none" stroke="black"></path>
              <path d="M 8,304 L 136,304" fill="none" stroke="black"></path>
              <path d="M 368,304 L 496,304" fill="none" stroke="black"></path>
              <path d="M 32,352 L 248,352" fill="none" stroke="black"></path>
              <path d="M 32,400 L 424,400" fill="none" stroke="black"></path>
              <polygon class="arrowhead" points="432,400 420,394.4 420,405.6" fill="black" transform="rotate(0,424,400)"></polygon>
              <polygon class="arrowhead" points="272,144 260,138.4 260,149.6" fill="black" transform="rotate(180,264,144)"></polygon>
              <polygon class="arrowhead" points="256,352 244,346.4 244,357.6" fill="black" transform="rotate(0,248,352)"></polygon>
              <polygon class="arrowhead" points="48,272 36,266.4 36,277.6" fill="black" transform="rotate(180,40,272)"></polygon>
              <polygon class="arrowhead" points="48,192 36,186.4 36,197.6" fill="black" transform="rotate(180,40,192)"></polygon>
              <g class="text">
                <text x="32" y="52">Hub</text>
                <text x="252" y="52">Participant1</text>
                <text x="428" y="52">Participant2</text>
                <text x="292" y="100">Create</text>
                <text x="340" y="100">LPDU</text>
                <text x="128" y="180">PUT</text>
                <text x="196" y="180">/send/:txnId</text>
                <text x="68" y="228">Append</text>
                <text x="112" y="228">PDU</text>
                <text x="156" y="228">fields</text>
                <text x="188" y="308">Concurrent</text>
                <text x="268" y="308">requests</text>
                <text x="332" y="308">follow</text>
                <text x="56" y="340">PUT</text>
                <text x="124" y="340">/send/:txnId</text>
                <text x="56" y="388">PUT</text>
                <text x="124" y="388">/send/:txnId</text>
                <text x="256" y="420">|</text>
              </g>
            </svg><a href="#section-12.5-4.1" class="pilcrow">¶</a>
</div>
</div>
<p id="section-12.5-5"><code>PUT /send/:txnId</code> is shorthand for <a href="#int-api-send-txn" class="auto internal xref">Section 12.5.1</a>.<a href="#section-12.5-5" class="pilcrow">¶</a></p>
<p id="section-12.5-6">Hubs which generate events would skip to the point where they create a fully-formed PDU and send it
out to all other participants.<a href="#section-12.5-6" class="pilcrow">¶</a></p>
<p id="section-12.5-7">When a hub is broadcasting events to participant servers, it <span class="bcp14">MUST</span> include the following targets:<a href="#section-12.5-7" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.5-8.1">
            <p id="section-12.5-8.1.1">The server implied by the <code>sender</code> for a kick or ban <code>m.room.member</code> (<a href="#int-ev-member" class="auto internal xref">Section 3.5.3.3</a>) event, up
to the point of that kick or ban.<a href="#section-12.5-8.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-12.5-8.2">
            <p id="section-12.5-8.2.1">All servers which have at least 1 user which is joined to the room.<a href="#section-12.5-8.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<div id="int-api-send-txn">
<section id="section-12.5.1">
          <h4 id="name-put-_matrix-federation-v2-s">
<a href="#section-12.5.1" class="section-number selfRef">12.5.1. </a><a href="#name-put-_matrix-federation-v2-s" class="section-name selfRef"><code>PUT /_matrix/federation/v2/send/:txnId</code></a>
          </h4>
<p id="section-12.5.1-1">Sends (L)PDUs (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>, <a href="#int-lpdu" class="auto internal xref">Section 3.5.1</a>) to another server. The sending server <span class="bcp14">MUST</span> wait for a
<code>200 OK</code> response from the receiver before sending another request with a different <code>:txnId</code>.<a href="#section-12.5.1-1" class="pilcrow">¶</a></p>
<p id="section-12.5.1-2"><strong>Implementation note</strong>: Currently this endpoint doesn't actually exist. Use
<code>PUT /_matrix/federation/unstable/org.matrix.i-d.ralston-mimi-linearized-matrix.02/send/:txnId</code>
when testing against other Linearized Matrix implementations. This string may be updated later to
account for breaking changes.<a href="#section-12.5.1-2" class="pilcrow">¶</a></p>
<p id="section-12.5.1-3"><strong>TODO</strong>: Remove implementation notes.<a href="#section-12.5.1-3" class="pilcrow">¶</a></p>
<p id="section-12.5.1-4"><strong>Rate-limited</strong>: No.<a href="#section-12.5.1-4" class="pilcrow">¶</a></p>
<p id="section-12.5.1-5"><strong>Authentication required</strong>: Yes.<a href="#section-12.5.1-5" class="pilcrow">¶</a></p>
<p id="section-12.5.1-6">Path parameters:<a href="#section-12.5.1-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.5.1-7.1">
              <p id="section-12.5.1-7.1.1"><code>:txnId</code> - the transaction ID (<a href="#int-txn-ids" class="auto internal xref">Section 12.2.5</a>) for the request.<a href="#section-12.5.1-7.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-12.5.1-8">Query parameters: None applicable.<a href="#section-12.5.1-8" class="pilcrow">¶</a></p>
<p id="section-12.5.1-9">Request body:<a href="#section-12.5.1-9" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.5.1-10">
<pre>
{
   "edus": [
      {/* EDU */}
   ],
   "pdus": [
      {/* Either an LPDU or PDU */}
   ]
}
</pre><a href="#section-12.5.1-10" class="pilcrow">¶</a>
</div>
<p id="section-12.5.1-11"><code>edus</code> are the Ephemeral Data Units (<a href="#int-transport-edus" class="auto internal xref">Section 12.9</a>) to send. If no EDUs are being sent, this
field <span class="bcp14">MAY</span> be excluded from the request body. There <span class="bcp14">MUST NOT</span> be more than 100 entries in <code>edus</code>.<a href="#section-12.5.1-11" class="pilcrow">¶</a></p>
<p id="section-12.5.1-12"><code>pdus</code> are the events/PDUs (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>) and LPDUs (<a href="#int-lpdu" class="auto internal xref">Section 3.5.1</a>) to send to the server. Whether
it's an LPDU or PDU depends on the sending server's role in that room: if they are a non-hub server,
it will be an LPDU. There <span class="bcp14">MUST NOT</span> be more than 50 entries in <code>pdus</code>.<a href="#section-12.5.1-12" class="pilcrow">¶</a></p>
<p id="section-12.5.1-13">Each event in the <code>pdus</code> array gets processed as such:<a href="#section-12.5.1-13" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-12.5.1-14">
<li id="section-12.5.1-14.1">
              <p id="section-12.5.1-14.1.1">Identify the room ID for the event. The exact format of the event can differ between room versions,
however currently this would be done by extracting the <code>room_id</code> property.<a href="#section-12.5.1-14.1.1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-12.5.1-14.1.2">
<li id="section-12.5.1-14.1.2.1">
                  <p id="section-12.5.1-14.1.2.1.1">If that room ID is invalid/not found, the event is rejected.<a href="#section-12.5.1-14.1.2.1.1" class="pilcrow">¶</a></p>
</li>
                <li id="section-12.5.1-14.1.2.2">
                  <p id="section-12.5.1-14.1.2.2.1">If the server is not participating in the room, the event is dropped/skipped.<a href="#section-12.5.1-14.1.2.2.1" class="pilcrow">¶</a></p>
</li>
              </ol>
</li>
            <li id="section-12.5.1-14.2">
              <p id="section-12.5.1-14.2.1">If the event is an LPDU and the receiving server is the hub, the additional PDU fields are appended
before continuing.<a href="#section-12.5.1-14.2.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-12.5.1-14.3">
              <p id="section-12.5.1-14.3.1">If the event is an LPDU and the receiving server is not the hub, the event is dropped/skipped.<a href="#section-12.5.1-14.3.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-12.5.1-14.4">
              <p id="section-12.5.1-14.4.1">The checks defined by <a href="#int-receiving-events" class="auto internal xref">Section 5.1</a> are performed.<a href="#section-12.5.1-14.4.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-12.5.1-14.5">
              <p id="section-12.5.1-14.5.1">If the event still hasn't been dropped/rejected, it is appended to the room. For participant servers,
this may mean it's queued for sending to local clients.<a href="#section-12.5.1-14.5.1" class="pilcrow">¶</a></p>
</li>
          </ol>
<p id="section-12.5.1-15">Server implementation authors should note that these steps can be condensed, but are expanded here
for specification purposes. For example, an LPDU's signature can/will fail without ever needing to
append the PDU fields first - the server can skip some extra work this way.<a href="#section-12.5.1-15" class="pilcrow">¶</a></p>
<p id="section-12.5.1-16"><code>200 OK</code> response:<a href="#section-12.5.1-16" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.5.1-17">
<pre>
{
   "failed_pdus": {
      "$eventid": {
         "error": "Invalid event format"
      },
      "$eventid": {
         "error":
            "@alice:example.org cannot send m.room.power_levels"
      }
   }
}
</pre><a href="#section-12.5.1-17" class="pilcrow">¶</a>
</div>
<p id="section-12.5.1-18">The receiving server <span class="bcp14">MUST NOT</span> send a <code>200 OK</code> response until all events have been processed. Servers
<span class="bcp14">SHOULD NOT</span> block responding to this endpoint on sending accepted events to local clients or other
participant servers, as doing so could lead to a lengthy backlog of events waiting to be sent.<a href="#section-12.5.1-18" class="pilcrow">¶</a></p>
<p id="section-12.5.1-19">Sending servers <span class="bcp14">SHOULD</span> apply/expect a timeout and retry the exact same request with the same transaction
ID until they see a <code>200 OK</code> response. If the sending server attempts to send a different transaction
ID from the one already in flight, the receiving server <span class="bcp14">MUST</span> respond with a <code>400 Bad Request</code> HTTP
status code and <code>M_BAD_STATE</code> error code (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>). Receiving servers <span class="bcp14">SHOULD</span> continue
processing requests to this endpoint even after the sender has disconnected/timed out, but <span class="bcp14">SHOULD NOT</span>
process the request multiple times due to the transaction ID (<a href="#int-txn-ids" class="auto internal xref">Section 12.2.5</a>).<a href="#section-12.5.1-19" class="pilcrow">¶</a></p>
<p id="section-12.5.1-20"><code>failed_pdus</code> is an object mapping event ID (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>) to error string. Event IDs are based upon
the received object, not the final/complete object. For example, if an LPDU is sent, gets its PDU
fields appended, and fails event authorization, then the error would be for the event ID of the LPDU,
not the fully-formed PDU. This is to allow the sender to correlate what they sent with errors.<a href="#section-12.5.1-20" class="pilcrow">¶</a></p>
<p id="section-12.5.1-21">The object for each event ID <span class="bcp14">MUST</span> contain an <code>error</code> string field, representing the human-readable
reason for an event being rejected.<a href="#section-12.5.1-21" class="pilcrow">¶</a></p>
<p id="section-12.5.1-22">Events which are dropped/ignored or accepted do <em>not</em> appear in <code>failed_pdus</code>.<a href="#section-12.5.1-22" class="pilcrow">¶</a></p>
<p id="section-12.5.1-23"><strong>TODO</strong>: Should we also return fully-formed PDUs for the LPDUs we received?<a href="#section-12.5.1-23" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="event-and-state-apis">
<section id="section-12.6">
        <h3 id="name-event-and-state-apis">
<a href="#section-12.6" class="section-number selfRef">12.6. </a><a href="#name-event-and-state-apis" class="section-name selfRef">Event and State APIs</a>
        </h3>
<p id="section-12.6-1">When a participant in the room is missing an event, or otherwise needs a new copy of it, it can retrieve
that event from the hub server. Similar mechanics apply for getting state events, current state of a room,
and backfilling scrollback in a room.<a href="#section-12.6-1" class="pilcrow">¶</a></p>
<p id="section-12.6-2">All servers are required to implement all endpoints (<a href="#int-transport-requests-responses" class="auto internal xref">Section 12.2.1</a>), however
only hub servers are guaranteed to have the full history/state for a room. While other participant
servers might have history, they <span class="bcp14">SHOULD NOT</span> be contacted due to the high likelihood of a Not Found-style
error.<a href="#section-12.6-2" class="pilcrow">¶</a></p>
<div id="get-matrixfederationv2eventeventid">
<section id="section-12.6.1">
          <h4 id="name-get-_matrix-federation-v2-e">
<a href="#section-12.6.1" class="section-number selfRef">12.6.1. </a><a href="#name-get-_matrix-federation-v2-e" class="section-name selfRef"><code>GET /_matrix/federation/v2/event/:eventId</code></a>
          </h4>
<p id="section-12.6.1-1">Retrieves a single event.<a href="#section-12.6.1-1" class="pilcrow">¶</a></p>
<p id="section-12.6.1-2"><strong>Implementation note</strong>: Currently this endpoint doesn't actually exist. Use
<code>GET /_matrix/federation/unstable/org.matrix.i-d.ralston-mimi-linearized-matrix.02/event/:eventId</code>
when testing against other Linearized Matrix implementations. This string may be updated later to
account for breaking changes.<a href="#section-12.6.1-2" class="pilcrow">¶</a></p>
<p id="section-12.6.1-3"><strong>TODO</strong>: Remove implementation notes.<a href="#section-12.6.1-3" class="pilcrow">¶</a></p>
<p id="section-12.6.1-4"><strong>Rate-limited</strong>: Yes.<a href="#section-12.6.1-4" class="pilcrow">¶</a></p>
<p id="section-12.6.1-5"><strong>Authentication required</strong>: Yes.<a href="#section-12.6.1-5" class="pilcrow">¶</a></p>
<p id="section-12.6.1-6">Path parameters:<a href="#section-12.6.1-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.6.1-7.1">
              <p id="section-12.6.1-7.1.1"><code>:eventId</code> - the event ID (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>) to retrieve. Note that event IDs are typically reference
hashes (<a href="#int-reference-hashes" class="auto internal xref">Section 9.2</a>) of the event itself, which includes the room ID. This makes
event IDs globally unique.<a href="#section-12.6.1-7.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-12.6.1-8">Query parameters: None applicable.<a href="#section-12.6.1-8" class="pilcrow">¶</a></p>
<p id="section-12.6.1-9">Request body: None applicable.<a href="#section-12.6.1-9" class="pilcrow">¶</a></p>
<p id="section-12.6.1-10"><code>200 OK</code> response:<a href="#section-12.6.1-10" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.6.1-11">
<pre>
{
   /* the event */
}
</pre><a href="#section-12.6.1-11" class="pilcrow">¶</a>
</div>
<p id="section-12.6.1-12">The response body is simply the event (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>) itself, if the requesting server has reasonable
visibility of the event (<a href="#int-calc-event-visibility" class="auto internal xref">Section 3.5.3.5.1</a>). When the server can see an event but not the
contents, the event is served redacted (<a href="#int-redactions" class="auto internal xref">Section 8</a>) instead.<a href="#section-12.6.1-12" class="pilcrow">¶</a></p>
<p id="section-12.6.1-13">If the event isn't known to the server, or the requesting server has no reason to know that the event
even exists, a <code>404 Not Found</code> HTTP status code and <code>M_NOT_FOUND</code> error code (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>)
is returned.<a href="#section-12.6.1-13" class="pilcrow">¶</a></p>
<p id="section-12.6.1-14">The returned event <span class="bcp14">MUST</span> be checked before being used by the requesting server (<a href="#int-receiving-events" class="auto internal xref">Section 5.1</a>).
This endpoint <span class="bcp14">MUST NOT</span> return LPDUs (<a href="#int-lpdu" class="auto internal xref">Section 3.5.1</a>), instead treating such events as though they didn't
exist.<a href="#section-12.6.1-14" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-api-get-state">
<section id="section-12.6.2">
          <h4 id="name-get-_matrix-federation-v1-s">
<a href="#section-12.6.2" class="section-number selfRef">12.6.2. </a><a href="#name-get-_matrix-federation-v1-s" class="section-name selfRef"><code>GET /_matrix/federation/v1/state/:roomId</code></a>
          </h4>
<p id="section-12.6.2-1">Retrieves a snapshot of the room state (<a href="#int-state-events" class="auto internal xref">Section 3.5.2</a>) at the given event. This is typically
most useful when a participant server prefers to store minimal information about the room, but still
needs to offer context to its clients.<a href="#section-12.6.2-1" class="pilcrow">¶</a></p>
<p id="section-12.6.2-2"><strong>Rate-limited</strong>: Yes.<a href="#section-12.6.2-2" class="pilcrow">¶</a></p>
<p id="section-12.6.2-3"><strong>Authentication required</strong>: Yes.<a href="#section-12.6.2-3" class="pilcrow">¶</a></p>
<p id="section-12.6.2-4">Path parameters:<a href="#section-12.6.2-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.6.2-5.1">
              <p id="section-12.6.2-5.1.1"><code>:roomId</code> - the room ID (<a href="#int-room-id" class="auto internal xref">Section 3.2</a>) to retrieve state in.<a href="#section-12.6.2-5.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-12.6.2-6">Query parameters:<a href="#section-12.6.2-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.6.2-7.1">
              <p id="section-12.6.2-7.1.1"><code>event_id</code> (string; required) - The event ID (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>) to retrieve state at.<a href="#section-12.6.2-7.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-12.6.2-8">Request body: None applicable.<a href="#section-12.6.2-8" class="pilcrow">¶</a></p>
<p id="section-12.6.2-9"><code>200 OK</code> response:<a href="#section-12.6.2-9" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.6.2-10">
<pre>
{
   "auth_chain": [
      {/* event */}
   ],
   "pdus": [
      {/* event */}
   ]
}
</pre><a href="#section-12.6.2-10" class="pilcrow">¶</a>
</div>
<p id="section-12.6.2-11">The returned room state is in two parts: the <code>pdus</code>, consisting of the events which represent "current
state" (<a href="#int-state-events" class="auto internal xref">Section 3.5.2</a>) prior to considering state changes induced by the event in the original
request, and <code>auth_chain</code>, consisting of the events which make up the <code>auth_events</code> (<a href="#int-auth-selection" class="auto internal xref">Section 5.2.1</a>)
for the <code>pdus</code> and the <code>auth_events</code> of those events, recursively.<a href="#section-12.6.2-11" class="pilcrow">¶</a></p>
<p id="section-12.6.2-12">The <code>auth_chain</code> will eventually stop recursing when it reaches the <code>m.room.create</code> event, as it cannot
have any <code>auth_events</code>.<a href="#section-12.6.2-12" class="pilcrow">¶</a></p>
<p id="section-12.6.2-13"><strong>TODO</strong>: Do we actually need to recurse auth events to get the full auth chain here? What are participant
servers expected to do with this information? (Do they even care about it?)<a href="#section-12.6.2-13" class="pilcrow">¶</a></p>
<p id="section-12.6.2-14">For example, if the requested event ID was an <code>m.room.power_levels</code> event, the returned state would be
as if the new power levels were not applied.<a href="#section-12.6.2-14" class="pilcrow">¶</a></p>
<p id="section-12.6.2-15">Both <code>auth_chain</code> and <code>pdus</code> contain event objects (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>).<a href="#section-12.6.2-15" class="pilcrow">¶</a></p>
<p id="section-12.6.2-16">If the requesting server does not have reasonable visibility on the room (<a href="#int-calc-event-visibility" class="auto internal xref">Section 3.5.3.5.1</a>),
or either the room ID or event ID don't exist, a <code>404 Not Found</code> HTTP status code and <code>M_NOT_FOUND</code>
error code (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>) is returned. The same error is returned if the event ID doesn't
exist in the requested room ID.<a href="#section-12.6.2-16" class="pilcrow">¶</a></p>
<p id="section-12.6.2-17">Note that the requesting server will generally always have visibility of the <code>auth_chain</code> and <code>pdu</code>
events, but may not be able to see their contents. In this case, they are redacted (<a href="#int-redactions" class="auto internal xref">Section 8</a>)
before being served.<a href="#section-12.6.2-17" class="pilcrow">¶</a></p>
<p id="section-12.6.2-18">The returned events <span class="bcp14">MUST</span> be checked before being used by the requesting server (<a href="#int-receiving-events" class="auto internal xref">Section 5.1</a>).
This endpoint <span class="bcp14">MUST NOT</span> return LPDUs (<a href="#int-lpdu" class="auto internal xref">Section 3.5.1</a>), instead treating such events as though they didn't
exist.<a href="#section-12.6.2-18" class="pilcrow">¶</a></p>
<p id="section-12.6.2-19">If the receiving server is not the hub server for the room ID, an HTTP status code of <code>400 Bad Request</code>
and error code <code>M_WRONG_SERVER</code> (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>) is returned.<a href="#section-12.6.2-19" class="pilcrow">¶</a></p>
</section>
</div>
<div id="get-matrixfederationv1stateidsroomid">
<section id="section-12.6.3">
          <h4 id="name-get-_matrix-federation-v1-st">
<a href="#section-12.6.3" class="section-number selfRef">12.6.3. </a><a href="#name-get-_matrix-federation-v1-st" class="section-name selfRef"><code>GET /_matrix/federation/v1/state_ids/:roomId</code></a>
          </h4>
<p id="section-12.6.3-1">This performs the same function as <a href="#int-api-get-state" class="auto internal xref">Section 12.6.2</a> but returns just the event IDs instead.<a href="#section-12.6.3-1" class="pilcrow">¶</a></p>
<p id="section-12.6.3-2"><strong>Rate-limited</strong>: Yes.<a href="#section-12.6.3-2" class="pilcrow">¶</a></p>
<p id="section-12.6.3-3"><strong>Authentication required</strong>: Yes.<a href="#section-12.6.3-3" class="pilcrow">¶</a></p>
<p id="section-12.6.3-4">Path parameters:<a href="#section-12.6.3-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.6.3-5.1">
              <p id="section-12.6.3-5.1.1"><code>:roomId</code> - the room ID (<a href="#int-room-id" class="auto internal xref">Section 3.2</a>) to retrieve state in.<a href="#section-12.6.3-5.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-12.6.3-6">Query parameters:<a href="#section-12.6.3-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.6.3-7.1">
              <p id="section-12.6.3-7.1.1"><code>event_id</code> (string; required) - The event ID (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>) to retrieve state at.<a href="#section-12.6.3-7.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-12.6.3-8">Request body: None applicable.<a href="#section-12.6.3-8" class="pilcrow">¶</a></p>
<p id="section-12.6.3-9"><code>200 OK</code> response:<a href="#section-12.6.3-9" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.6.3-10">
<pre>
{
   "auth_chain_ids": ["$event1", "$event2"],
   "pdu_ids": ["$event3", "$event4"]
}
</pre><a href="#section-12.6.3-10" class="pilcrow">¶</a>
</div>
<p id="section-12.6.3-11">See <a href="#int-api-get-state" class="auto internal xref">Section 12.6.2</a> for behaviour. Note that <code>auth_chain</code> becomes <code>auth_chain_ids</code> when using
this endpoint, and <code>pdus</code> becomes <code>pdu_ids</code>.<a href="#section-12.6.3-11" class="pilcrow">¶</a></p>
</section>
</div>
<div id="get-matrixfederationv2backfillroomid">
<section id="section-12.6.4">
          <h4 id="name-get-_matrix-federation-v2-b">
<a href="#section-12.6.4" class="section-number selfRef">12.6.4. </a><a href="#name-get-_matrix-federation-v2-b" class="section-name selfRef"><code>GET /_matrix/federation/v2/backfill/:roomId</code></a>
          </h4>
<p id="section-12.6.4-1">Retrieves a sliding window history of previous events in a given room.<a href="#section-12.6.4-1" class="pilcrow">¶</a></p>
<p id="section-12.6.4-2"><strong>Implementation note</strong>: Currently this endpoint doesn't actually exist. Use
<code>GET /_matrix/federation/unstable/org.matrix.i-d.ralston-mimi-linearized-matrix.02/backfill/:roomId</code>
when testing against other Linearized Matrix implementations. This string may be updated later to
account for breaking changes.<a href="#section-12.6.4-2" class="pilcrow">¶</a></p>
<p id="section-12.6.4-3"><strong>TODO</strong>: Remove implementation notes.<a href="#section-12.6.4-3" class="pilcrow">¶</a></p>
<p id="section-12.6.4-4"><strong>Rate-limited</strong>: Yes.<a href="#section-12.6.4-4" class="pilcrow">¶</a></p>
<p id="section-12.6.4-5"><strong>Authentication required</strong>: Yes.<a href="#section-12.6.4-5" class="pilcrow">¶</a></p>
<p id="section-12.6.4-6">Path parameters:<a href="#section-12.6.4-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.6.4-7.1">
              <p id="section-12.6.4-7.1.1"><code>:roomId</code> - the room ID (<a href="#int-room-id" class="auto internal xref">Section 3.2</a>) to retrieve events from.<a href="#section-12.6.4-7.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-12.6.4-8">Query parameters:<a href="#section-12.6.4-8" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.6.4-9.1">
              <p id="section-12.6.4-9.1.1"><code>v</code> (string; required) - The event ID (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>) to start backfilling from.<a href="#section-12.6.4-9.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-12.6.4-9.2">
              <p id="section-12.6.4-9.2.1"><code>limit</code> (integer; required) - The maximum number of events to return, including <code>v</code>.<a href="#section-12.6.4-9.2.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-12.6.4-10">Request body: None applicable.<a href="#section-12.6.4-10" class="pilcrow">¶</a></p>
<p id="section-12.6.4-11"><code>200 OK</code> response:<a href="#section-12.6.4-11" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.6.4-12">
<pre>
{
   "pdus": [
      {/* event */}
   ]
}
</pre><a href="#section-12.6.4-12" class="pilcrow">¶</a>
</div>
<p id="section-12.6.4-13">The number of returned <code>pdus</code> <span class="bcp14">MUST NOT</span> exceed the <code>limit</code> provided by the caller. <code>limit</code> <span class="bcp14">SHOULD</span> have
a maximum value imposed by the receiving server. <code>pdus</code> contains the events (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>) preceeding
the requested event ID (<code>v</code>), including <code>v</code>. <code>pdus</code> is ordered from oldest to newest.<a href="#section-12.6.4-13" class="pilcrow">¶</a></p>
<p id="section-12.6.4-14">If the requesting server does not have reasonable visibility on the room (<a href="#int-calc-event-visibility" class="auto internal xref">Section 3.5.3.5.1</a>),
or either the room ID or event ID don't exist, a <code>404 Not Found</code> HTTP status code and <code>M_NOT_FOUND</code>
error code (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>) is returned. The same error is returned if the event ID doesn't
exist in the requested room ID.<a href="#section-12.6.4-14" class="pilcrow">¶</a></p>
<p id="section-12.6.4-15">If the requesting server does have visibility on the returned events, but not their contents, they
are redacted (<a href="#int-redactions" class="auto internal xref">Section 8</a>) before being served.<a href="#section-12.6.4-15" class="pilcrow">¶</a></p>
<p id="section-12.6.4-16">The returned events <span class="bcp14">MUST</span> be checked before being used by the requesting server (<a href="#int-receiving-events" class="auto internal xref">Section 5.1</a>).
This endpoint <span class="bcp14">MUST NOT</span> return LPDUs (<a href="#int-lpdu" class="auto internal xref">Section 3.5.1</a>), instead treating such events as though they didn't
exist.<a href="#section-12.6.4-16" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="int-transport-room-membership">
<section id="section-12.7">
        <h3 id="name-room-membership">
<a href="#section-12.7" class="section-number selfRef">12.7. </a><a href="#name-room-membership" class="section-name selfRef">Room Membership</a>
        </h3>
<p id="section-12.7-1">When a server is already participating in a room, it can simply send <code>m.room.member</code> (<a href="#int-ev-member" class="auto internal xref">Section 3.5.3.3</a>)
events with the <code>/send</code> API (<a href="#int-api-send-txn" class="auto internal xref">Section 12.5.1</a>) to other servers/the hub directly. When a server is
not already participating however, it needs to be welcomed in by the hub server.<a href="#section-12.7-1" class="pilcrow">¶</a></p>
<p id="section-12.7-2">A typical invite flow would be:<a href="#section-12.7-2" class="pilcrow">¶</a></p>
<div id="section-12.7-3">
          <div class="alignLeft art-svg artwork" id="section-12.7-3.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="720" width="584" viewBox="0 0 584 720" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
              <path d="M 8,32 L 8,64" fill="none" stroke="black"></path>
              <path d="M 64,72 L 64,408" fill="none" stroke="black"></path>
              <path d="M 64,424 L 64,704" fill="none" stroke="black"></path>
              <path d="M 120,32 L 120,64" fill="none" stroke="black"></path>
              <path d="M 232,32 L 232,64" fill="none" stroke="black"></path>
              <path d="M 256,72 L 256,400" fill="none" stroke="black"></path>
              <path d="M 256,432 L 256,704" fill="none" stroke="black"></path>
              <path d="M 272,256 L 272,288" fill="none" stroke="black"></path>
              <path d="M 280,32 L 280,64" fill="none" stroke="black"></path>
              <path d="M 296,560 L 296,592" fill="none" stroke="black"></path>
              <path d="M 392,32 L 392,64" fill="none" stroke="black"></path>
              <path d="M 456,72 L 456,408" fill="none" stroke="black"></path>
              <path d="M 456,424 L 456,704" fill="none" stroke="black"></path>
              <path d="M 520,32 L 520,64" fill="none" stroke="black"></path>
              <path d="M 8,32 L 120,32" fill="none" stroke="black"></path>
              <path d="M 232,32 L 280,32" fill="none" stroke="black"></path>
              <path d="M 392,32 L 520,32" fill="none" stroke="black"></path>
              <path d="M 8,64 L 120,64" fill="none" stroke="black"></path>
              <path d="M 232,64 L 280,64" fill="none" stroke="black"></path>
              <path d="M 392,64 L 520,64" fill="none" stroke="black"></path>
              <path d="M 64,112 L 248,112" fill="none" stroke="black"></path>
              <path d="M 256,160 L 448,160" fill="none" stroke="black"></path>
              <path d="M 272,256 L 456,256" fill="none" stroke="black"></path>
              <path d="M 272,288 L 448,288" fill="none" stroke="black"></path>
              <path d="M 264,336 L 456,336" fill="none" stroke="black"></path>
              <path d="M 72,384 L 256,384" fill="none" stroke="black"></path>
              <path d="M 8,416 L 160,416" fill="none" stroke="black"></path>
              <path d="M 416,416 L 576,416" fill="none" stroke="black"></path>
              <path d="M 264,464 L 456,464" fill="none" stroke="black"></path>
              <path d="M 256,512 L 448,512" fill="none" stroke="black"></path>
              <path d="M 296,560 L 456,560" fill="none" stroke="black"></path>
              <path d="M 296,592 L 448,592" fill="none" stroke="black"></path>
              <path d="M 264,640 L 456,640" fill="none" stroke="black"></path>
              <path d="M 256,688 L 448,688" fill="none" stroke="black"></path>
              <polygon class="arrowhead" points="456,688 444,682.4 444,693.6" fill="black" transform="rotate(0,448,688)"></polygon>
              <polygon class="arrowhead" points="456,592 444,586.4 444,597.6" fill="black" transform="rotate(0,448,592)"></polygon>
              <polygon class="arrowhead" points="456,512 444,506.4 444,517.6" fill="black" transform="rotate(0,448,512)"></polygon>
              <polygon class="arrowhead" points="456,288 444,282.4 444,293.6" fill="black" transform="rotate(0,448,288)"></polygon>
              <polygon class="arrowhead" points="456,160 444,154.4 444,165.6" fill="black" transform="rotate(0,448,160)"></polygon>
              <polygon class="arrowhead" points="272,640 260,634.4 260,645.6" fill="black" transform="rotate(180,264,640)"></polygon>
              <polygon class="arrowhead" points="272,464 260,458.4 260,469.6" fill="black" transform="rotate(180,264,464)"></polygon>
              <polygon class="arrowhead" points="272,336 260,330.4 260,341.6" fill="black" transform="rotate(180,264,336)"></polygon>
              <polygon class="arrowhead" points="256,112 244,106.4 244,117.6" fill="black" transform="rotate(0,248,112)"></polygon>
              <polygon class="arrowhead" points="80,384 68,378.4 68,389.6" fill="black" transform="rotate(180,72,384)"></polygon>
              <g class="text">
                <text x="64" y="52">Participant</text>
                <text x="256" y="52">Hub</text>
                <text x="452" y="52">TargetServer</text>
                <text x="92" y="100">POST</text>
                <text x="144" y="100">/invite</text>
                <text x="204" y="100">(LPDU)</text>
                <text x="284" y="148">POST</text>
                <text x="336" y="148">/invite</text>
                <text x="392" y="148">(PDU)</text>
                <text x="300" y="196">Decide</text>
                <text x="340" y="196">to</text>
                <text x="384" y="196">process</text>
                <text x="432" y="196">the</text>
                <text x="296" y="212">invite.</text>
                <text x="344" y="212">Can</text>
                <text x="388" y="212">reject</text>
                <text x="432" y="212">due</text>
                <text x="276" y="228">to</text>
                <text x="312" y="228">spam,</text>
                <text x="348" y="228">or</text>
                <text x="380" y="228">send</text>
                <text x="412" y="228">it</text>
                <text x="436" y="228">to</text>
                <text x="304" y="244">the</text>
                <text x="360" y="244">recipient</text>
                <text x="424" y="244">user.</text>
                <text x="316" y="324">Finish</text>
                <text x="364" y="324">POST</text>
                <text x="416" y="324">/invite</text>
                <text x="116" y="372">Finish</text>
                <text x="164" y="372">POST</text>
                <text x="216" y="372">/invite</text>
                <text x="188" y="420">User</text>
                <text x="240" y="420">decides</text>
                <text x="284" y="420">to</text>
                <text x="324" y="420">accept</text>
                <text x="380" y="420">invite</text>
                <text x="344" y="452">GET</text>
                <text x="404" y="452">/make_join</text>
                <text x="292" y="500">Finish</text>
                <text x="336" y="500">GET</text>
                <text x="396" y="500">/make_join</text>
                <text x="308" y="548">Fill</text>
                <text x="352" y="548">event</text>
                <text x="412" y="548">template</text>
                <text x="340" y="628">POST</text>
                <text x="404" y="628">/send_join</text>
                <text x="292" y="676">Finish</text>
                <text x="340" y="676">POST</text>
                <text x="404" y="676">/send_join</text>
              </g>
            </svg><a href="#section-12.7-3.1" class="pilcrow">¶</a>
</div>
</div>
<p id="section-12.7-4"><code>POST /invite</code> is shorthand for <a href="#int-api-invite" class="auto internal xref">Section 12.7.2.1</a>. Similarly, <code>GET /make_join</code> is <a href="#int-api-make-join" class="auto internal xref">Section 12.7.3.1</a>
and <code>POST /send_join</code> is <a href="#int-api-send-join" class="auto internal xref">Section 12.7.3.2</a>.<a href="#section-12.7-4" class="pilcrow">¶</a></p>
<p id="section-12.7-5">If the user decided to reject the invite, the TargetServer would use <code>GET /make_leave</code> (<a href="#int-api-make-leave" class="auto internal xref">Section 12.7.2.2.1</a>)
and <code>POST /send_leave</code> (<a href="#int-api-send-leave" class="auto internal xref">Section 12.7.2.2.2</a>) instead of make/send_join.<a href="#section-12.7-5" class="pilcrow">¶</a></p>
<div id="int-transport-make-and-send">
<section id="section-12.7.1">
          <h4 id="name-make-and-send-handshake">
<a href="#section-12.7.1" class="section-number selfRef">12.7.1. </a><a href="#name-make-and-send-handshake" class="section-name selfRef">Make and Send Handshake</a>
          </h4>
<p id="section-12.7.1-1">When a server is already participating in a room, it can use <code>m.room.member</code> (<a href="#int-ev-member" class="auto internal xref">Section 3.5.3.3</a>) events
and the <code>/send</code> API (<a href="#int-api-send-txn" class="auto internal xref">Section 12.5.1</a>) to directly change membership. When the server is not already
involved in the room, such as when being invited for the first time, the server needs to "make" an event
and "send" it through the hub server to append it to the room.<a href="#section-12.7.1-1" class="pilcrow">¶</a></p>
<p id="section-12.7.1-2">The different processes which use this handshake are:<a href="#section-12.7.1-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.7.1-3.1">
              <p id="section-12.7.1-3.1.1">Rejecting Invites (<a href="#int-transport-leaves" class="auto internal xref">Section 12.7.2.2</a>)<a href="#section-12.7.1-3.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-12.7.1-3.2">
              <p id="section-12.7.1-3.2.1">Joins (<a href="#int-transport-joins" class="auto internal xref">Section 12.7.3</a>)<a href="#section-12.7.1-3.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-12.7.1-3.3">
              <p id="section-12.7.1-3.3.1">Knocks (<a href="#int-transport-knocks" class="auto internal xref">Section 12.7.4</a>)<a href="#section-12.7.1-3.3.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-12.7.1-4">The "make" portion of the endpoints take the shape of <code>GET /_matrix/federation/v1/make_CHANGE/:roomId/:userId</code>,
where <code>CHANGE</code> is <code>leave</code>, <code>join</code>, or <code>knock</code> (respective to the list above). This endpoint will
return a partial LPDU (<a href="#int-lpdu" class="auto internal xref">Section 3.5.1</a>) which needs to be turned into a full LPDU and signed before being
sent using <code>POST /_matrix/federation/v3/send_CHANGE/:txnId</code>.<a href="#section-12.7.1-4" class="pilcrow">¶</a></p>
<p id="section-12.7.1-5">The flow for this handshake appears as such:<a href="#section-12.7.1-5" class="pilcrow">¶</a></p>
<div id="section-12.7.1-6">
            <div class="alignLeft art-svg artwork" id="section-12.7.1-6.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="656" width="568" viewBox="0 0 568 656" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 8,32 L 8,64" fill="none" stroke="black"></path>
                <path d="M 72,72 L 72,640" fill="none" stroke="black"></path>
                <path d="M 144,32 L 144,64" fill="none" stroke="black"></path>
                <path d="M 232,400 L 232,432" fill="none" stroke="black"></path>
                <path d="M 232,544 L 232,576" fill="none" stroke="black"></path>
                <path d="M 280,272 L 280,304" fill="none" stroke="black"></path>
                <path d="M 512,32 L 512,64" fill="none" stroke="black"></path>
                <path d="M 536,72 L 536,640" fill="none" stroke="black"></path>
                <path d="M 560,32 L 560,64" fill="none" stroke="black"></path>
                <path d="M 8,32 L 144,32" fill="none" stroke="black"></path>
                <path d="M 512,32 L 560,32" fill="none" stroke="black"></path>
                <path d="M 8,64 L 144,64" fill="none" stroke="black"></path>
                <path d="M 512,64 L 560,64" fill="none" stroke="black"></path>
                <path d="M 72,112 L 528,112" fill="none" stroke="black"></path>
                <path d="M 80,176 L 536,176" fill="none" stroke="black"></path>
                <path d="M 80,224 L 536,224" fill="none" stroke="black"></path>
                <path d="M 72,272 L 280,272" fill="none" stroke="black"></path>
                <path d="M 80,304 L 280,304" fill="none" stroke="black"></path>
                <path d="M 72,352 L 528,352" fill="none" stroke="black"></path>
                <path d="M 232,400 L 536,400" fill="none" stroke="black"></path>
                <path d="M 232,432 L 528,432" fill="none" stroke="black"></path>
                <path d="M 80,480 L 536,480" fill="none" stroke="black"></path>
                <path d="M 232,544 L 536,544" fill="none" stroke="black"></path>
                <path d="M 232,576 L 528,576" fill="none" stroke="black"></path>
                <path d="M 80,624 L 536,624" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="536,576 524,570.4 524,581.6" fill="black" transform="rotate(0,528,576)"></polygon>
                <polygon class="arrowhead" points="536,432 524,426.4 524,437.6" fill="black" transform="rotate(0,528,432)"></polygon>
                <polygon class="arrowhead" points="536,352 524,346.4 524,357.6" fill="black" transform="rotate(0,528,352)"></polygon>
                <polygon class="arrowhead" points="536,112 524,106.4 524,117.6" fill="black" transform="rotate(0,528,112)"></polygon>
                <polygon class="arrowhead" points="88,624 76,618.4 76,629.6" fill="black" transform="rotate(180,80,624)"></polygon>
                <polygon class="arrowhead" points="88,480 76,474.4 76,485.6" fill="black" transform="rotate(180,80,480)"></polygon>
                <polygon class="arrowhead" points="88,304 76,298.4 76,309.6" fill="black" transform="rotate(180,80,304)"></polygon>
                <polygon class="arrowhead" points="88,224 76,218.4 76,229.6" fill="black" transform="rotate(180,80,224)"></polygon>
                <polygon class="arrowhead" points="88,176 76,170.4 76,181.6" fill="black" transform="rotate(180,80,176)"></polygon>
                <g class="text">
                  <text x="76" y="52">ExternalServer</text>
                  <text x="536" y="52">Hub</text>
                  <text x="96" y="100">GET</text>
                  <text x="316" y="100">/_matrix/federation/v1/make_CHANGE/:roomId/:userId</text>
                  <text x="324" y="148">Reject</text>
                  <text x="364" y="148">if</text>
                  <text x="400" y="148">event</text>
                  <text x="452" y="148">future</text>
                  <text x="504" y="148">event</text>
                  <text x="272" y="164">would</text>
                  <text x="312" y="164">not</text>
                  <text x="340" y="164">be</text>
                  <text x="384" y="164">allowed</text>
                  <text x="428" y="164">by</text>
                  <text x="460" y="164">auth</text>
                  <text x="504" y="164">rules</text>
                  <text x="352" y="212">Respond</text>
                  <text x="404" y="212">with</text>
                  <text x="456" y="212">partial</text>
                  <text x="508" y="212">LPDU</text>
                  <text x="116" y="260">Populate</text>
                  <text x="172" y="260">LPDU</text>
                  <text x="208" y="260">and</text>
                  <text x="244" y="260">sign</text>
                  <text x="276" y="260">it</text>
                  <text x="100" y="340">POST</text>
                  <text x="288" y="340">/_matrix/federation/v3/send_CHANGE/:txnId</text>
                  <text x="260" y="388">Validate</text>
                  <text x="320" y="388">event</text>
                  <text x="360" y="388">and</text>
                  <text x="404" y="388">append</text>
                  <text x="444" y="388">to</text>
                  <text x="472" y="388">the</text>
                  <text x="508" y="388">room</text>
                  <text x="220" y="468">Reject</text>
                  <text x="260" y="468">if</text>
                  <text x="296" y="468">event</text>
                  <text x="336" y="468">not</text>
                  <text x="384" y="468">allowed</text>
                  <text x="428" y="468">by</text>
                  <text x="460" y="468">auth</text>
                  <text x="504" y="468">rules</text>
                  <text x="324" y="516">Send</text>
                  <text x="360" y="516">new</text>
                  <text x="400" y="516">event</text>
                  <text x="436" y="516">to</text>
                  <text x="464" y="516">all</text>
                  <text x="504" y="516">other</text>
                  <text x="316" y="532">participants</text>
                  <text x="380" y="532">in</text>
                  <text x="408" y="532">the</text>
                  <text x="444" y="532">room</text>
                  <text x="496" y="532">(async)</text>
                  <text x="488" y="612">200</text>
                  <text x="516" y="612">OK</text>
                </g>
              </svg><a href="#section-12.7.1-6.1" class="pilcrow">¶</a>
</div>
</div>
<p id="section-12.7.1-7">Note that the <code>send_CHANGE</code> step re-checks the event against the auth rules: any amount of time
could have passed between the <code>make_CHANGE</code> and <code>send_CHANGE</code> calls.<a href="#section-12.7.1-7" class="pilcrow">¶</a></p>
<p id="section-12.7.1-8"><strong>TODO</strong>: Describe how the external server is meant to find the hub. Invites work by (usually) trying
to contact the server which sent the invite, but knocking is a guess.<a href="#section-12.7.1-8" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-transport-invites">
<section id="section-12.7.2">
          <h4 id="name-invites">
<a href="#section-12.7.2" class="section-number selfRef">12.7.2. </a><a href="#name-invites" class="section-name selfRef">Invites</a>
          </h4>
<p id="section-12.7.2-1">When inviting a user belonging to a server already in the room, senders <span class="bcp14">SHOULD</span> use <code>m.room.member</code>
(<a href="#int-ev-member" class="auto internal xref">Section 3.5.3.3</a>) events and the <code>/send</code> API (<a href="#int-api-send-txn" class="auto internal xref">Section 12.5.1</a>). This section's endpoints <span class="bcp14">SHOULD</span>
only be used when the target server is <em>not</em> participating in the room already.<a href="#section-12.7.2-1" class="pilcrow">¶</a></p>
<p id="section-12.7.2-2">Note that being invited does not count as the server "participating" in the room. This can mean that
while a server has a user with a pending invite in the room, this section's endpoints are needed to
send additional invites to other users on the same server.<a href="#section-12.7.2-2" class="pilcrow">¶</a></p>
<p id="section-12.7.2-3">The full invite sequence is:<a href="#section-12.7.2-3" class="pilcrow">¶</a></p>
<div id="section-12.7.2-4">
            <div class="alignLeft art-svg artwork" id="section-12.7.2-4.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="784" width="520" viewBox="0 0 520 784" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 8,32 L 8,64" fill="none" stroke="black"></path>
                <path d="M 64,72 L 64,768" fill="none" stroke="black"></path>
                <path d="M 120,32 L 120,64" fill="none" stroke="black"></path>
                <path d="M 224,32 L 224,64" fill="none" stroke="black"></path>
                <path d="M 248,72 L 248,768" fill="none" stroke="black"></path>
                <path d="M 272,32 L 272,64" fill="none" stroke="black"></path>
                <path d="M 272,624 L 272,656" fill="none" stroke="black"></path>
                <path d="M 384,32 L 384,64" fill="none" stroke="black"></path>
                <path d="M 400,256 L 400,288" fill="none" stroke="black"></path>
                <path d="M 448,72 L 448,768" fill="none" stroke="black"></path>
                <path d="M 512,32 L 512,64" fill="none" stroke="black"></path>
                <path d="M 8,32 L 120,32" fill="none" stroke="black"></path>
                <path d="M 224,32 L 272,32" fill="none" stroke="black"></path>
                <path d="M 384,32 L 512,32" fill="none" stroke="black"></path>
                <path d="M 8,64 L 120,64" fill="none" stroke="black"></path>
                <path d="M 224,64 L 272,64" fill="none" stroke="black"></path>
                <path d="M 384,64 L 512,64" fill="none" stroke="black"></path>
                <path d="M 64,112 L 240,112" fill="none" stroke="black"></path>
                <path d="M 72,192 L 248,192" fill="none" stroke="black"></path>
                <path d="M 248,256 L 400,256" fill="none" stroke="black"></path>
                <path d="M 256,288 L 400,288" fill="none" stroke="black"></path>
                <path d="M 248,336 L 440,336" fill="none" stroke="black"></path>
                <path d="M 256,400 L 448,400" fill="none" stroke="black"></path>
                <path d="M 256,480 L 448,480" fill="none" stroke="black"></path>
                <path d="M 72,544 L 248,544" fill="none" stroke="black"></path>
                <path d="M 272,624 L 448,624" fill="none" stroke="black"></path>
                <path d="M 272,656 L 440,656" fill="none" stroke="black"></path>
                <path d="M 256,704 L 448,704" fill="none" stroke="black"></path>
                <path d="M 72,752 L 248,752" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="448,656 436,650.4 436,661.6" fill="black" transform="rotate(0,440,656)"></polygon>
                <polygon class="arrowhead" points="448,336 436,330.4 436,341.6" fill="black" transform="rotate(0,440,336)"></polygon>
                <polygon class="arrowhead" points="264,704 252,698.4 252,709.6" fill="black" transform="rotate(180,256,704)"></polygon>
                <polygon class="arrowhead" points="264,480 252,474.4 252,485.6" fill="black" transform="rotate(180,256,480)"></polygon>
                <polygon class="arrowhead" points="264,400 252,394.4 252,405.6" fill="black" transform="rotate(180,256,400)"></polygon>
                <polygon class="arrowhead" points="264,288 252,282.4 252,293.6" fill="black" transform="rotate(180,256,288)"></polygon>
                <polygon class="arrowhead" points="248,112 236,106.4 236,117.6" fill="black" transform="rotate(0,240,112)"></polygon>
                <polygon class="arrowhead" points="80,752 68,746.4 68,757.6" fill="black" transform="rotate(180,72,752)"></polygon>
                <polygon class="arrowhead" points="80,544 68,538.4 68,549.6" fill="black" transform="rotate(180,72,544)"></polygon>
                <polygon class="arrowhead" points="80,192 68,186.4 68,197.6" fill="black" transform="rotate(180,72,192)"></polygon>
                <g class="text">
                  <text x="64" y="52">Participant</text>
                  <text x="248" y="52">Hub</text>
                  <text x="444" y="52">TargetServer</text>
                  <text x="92" y="100">POST</text>
                  <text x="144" y="100">/invite</text>
                  <text x="132" y="148">Reject</text>
                  <text x="172" y="148">if</text>
                  <text x="212" y="148">sender</text>
                  <text x="108" y="164">cannot</text>
                  <text x="164" y="164">invite</text>
                  <text x="216" y="164">other</text>
                  <text x="216" y="180">users</text>
                  <text x="300" y="228">Otherwise,</text>
                  <text x="372" y="228">append</text>
                  <text x="272" y="244">PDU</text>
                  <text x="316" y="244">fields</text>
                  <text x="276" y="324">POST</text>
                  <text x="328" y="324">/invite</text>
                  <text x="348" y="372">Reject</text>
                  <text x="388" y="372">if</text>
                  <text x="420" y="372">room</text>
                  <text x="296" y="388">version</text>
                  <text x="344" y="388">not</text>
                  <text x="400" y="388">supported</text>
                  <text x="292" y="436">Reject</text>
                  <text x="332" y="436">if</text>
                  <text x="372" y="436">target</text>
                  <text x="420" y="436">user</text>
                  <text x="308" y="452">is</text>
                  <text x="364" y="452">ineligible</text>
                  <text x="424" y="452">for</text>
                  <text x="408" y="468">invites</text>
                  <text x="112" y="516">Proxy</text>
                  <text x="188" y="516">TargetServer</text>
                  <text x="200" y="532">rejection</text>
                  <text x="348" y="580">Otherwise,</text>
                  <text x="416" y="580">queue</text>
                  <text x="296" y="596">sending</text>
                  <text x="344" y="596">the</text>
                  <text x="388" y="596">invite</text>
                  <text x="428" y="596">to</text>
                  <text x="372" y="612">target</text>
                  <text x="420" y="612">user</text>
                  <text x="400" y="692">200</text>
                  <text x="428" y="692">OK</text>
                  <text x="200" y="740">200</text>
                  <text x="228" y="740">OK</text>
                </g>
              </svg><a href="#section-12.7.2-4.1" class="pilcrow">¶</a>
</div>
</div>
<p id="section-12.7.2-5"><code>POST /invite</code> is shorthand for <a href="#int-api-invite" class="auto internal xref">Section 12.7.2.1</a>.<a href="#section-12.7.2-5" class="pilcrow">¶</a></p>
<p id="section-12.7.2-6">What causes a user to be considered "ineligible" for an invite is left as an implementation detail.
See <a href="#int-user-privacy" class="auto internal xref">Section 13</a> and <a href="#int-spam" class="auto internal xref">Section 14</a> for suggestions on handling user-level privacy controls and
spam invites.<a href="#section-12.7.2-6" class="pilcrow">¶</a></p>
<div id="int-api-invite">
<section id="section-12.7.2.1">
            <h5 id="name-post-_matrix-federation-v3-">
<a href="#section-12.7.2.1" class="section-number selfRef">12.7.2.1. </a><a href="#name-post-_matrix-federation-v3-" class="section-name selfRef"><code>POST /_matrix/federation/v3/invite/:txnId</code></a>
            </h5>
<p id="section-12.7.2.1-1">Sends an invite event to a server. If the sender is a participant server, the receiving server (the
hub) will convert the contained LPDU (<a href="#int-lpdu" class="auto internal xref">Section 3.5.1</a>) to a fully-formed event (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>) before sending
that event to the intended server.<a href="#section-12.7.2.1-1" class="pilcrow">¶</a></p>
<p id="section-12.7.2.1-2"><strong>Implementation note</strong>: Currently this endpoint doesn't actually exist. Use
<code>POST /_matrix/federation/unstable/org.matrix.i-d.ralston-mimi-linearized-matrix.02/invite/:txnId</code>
when testing against other Linearized Matrix implementations. This string may be updated later to
account for breaking changes.<a href="#section-12.7.2.1-2" class="pilcrow">¶</a></p>
<p id="section-12.7.2.1-3"><strong>TODO</strong>: Remove implementation notes.<a href="#section-12.7.2.1-3" class="pilcrow">¶</a></p>
<p id="section-12.7.2.1-4"><strong>Rate-limited</strong>: Yes.<a href="#section-12.7.2.1-4" class="pilcrow">¶</a></p>
<p id="section-12.7.2.1-5"><strong>Authentication required</strong>: Yes.<a href="#section-12.7.2.1-5" class="pilcrow">¶</a></p>
<p id="section-12.7.2.1-6">Path parameters:<a href="#section-12.7.2.1-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.7.2.1-7.1">
                <p id="section-12.7.2.1-7.1.1"><code>:txnId</code> - the transaction ID (<a href="#int-txn-ids" class="auto internal xref">Section 12.2.5</a>) for the request. The event ID (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>) of the
contained event may be a good option as a readily-available transaction ID.<a href="#section-12.7.2.1-7.1.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-12.7.2.1-8">Query parameters: None applicable.<a href="#section-12.7.2.1-8" class="pilcrow">¶</a></p>
<p id="section-12.7.2.1-9">Request body:<a href="#section-12.7.2.1-9" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.7.2.1-10">
<pre>
{
   "event": {/* the event */},
   "invite_room_state": [/* stripped state events */],
   "room_version": "I.1"
}
</pre><a href="#section-12.7.2.1-10" class="pilcrow">¶</a>
</div>
<p id="section-12.7.2.1-11"><code>invite_room_state</code> are the stripped state events (<a href="#int-stripped-state" class="auto internal xref">Section 3.5.2.1</a>) for the room's current
state. <code>invite_room_state</code> <span class="bcp14">MAY</span> be excluded from the request body.<a href="#section-12.7.2.1-11" class="pilcrow">¶</a></p>
<p id="section-12.7.2.1-12"><code>room_version</code> is the room version identifier (<a href="#int-room-versions" class="auto internal xref">Section 3.2.1</a>) the room is currently using. This
will be retrieved from the <code>m.room.create</code> (<a href="#int-ev-create" class="auto internal xref">Section 3.5.3.1</a>) state event.<a href="#section-12.7.2.1-12" class="pilcrow">¶</a></p>
<p id="section-12.7.2.1-13"><code>event</code> is the event (LPDU or PDU; <a href="#int-pdu" class="auto internal xref">Section 3.5</a>) representing the invite for the user. It <span class="bcp14">MUST</span> meet
the following criteria, in addition to the requirements of an event:<a href="#section-12.7.2.1-13" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.7.2.1-14.1">
                <p id="section-12.7.2.1-14.1.1"><code>type</code> <span class="bcp14">MUST</span> be <code>m.room.member</code>.<a href="#section-12.7.2.1-14.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-12.7.2.1-14.2">
                <p id="section-12.7.2.1-14.2.1"><code>membership</code> in <code>content</code> <span class="bcp14">MUST</span> be <code>invite</code>.<a href="#section-12.7.2.1-14.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-12.7.2.1-15">When the hub server receives a request from a participant server, it <span class="bcp14">MUST</span> populate the event fields
before sending the event to the intended recipient. This means running the event through the normal
event authorization steps (<a href="#int-auth-rules" class="auto internal xref">Section 5.2</a>). If the invite is not allowed under the auth rules,
the server responds with a <code>403 Forbidden</code> HTTP status code and <code>M_FORBIDDEN</code> error code (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>).<a href="#section-12.7.2.1-15" class="pilcrow">¶</a></p>
<p id="section-12.7.2.1-16">The intended recipient of the invite can be identified by the <code>state_key</code> on the event.<a href="#section-12.7.2.1-16" class="pilcrow">¶</a></p>
<p id="section-12.7.2.1-17">If the invite event is valid, the hub server sends its own <code>POST /_matrix/federation/v3/invite/:txnId</code>
request to the target server (if the target server is not itself) with the fully-formed event. The
transaction ID does not need to be the same as the original inbound request.<a href="#section-12.7.2.1-17" class="pilcrow">¶</a></p>
<p id="section-12.7.2.1-18">All responses from the target server <span class="bcp14">SHOULD</span> be proxied verbatim to the original requesting server
through the hub. The hub <span class="bcp14">SHOULD</span> discard what appears to be excess data before sending a response
to the requesting server, such as extra or large fields. If the target server does not respond with
JSON, an error response (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>) <span class="bcp14">SHOULD</span> be sent by the hub instead.<a href="#section-12.7.2.1-18" class="pilcrow">¶</a></p>
<p id="section-12.7.2.1-19">The target server then ensures it can support the room version. If it can't, it responds with an HTTP
status code of <code>400 Bad Request</code> and error code of <code>M_INCOMPATIBLE_ROOM_VERSION</code> (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>).<a href="#section-12.7.2.1-19" class="pilcrow">¶</a></p>
<p id="section-12.7.2.1-20">Then, the target server runs any implementation-specific checks as needed, such as those implied by
<a href="#int-user-privacy" class="auto internal xref">Section 13</a> and <a href="#int-spam" class="auto internal xref">Section 14</a>, rejecting/erroring the request as needed.<a href="#section-12.7.2.1-20" class="pilcrow">¶</a></p>
<p id="section-12.7.2.1-21">Finally, the target server signs the event and returns it to the hub. The hub server appends this signed
event to the room and sends it out to all participants in the room. The signed event is additionally
returned to the originating participant server, though it also receives the event through the <code>/send</code>
API (<a href="#int-api-send-txn" class="auto internal xref">Section 12.5.1</a>).<a href="#section-12.7.2.1-21" class="pilcrow">¶</a></p>
<p id="section-12.7.2.1-22"><code>200 OK</code> response:<a href="#section-12.7.2.1-22" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.7.2.1-23">
<pre>
{
   "pdu": {/* signed fully-formed event */}
}
</pre><a href="#section-12.7.2.1-23" class="pilcrow">¶</a>
</div>
<p id="section-12.7.2.1-24">Note that by the time a response is received, the event is signed 2-3 times:<a href="#section-12.7.2.1-24" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-12.7.2.1-25">
<li id="section-12.7.2.1-25.1">
                <p id="section-12.7.2.1-25.1.1">The LPDU signature from the participant server (<a href="#int-lpdu" class="auto internal xref">Section 3.5.1</a>).<a href="#section-12.7.2.1-25.1.1" class="pilcrow">¶</a></p>
</li>
              <li id="section-12.7.2.1-25.2">
                <p id="section-12.7.2.1-25.2.1">The hub's signature on the PDU (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>).<a href="#section-12.7.2.1-25.2.1" class="pilcrow">¶</a></p>
</li>
              <li id="section-12.7.2.1-25.3">
                <p id="section-12.7.2.1-25.3.1">The target server's signature on the PDU.<a href="#section-12.7.2.1-25.3.1" class="pilcrow">¶</a></p>
</li>
            </ol>
<p id="section-12.7.2.1-26">These signatures are to satisfy the auth rules (<a href="#int-auth-rules" class="auto internal xref">Section 5.2</a>).<a href="#section-12.7.2.1-26" class="pilcrow">¶</a></p>
<p id="section-12.7.2.1-27"><strong>TODO</strong>: Do we ever validate the target server's signature? Do we need to?<a href="#section-12.7.2.1-27" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-transport-leaves">
<section id="section-12.7.2.2">
            <h5 id="name-rejecting-invites-and-leave">
<a href="#section-12.7.2.2" class="section-number selfRef">12.7.2.2. </a><a href="#name-rejecting-invites-and-leave" class="section-name selfRef">Rejecting Invites and Leaves</a>
            </h5>
<p id="section-12.7.2.2-1">Rejecting an invite is done by making a membership transition of <code>invite</code> to <code>leave</code> through the user's
<code>m.room.member</code> (<a href="#int-ev-member" class="auto internal xref">Section 3.5.3.3</a>) event. The membership event <span class="bcp14">SHOULD</span> be sent directly when it can and
use the "make and send" handshake (<a href="#int-transport-make-and-send" class="auto internal xref">Section 12.7.1</a>) described here otherwise.<a href="#section-12.7.2.2-1" class="pilcrow">¶</a></p>
<p id="section-12.7.2.2-2">This same approach is additionally used to retract a knock (<a href="#int-transport-knocks" class="auto internal xref">Section 12.7.4</a>).<a href="#section-12.7.2.2-2" class="pilcrow">¶</a></p>
<div id="int-api-make-leave">
<section id="section-12.7.2.2.1">
              <h6 id="name-get-_matrix-federation-v1-m">
<a href="#section-12.7.2.2.1" class="section-number selfRef">12.7.2.2.1. </a><a href="#name-get-_matrix-federation-v1-m" class="section-name selfRef"><code>GET /_matrix/federation/v1/make_leave/:roomId/:userId</code></a>
              </h6>
<p id="section-12.7.2.2.1-1">Requests an event template from the hub server for a room. The requesting server will have already
been checked to ensure it supports the room version as part of the invite process prior to making a
call to this endpoint.<a href="#section-12.7.2.2.1-1" class="pilcrow">¶</a></p>
<p id="section-12.7.2.2.1-2"><strong>Rate-limited</strong>: Yes.<a href="#section-12.7.2.2.1-2" class="pilcrow">¶</a></p>
<p id="section-12.7.2.2.1-3"><strong>Authentication required</strong>: Yes.<a href="#section-12.7.2.2.1-3" class="pilcrow">¶</a></p>
<p id="section-12.7.2.2.1-4">Path parameters:<a href="#section-12.7.2.2.1-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.7.2.2.1-5.1">
                  <p id="section-12.7.2.2.1-5.1.1"><code>:roomId</code> - the room ID (<a href="#int-room-id" class="auto internal xref">Section 3.2</a>) to get a template for.<a href="#section-12.7.2.2.1-5.1.1" class="pilcrow">¶</a></p>
</li>
                <li class="normal" id="section-12.7.2.2.1-5.2">
                  <p id="section-12.7.2.2.1-5.2.1"><code>:userId</code> - the user ID (<a href="#int-user-id" class="auto internal xref">Section 3.3</a>) attempting to leave.<a href="#section-12.7.2.2.1-5.2.1" class="pilcrow">¶</a></p>
</li>
              </ul>
<p id="section-12.7.2.2.1-6">Query parameters: None applicable.<a href="#section-12.7.2.2.1-6" class="pilcrow">¶</a></p>
<p id="section-12.7.2.2.1-7">Request body: None applicable.<a href="#section-12.7.2.2.1-7" class="pilcrow">¶</a></p>
<p id="section-12.7.2.2.1-8"><code>200 OK</code> response:<a href="#section-12.7.2.2.1-8" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.7.2.2.1-9">
<pre>
{
   "event": {/* partial LPDU */},
   "room_version": "I.1"
}
</pre><a href="#section-12.7.2.2.1-9" class="pilcrow">¶</a>
</div>
<p id="section-12.7.2.2.1-10">The response body's <code>event</code> <span class="bcp14">MUST</span> be a partial LPDU (<a href="#int-lpdu" class="auto internal xref">Section 3.5.1</a>) with at least the following fields:<a href="#section-12.7.2.2.1-10" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.7.2.2.1-11.1">
                  <p id="section-12.7.2.2.1-11.1.1"><code>type</code> of <code>m.room.member</code>.<a href="#section-12.7.2.2.1-11.1.1" class="pilcrow">¶</a></p>
</li>
                <li class="normal" id="section-12.7.2.2.1-11.2">
                  <p id="section-12.7.2.2.1-11.2.1"><code>state_key</code> of <code>:userId</code> from the path parameters.<a href="#section-12.7.2.2.1-11.2.1" class="pilcrow">¶</a></p>
</li>
                <li class="normal" id="section-12.7.2.2.1-11.3">
                  <p id="section-12.7.2.2.1-11.3.1"><code>sender</code> of <code>:userId</code> from the path parameters.<a href="#section-12.7.2.2.1-11.3.1" class="pilcrow">¶</a></p>
</li>
                <li class="normal" id="section-12.7.2.2.1-11.4">
                  <p id="section-12.7.2.2.1-11.4.1"><code>content</code> of <code>{"membership": "leave"}</code>.<a href="#section-12.7.2.2.1-11.4.1" class="pilcrow">¶</a></p>
</li>
              </ul>
<p id="section-12.7.2.2.1-12">The sending server <span class="bcp14">SHOULD</span> remove all other fields before using the event in a <code>send_leave</code> (<a href="#int-api-send-leave" class="auto internal xref">Section 12.7.2.2.2</a>).<a href="#section-12.7.2.2.1-12" class="pilcrow">¶</a></p>
<p id="section-12.7.2.2.1-13">If the receiving server is not the hub server for the room ID, an HTTP status code of <code>400 Bad Request</code>
and error code <code>M_WRONG_SERVER</code> (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>) is returned. If the room ID is not known,
<code>404 Not Found</code> is used as an HTTP status code and <code>M_NOT_FOUND</code> as an error code (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>).<a href="#section-12.7.2.2.1-13" class="pilcrow">¶</a></p>
<p id="section-12.7.2.2.1-14">If the user does not have permission to leave under the auth rules (<a href="#int-auth-rules" class="auto internal xref">Section 5.2</a>), a <code>403 Forbidden</code>
HTTP status code is returned alongside an error code of <code>M_FORBIDDEN</code> (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>). For example,
if the user does not have a pending invite, is not a member of the room, or is banned.<a href="#section-12.7.2.2.1-14" class="pilcrow">¶</a></p>
<p id="section-12.7.2.2.1-15">If the sending server does not recognize the returned <code>room_version</code>, it <span class="bcp14">SHOULD NOT</span> attempt to populate
the template or use the <code>send_leave</code> (<a href="#int-api-send-leave" class="auto internal xref">Section 12.7.2.2.2</a>) endpoint.<a href="#section-12.7.2.2.1-15" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-api-send-leave">
<section id="section-12.7.2.2.2">
              <h6 id="name-post-_matrix-federation-v3-s">
<a href="#section-12.7.2.2.2" class="section-number selfRef">12.7.2.2.2. </a><a href="#name-post-_matrix-federation-v3-s" class="section-name selfRef"><code>POST /_matrix/federation/v3/send_leave/:txnId</code></a>
              </h6>
<p id="section-12.7.2.2.2-1">Sends a leave membership event to the room through a hub server.<a href="#section-12.7.2.2.2-1" class="pilcrow">¶</a></p>
<p id="section-12.7.2.2.2-2"><strong>Implementation note</strong>: Currently this endpoint doesn't actually exist. Use
<code>POST /_matrix/federation/unstable/org.matrix.i-d.ralston-mimi-linearized-matrix.02/send_leave/:txnId</code>
when testing against other Linearized Matrix implementations. This string may be updated later to
account for breaking changes.<a href="#section-12.7.2.2.2-2" class="pilcrow">¶</a></p>
<p id="section-12.7.2.2.2-3"><strong>TODO</strong>: Remove implementation notes.<a href="#section-12.7.2.2.2-3" class="pilcrow">¶</a></p>
<p id="section-12.7.2.2.2-4"><strong>Rate-limited</strong>: Yes.<a href="#section-12.7.2.2.2-4" class="pilcrow">¶</a></p>
<p id="section-12.7.2.2.2-5"><strong>Authentication required</strong>: Yes.<a href="#section-12.7.2.2.2-5" class="pilcrow">¶</a></p>
<p id="section-12.7.2.2.2-6">Path parameters:<a href="#section-12.7.2.2.2-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.7.2.2.2-7.1">
                  <p id="section-12.7.2.2.2-7.1.1"><code>:txnId</code> - the transaction ID (<a href="#int-txn-ids" class="auto internal xref">Section 12.2.5</a>) for the request. The event ID (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>) of the
contained event may be a good option as a readily-available transaction ID.<a href="#section-12.7.2.2.2-7.1.1" class="pilcrow">¶</a></p>
</li>
              </ul>
<p id="section-12.7.2.2.2-8">Query parameters: None applicable.<a href="#section-12.7.2.2.2-8" class="pilcrow">¶</a></p>
<p id="section-12.7.2.2.2-9">Request body:<a href="#section-12.7.2.2.2-9" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.7.2.2.2-10">
<pre>
{
   /* LPDU created from make_leave template */
}
</pre><a href="#section-12.7.2.2.2-10" class="pilcrow">¶</a>
</div>
<p id="section-12.7.2.2.2-11"><code>200 OK</code> response:<a href="#section-12.7.2.2.2-11" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.7.2.2.2-12">
<pre>
{/* deliberately empty object */}
</pre><a href="#section-12.7.2.2.2-12" class="pilcrow">¶</a>
</div>
<p id="section-12.7.2.2.2-13">The errors responses from <code>/make_leave</code> (<a href="#int-api-make-leave" class="auto internal xref">Section 12.7.2.2.1</a>) are copied here. Servers should note
that room state <span class="bcp14">MAY</span> change between a <code>/make_leave</code> and <code>/send_leave</code>, potentially in a way which
prevents the user from leaving the room suddenly. For example, the invited user may have been banned
from the room.<a href="#section-12.7.2.2.2-13" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="int-transport-joins">
<section id="section-12.7.3">
          <h4 id="name-joins">
<a href="#section-12.7.3" class="section-number selfRef">12.7.3. </a><a href="#name-joins" class="section-name selfRef">Joins</a>
          </h4>
<p id="section-12.7.3-1">Joins for users <span class="bcp14">SHOULD</span> be sent directly whenever possible, and otherwise use the "make and send" handshake
(<a href="#int-transport-make-and-send" class="auto internal xref">Section 12.7.1</a>) approach described here.<a href="#section-12.7.3-1" class="pilcrow">¶</a></p>
<div id="int-api-make-join">
<section id="section-12.7.3.1">
            <h5 id="name-get-_matrix-federation-v1-ma">
<a href="#section-12.7.3.1" class="section-number selfRef">12.7.3.1. </a><a href="#name-get-_matrix-federation-v1-ma" class="section-name selfRef"><code>GET /_matrix/federation/v1/make_join/:roomId/:userId</code></a>
            </h5>
<p id="section-12.7.3.1-1">Requests an event template from the hub server for a room. This is done to ensure the requesting
server supports the room's version (<a href="#int-room-versions" class="auto internal xref">Section 3.2.1</a>), as well as hint at the event format
needed to participate.<a href="#section-12.7.3.1-1" class="pilcrow">¶</a></p>
<p id="section-12.7.3.1-2">Note that this endpoint is extremely similar to <code>/make_leave</code> (<a href="#int-api-make-leave" class="auto internal xref">Section 12.7.2.2.1</a>).<a href="#section-12.7.3.1-2" class="pilcrow">¶</a></p>
<p id="section-12.7.3.1-3"><strong>Rate-limited</strong>: Yes.<a href="#section-12.7.3.1-3" class="pilcrow">¶</a></p>
<p id="section-12.7.3.1-4"><strong>Authentication required</strong>: Yes.<a href="#section-12.7.3.1-4" class="pilcrow">¶</a></p>
<p id="section-12.7.3.1-5">Path parameters:<a href="#section-12.7.3.1-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.7.3.1-6.1">
                <p id="section-12.7.3.1-6.1.1"><code>:roomId</code> - the room ID (<a href="#int-room-id" class="auto internal xref">Section 3.2</a>) to get a template for.<a href="#section-12.7.3.1-6.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-12.7.3.1-6.2">
                <p id="section-12.7.3.1-6.2.1"><code>:userId</code> - the user ID (<a href="#int-user-id" class="auto internal xref">Section 3.3</a>) attempting to join.<a href="#section-12.7.3.1-6.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-12.7.3.1-7">Query parameters:<a href="#section-12.7.3.1-7" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.7.3.1-8.1">
                <p id="section-12.7.3.1-8.1.1"><code>ver</code> (string; required; repeated) - The room versions (<a href="#int-room-versions" class="auto internal xref">Section 3.2.1</a>) the sending server
supports.<a href="#section-12.7.3.1-8.1.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-12.7.3.1-9">Request body: None applicable.<a href="#section-12.7.3.1-9" class="pilcrow">¶</a></p>
<p id="section-12.7.3.1-10"><code>200 OK</code> response:<a href="#section-12.7.3.1-10" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.7.3.1-11">
<pre>
{
   /* partial LPDU */
}
</pre><a href="#section-12.7.3.1-11" class="pilcrow">¶</a>
</div>
<p id="section-12.7.3.1-12">The response body <span class="bcp14">MUST</span> be a partial LPDU (<a href="#int-lpdu" class="auto internal xref">Section 3.5.1</a>) with at least the following fields:<a href="#section-12.7.3.1-12" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.7.3.1-13.1">
                <p id="section-12.7.3.1-13.1.1"><code>type</code> of <code>m.room.member</code>.<a href="#section-12.7.3.1-13.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-12.7.3.1-13.2">
                <p id="section-12.7.3.1-13.2.1"><code>state_key</code> of <code>:userId</code> from the path parameters.<a href="#section-12.7.3.1-13.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-12.7.3.1-13.3">
                <p id="section-12.7.3.1-13.3.1"><code>sender</code> of <code>:userId</code> from the path parameters.<a href="#section-12.7.3.1-13.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-12.7.3.1-13.4">
                <p id="section-12.7.3.1-13.4.1"><code>content</code> of <code>{"membership": "join"}</code>.<a href="#section-12.7.3.1-13.4.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-12.7.3.1-14">The sending server <span class="bcp14">SHOULD</span> remove all other fields before using the event in a <code>send_join</code> (<a href="#int-api-send-join" class="auto internal xref">Section 12.7.3.2</a>).<a href="#section-12.7.3.1-14" class="pilcrow">¶</a></p>
<p id="section-12.7.3.1-15">If the receiving server is not the hub server for the room ID, an HTTP status code of <code>400 Bad Request</code>
and error code <code>M_WRONG_SERVER</code> (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>) is returned. If the room ID is not known,
<code>404 Not Found</code> is used as an HTTP status code and <code>M_NOT_FOUND</code> as an error code (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>).<a href="#section-12.7.3.1-15" class="pilcrow">¶</a></p>
<p id="section-12.7.3.1-16">If the user does not have permission to join under the auth rules (<a href="#int-auth-rules" class="auto internal xref">Section 5.2</a>), a <code>403 Forbidden</code>
HTTP status code is returned alongside an error code of <code>M_FORBIDDEN</code> (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>).<a href="#section-12.7.3.1-16" class="pilcrow">¶</a></p>
<p id="section-12.7.3.1-17">If the room version is not one of the <code>ver</code> strings the sender supplied, a <code>400 Bad Request</code> HTTP status
code is returned alongside <code>M_INCOMPATIBLE_ROOM_VERSION</code> error code (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>).<a href="#section-12.7.3.1-17" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-api-send-join">
<section id="section-12.7.3.2">
            <h5 id="name-post-_matrix-federation-v3-se">
<a href="#section-12.7.3.2" class="section-number selfRef">12.7.3.2. </a><a href="#name-post-_matrix-federation-v3-se" class="section-name selfRef"><code>POST /_matrix/federation/v3/send_join/:txnId</code></a>
            </h5>
<p id="section-12.7.3.2-1">Sends a join membership event to the room through a hub server.<a href="#section-12.7.3.2-1" class="pilcrow">¶</a></p>
<p id="section-12.7.3.2-2">Note that this endpoint is extremely similar to <code>/send_leave</code> (<a href="#int-api-send-leave" class="auto internal xref">Section 12.7.2.2.2</a>).<a href="#section-12.7.3.2-2" class="pilcrow">¶</a></p>
<p id="section-12.7.3.2-3"><strong>Implementation note</strong>: Currently this endpoint doesn't actually exist. Use
<code>POST /_matrix/federation/unstable/org.matrix.i-d.ralston-mimi-linearized-matrix.02/send_join/:txnId</code>
when testing against other Linearized Matrix implementations. This string may be updated later to
account for breaking changes.<a href="#section-12.7.3.2-3" class="pilcrow">¶</a></p>
<p id="section-12.7.3.2-4"><strong>TODO</strong>: Remove implementation notes.<a href="#section-12.7.3.2-4" class="pilcrow">¶</a></p>
<p id="section-12.7.3.2-5"><strong>Rate-limited</strong>: Yes.<a href="#section-12.7.3.2-5" class="pilcrow">¶</a></p>
<p id="section-12.7.3.2-6"><strong>Authentication required</strong>: Yes.<a href="#section-12.7.3.2-6" class="pilcrow">¶</a></p>
<p id="section-12.7.3.2-7">Path parameters:<a href="#section-12.7.3.2-7" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.7.3.2-8.1">
                <p id="section-12.7.3.2-8.1.1"><code>:txnId</code> - the transaction ID (<a href="#int-txn-ids" class="auto internal xref">Section 12.2.5</a>) for the request. The event ID (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>) of the
contained event may be a good option as a readily-available transaction ID.<a href="#section-12.7.3.2-8.1.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-12.7.3.2-9">Query parameters: None applicable.<a href="#section-12.7.3.2-9" class="pilcrow">¶</a></p>
<p id="section-12.7.3.2-10"><strong>TODO</strong>: Incorporate faster joins work.<a href="#section-12.7.3.2-10" class="pilcrow">¶</a></p>
<p id="section-12.7.3.2-11">Request body:<a href="#section-12.7.3.2-11" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.7.3.2-12">
<pre>
{
   /* LPDU created from make_join template */
}
</pre><a href="#section-12.7.3.2-12" class="pilcrow">¶</a>
</div>
<p id="section-12.7.3.2-13"><code>200 OK</code> response:<a href="#section-12.7.3.2-13" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.7.3.2-14">
<pre>
{
   "state": [/* events */],
   "auth_chain": [/* events */],
   "event": {/* fully-formed event */}
}
</pre><a href="#section-12.7.3.2-14" class="pilcrow">¶</a>
</div>
<p id="section-12.7.3.2-15"><code>state</code> is the current room state, consisting of the events which represent "current state" (<a href="#int-state-events" class="auto internal xref">Section 3.5.2</a>)
prior to considering the membership state change. <code>auth_chain</code> consists of the events which make up
the <code>auth_events</code> (<a href="#int-auth-selection" class="auto internal xref">Section 5.2.1</a>) for the <code>state</code> events, and the <code>auth_events</code> of those events,
recursively. <code>event</code> will be the fully-formed PDU (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>) that is sent by the hub to all other
participants in the room.<a href="#section-12.7.3.2-15" class="pilcrow">¶</a></p>
<p id="section-12.7.3.2-16">The errors responses from <code>/make_join</code> (<a href="#int-api-make-join" class="auto internal xref">Section 12.7.3.1</a>) are copied here (with the exception
of <code>M_INCOMPATIBLE_ROOM_VERSION</code>, as the server already checked for support). Servers should note
that room state <span class="bcp14">MAY</span> change between a <code>/make_join</code> and <code>/send_join</code>, potentially in a way which
prevents the user from joining the room suddenly.<a href="#section-12.7.3.2-16" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="int-transport-knocks">
<section id="section-12.7.4">
          <h4 id="name-knocks">
<a href="#section-12.7.4" class="section-number selfRef">12.7.4. </a><a href="#name-knocks" class="section-name selfRef">Knocks</a>
          </h4>
<p id="section-12.7.4-1">To knock on a room is to request an invite to that room. It is not a join, nor is it an invite itself.
"Approving" the knock is done by inviting the user, which is typically only allowed by moderators in
these rooms. "Denying" the knock is done through kicking (sending a <code>leave</code> membership) or banning the
user. If the user is kicked, they may re-send their knock.<a href="#section-12.7.4-1" class="pilcrow">¶</a></p>
<p id="section-12.7.4-2">Senders should note the <code>reason</code> field on <code>m.room.member</code> events (<a href="#int-ev-member" class="auto internal xref">Section 3.5.3.3</a>) to provide context
for their knock.<a href="#section-12.7.4-2" class="pilcrow">¶</a></p>
<p id="section-12.7.4-3">To retract a knock, the sending server uses the same APIs as rejecting an invite (<a href="#int-transport-leaves" class="auto internal xref">Section 12.7.2.2</a>).<a href="#section-12.7.4-3" class="pilcrow">¶</a></p>
<p id="section-12.7.4-4">Where possible, knocks from users <span class="bcp14">SHOULD</span> be sent directly, otherwise using the "make and send" handshake
(<a href="#int-transport-make-and-send" class="auto internal xref">Section 12.7.1</a>) approach described here.<a href="#section-12.7.4-4" class="pilcrow">¶</a></p>
<div id="int-api-make-knock">
<section id="section-12.7.4.1">
            <h5 id="name-get-_matrix-federation-v1-mak">
<a href="#section-12.7.4.1" class="section-number selfRef">12.7.4.1. </a><a href="#name-get-_matrix-federation-v1-mak" class="section-name selfRef"><code>GET /_matrix/federation/v1/make_knock/:roomId/:userId</code></a>
            </h5>
<p id="section-12.7.4.1-1">Requests an event template from the hub server for a room. This is done to ensure the requesting
server supports the room's version (<a href="#int-room-versions" class="auto internal xref">Section 3.2.1</a>), as well as hint at the event format
needed to participate.<a href="#section-12.7.4.1-1" class="pilcrow">¶</a></p>
<p id="section-12.7.4.1-2">Note that this endpoint is almost exactly the same as <code>/make_join</code> (<a href="#int-api-make-join" class="auto internal xref">Section 12.7.3.1</a>).<a href="#section-12.7.4.1-2" class="pilcrow">¶</a></p>
<p id="section-12.7.4.1-3"><strong>TODO</strong>: It's so similar to make_join that we should probably just combine the two endpoints.<a href="#section-12.7.4.1-3" class="pilcrow">¶</a></p>
<p id="section-12.7.4.1-4"><strong>Rate-limited</strong>: Yes.<a href="#section-12.7.4.1-4" class="pilcrow">¶</a></p>
<p id="section-12.7.4.1-5"><strong>Authentication required</strong>: Yes.<a href="#section-12.7.4.1-5" class="pilcrow">¶</a></p>
<p id="section-12.7.4.1-6">Path parameters:<a href="#section-12.7.4.1-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.7.4.1-7.1">
                <p id="section-12.7.4.1-7.1.1"><code>:roomId</code> - the room ID (<a href="#int-room-id" class="auto internal xref">Section 3.2</a>) to get a template for.<a href="#section-12.7.4.1-7.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-12.7.4.1-7.2">
                <p id="section-12.7.4.1-7.2.1"><code>:userId</code> - the user ID (<a href="#int-user-id" class="auto internal xref">Section 3.3</a>) attempting to knock.<a href="#section-12.7.4.1-7.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-12.7.4.1-8">Query parameters:<a href="#section-12.7.4.1-8" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.7.4.1-9.1">
                <p id="section-12.7.4.1-9.1.1"><code>ver</code> (string; required; repeated) - The room versions (<a href="#int-room-versions" class="auto internal xref">Section 3.2.1</a>) the sending server
supports.<a href="#section-12.7.4.1-9.1.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-12.7.4.1-10">Request body: None applicable.<a href="#section-12.7.4.1-10" class="pilcrow">¶</a></p>
<p id="section-12.7.4.1-11"><code>200 OK</code> response:<a href="#section-12.7.4.1-11" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.7.4.1-12">
<pre>
{
   /* partial LPDU */
}
</pre><a href="#section-12.7.4.1-12" class="pilcrow">¶</a>
</div>
<p id="section-12.7.4.1-13">The response body <span class="bcp14">MUST</span> be a partial LPDU (<a href="#int-lpdu" class="auto internal xref">Section 3.5.1</a>) with at least the following fields:<a href="#section-12.7.4.1-13" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.7.4.1-14.1">
                <p id="section-12.7.4.1-14.1.1"><code>type</code> of <code>m.room.member</code>.<a href="#section-12.7.4.1-14.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-12.7.4.1-14.2">
                <p id="section-12.7.4.1-14.2.1"><code>state_key</code> of <code>:userId</code> from the path parameters.<a href="#section-12.7.4.1-14.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-12.7.4.1-14.3">
                <p id="section-12.7.4.1-14.3.1"><code>sender</code> of <code>:userId</code> from the path parameters.<a href="#section-12.7.4.1-14.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-12.7.4.1-14.4">
                <p id="section-12.7.4.1-14.4.1"><code>content</code> of <code>{"membership": "knock"}</code>.<a href="#section-12.7.4.1-14.4.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-12.7.4.1-15">The sending server <span class="bcp14">SHOULD</span> remove all other fields before using the event in a <code>send_knock</code> (<a href="#int-api-send-knock" class="auto internal xref">Section 12.7.4.2</a>).<a href="#section-12.7.4.1-15" class="pilcrow">¶</a></p>
<p id="section-12.7.4.1-16">If the receiving server is not the hub server for the room ID, an HTTP status code of <code>400 Bad Request</code>
and error code <code>M_WRONG_SERVER</code> (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>) is returned. If the room ID is not known,
<code>404 Not Found</code> is used as an HTTP status code and <code>M_NOT_FOUND</code> as an error code (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>).<a href="#section-12.7.4.1-16" class="pilcrow">¶</a></p>
<p id="section-12.7.4.1-17">If the user does not have permission to knock under the auth rules (<a href="#int-auth-rules" class="auto internal xref">Section 5.2</a>), a <code>403 Forbidden</code>
HTTP status code is returned alongside an error code of <code>M_FORBIDDEN</code> (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>).<a href="#section-12.7.4.1-17" class="pilcrow">¶</a></p>
<p id="section-12.7.4.1-18">If the room version is not one of the <code>ver</code> strings the sender supplied, a <code>400 Bad Request</code> HTTP status
code is returned alongside <code>M_INCOMPATIBLE_ROOM_VERSION</code> error code (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>).<a href="#section-12.7.4.1-18" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-api-send-knock">
<section id="section-12.7.4.2">
            <h5 id="name-post-_matrix-federation-v3-sen">
<a href="#section-12.7.4.2" class="section-number selfRef">12.7.4.2. </a><a href="#name-post-_matrix-federation-v3-sen" class="section-name selfRef"><code>POST /_matrix/federation/v3/send_knock/:txnId</code></a>
            </h5>
<p id="section-12.7.4.2-1">Sends a knock membership event to the room through a hub server.<a href="#section-12.7.4.2-1" class="pilcrow">¶</a></p>
<p id="section-12.7.4.2-2"><strong>Implementation note</strong>: Currently this endpoint doesn't actually exist. Use
<code>POST /_matrix/federation/unstable/org.matrix.i-d.ralston-mimi-linearized-matrix.02/send_knock/:txnId</code>
when testing against other Linearized Matrix implementations. This string may be updated later to
account for breaking changes.<a href="#section-12.7.4.2-2" class="pilcrow">¶</a></p>
<p id="section-12.7.4.2-3"><strong>TODO</strong>: Remove implementation notes.<a href="#section-12.7.4.2-3" class="pilcrow">¶</a></p>
<p id="section-12.7.4.2-4"><strong>Rate-limited</strong>: Yes.<a href="#section-12.7.4.2-4" class="pilcrow">¶</a></p>
<p id="section-12.7.4.2-5"><strong>Authentication required</strong>: Yes.<a href="#section-12.7.4.2-5" class="pilcrow">¶</a></p>
<p id="section-12.7.4.2-6">Path parameters:<a href="#section-12.7.4.2-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.7.4.2-7.1">
                <p id="section-12.7.4.2-7.1.1"><code>:txnId</code> - the transaction ID (<a href="#int-txn-ids" class="auto internal xref">Section 12.2.5</a>) for the request. The event ID (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>) of the
contained event may be a good option as a readily-available transaction ID.<a href="#section-12.7.4.2-7.1.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-12.7.4.2-8">Query parameters: None applicable.<a href="#section-12.7.4.2-8" class="pilcrow">¶</a></p>
<p id="section-12.7.4.2-9">Request body:<a href="#section-12.7.4.2-9" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.7.4.2-10">
<pre>
{
   /* LPDU created from make_knock template */
}
</pre><a href="#section-12.7.4.2-10" class="pilcrow">¶</a>
</div>
<p id="section-12.7.4.2-11"><code>200 OK</code> response:<a href="#section-12.7.4.2-11" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.7.4.2-12">
<pre>
{
   "stripped_state": [
      /* stripped state events */
   ]
}
</pre><a href="#section-12.7.4.2-12" class="pilcrow">¶</a>
</div>
<p id="section-12.7.4.2-13"><code>stripped_state</code> are the stripped state events (<a href="#int-stripped-state" class="auto internal xref">Section 3.5.2.1</a>) for the room.<a href="#section-12.7.4.2-13" class="pilcrow">¶</a></p>
<p id="section-12.7.4.2-14">The errors responses from <code>/make_knock</code> (<a href="#int-api-make-knock" class="auto internal xref">Section 12.7.4.1</a>) are copied here (with the exception
of <code>M_INCOMPATIBLE_ROOM_VERSION</code>, as the server already checked for support). Servers should note
that room state <span class="bcp14">MAY</span> change between a <code>/make_knock</code> and <code>/send_knock</code>, potentially in a way which
prevents the user from knocking upon the room suddenly.<a href="#section-12.7.4.2-14" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="content-repository">
<section id="section-12.8">
        <h3 id="name-content-repository">
<a href="#section-12.8" class="section-number selfRef">12.8. </a><a href="#name-content-repository" class="section-name selfRef">Content Repository</a>
        </h3>
<p id="section-12.8-1">The content repository, sometimes called the "media repo", is where user-generated content is stored
for referencing within an encrypted message.<a href="#section-12.8-1" class="pilcrow">¶</a></p>
<p id="section-12.8-2"><strong>TODO</strong>: Complete this section. We want auth/event linking from MSC3911 and MSC3916.<a href="#section-12.8-2" class="pilcrow">¶</a></p>
<p id="section-12.8-3"><strong>TODO</strong>: Spell out that content is images, videos, files, etc.<a href="#section-12.8-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-transport-edus">
<section id="section-12.9">
        <h3 id="name-ephemeral-data-units-edus">
<a href="#section-12.9" class="section-number selfRef">12.9. </a><a href="#name-ephemeral-data-units-edus" class="section-name selfRef">Ephemeral Data Units (EDUs)</a>
        </h3>
<p id="section-12.9-1">EDUs are sent out of band from rooms and are only persisted for exactly as long as they are needed.
For example, once a to-device (<a href="#int-transport-to-device" class="auto internal xref">Section 12.10.2</a>) message is delivered to a client, the
server may easily be able to delete its copy of the message.<a href="#section-12.9-1" class="pilcrow">¶</a></p>
<p id="section-12.9-2">EDUs contain the following mandatory fields:<a href="#section-12.9-2" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.9-3">
<pre>
{
   "type": "m.room.encrypted",
   "sender": "@alice:example.org",
   "content": {
      /* type-specific content */
   }
}
</pre><a href="#section-12.9-3" class="pilcrow">¶</a>
</div>
<p id="section-12.9-4">The <code>type</code> is similar to an event type (<a href="#int-pdu" class="auto internal xref">Section 3.5</a>) and ultimately describes the schema for the
<code>content</code>.<a href="#section-12.9-4" class="pilcrow">¶</a></p>
<p id="section-12.9-5"><code>sender_id</code> is the user ID (<a href="#int-user-id" class="auto internal xref">Section 3.3</a>) which is sending the EDU. Typically, clients will not
generate EDUs directly. Instead, the server will convert a client's request into an EDU for sending
to a remote server, where that server then unpacks the EDU before delivering it to local devices.<a href="#section-12.9-5" class="pilcrow">¶</a></p>
<p id="section-12.9-6">Because EDUs are not sent in the context of a room, even if an MLS <code>Welcome</code> message is being sent
for a room, servers <span class="bcp14">MUST</span> send the EDUs directly to the target server with the send API (<a href="#int-api-send-txn" class="auto internal xref">Section 12.5.1</a>).<a href="#section-12.9-6" class="pilcrow">¶</a></p>
<p id="section-12.9-7">In this document, EDUs are only used for to-device messages (<a href="#int-transport-to-device" class="auto internal xref">Section 12.10.2</a>) and device
list changes (<a href="#int-transport-devices" class="auto internal xref">Section 12.10.1</a>), but could be used for read/delivery receipts, typing notifications,
and more in future. This may necessitate routing EDUs through the hub rather than using full-mesh fanout.<a href="#section-12.9-7" class="pilcrow">¶</a></p>
<p id="section-12.9-8"><strong>TODO</strong>: Address EDU fanout; Document the implied missing features (receipts, typing notifs).<a href="#section-12.9-8" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-transport-mls">
<section id="section-12.10">
        <h3 id="name-mls">
<a href="#section-12.10" class="section-number selfRef">12.10. </a><a href="#name-mls" class="section-name selfRef">MLS</a>
        </h3>
<p id="section-12.10-1"><strong>TODO</strong>: This section. Talk about to-device messaging, device management/querying/key claiming, etc.<a href="#section-12.10-1" class="pilcrow">¶</a></p>
<p id="section-12.10-2">There are several endpoints required by this document's MLS implementation (<a href="#int-mls-considerations" class="auto internal xref">Section 4</a>),
largely around device management for each device's signing key, claiming key packages for those devices,
and sending messages (<code>Welcome</code> in particular) after using a key package.<a href="#section-12.10-2" class="pilcrow">¶</a></p>
<div id="int-transport-devices">
<section id="section-12.10.1">
          <h4 id="name-device-info-publishing">
<a href="#section-12.10.1" class="section-number selfRef">12.10.1. </a><a href="#name-device-info-publishing" class="section-name selfRef">Device Info Publishing</a>
          </h4>
<p id="section-12.10.1-1">When a user creates a new encryption-capable device, or removes one, a "device list update" is sent
to all servers the user shares a room with. The receiving servers then determine which local clients
need to be made aware of the device list change and sends the information to them. This is primarily
used by this document's MLS implementation (<a href="#int-mls-considerations" class="auto internal xref">Section 4</a>) to indicate to other devices
that either a new possible device has come online or that another needs to be removed from some MLS
groups due to being deleted.<a href="#section-12.10.1-1" class="pilcrow">¶</a></p>
<p id="section-12.10.1-2">Typically, a device is created by a user when they log in to a new session. Similarly, a device is
deleted/removed when they log out of that client.<a href="#section-12.10.1-2" class="pilcrow">¶</a></p>
<p id="section-12.10.1-3">The device list update takes the shape of an EDU (<a href="#int-transport-edus" class="auto internal xref">Section 12.9</a>), as such:<a href="#section-12.10.1-3" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.10.1-4">
<pre>
{
   "type": "m.device_list_update",
   "sender_id": "@alice:example.org",
   "content": {
      "changed": [/* Device Objects */],
      "removed": [/* Device IDs */]
   }
}
</pre><a href="#section-12.10.1-4" class="pilcrow">¶</a>
</div>
<p id="section-12.10.1-5">The device objects are the same as in the response for <code>/user/:userId/device/:deviceId</code> (<a href="#int-api-get-device" class="auto internal xref">Section 12.10.1.1</a>),
indicating that either a new device was created or that information about a previous device has changed.<a href="#section-12.10.1-5" class="pilcrow">¶</a></p>
<p id="section-12.10.1-6"><strong>TODO</strong>: Matrix's <code>m.device_list_update</code> EDU is <em>very</em> different from this, and relatively complicated.
Do we actually need a <code>stream_id</code>, like in Matrix? Do we then need the <code>/devices</code> endpoint?<a href="#section-12.10.1-6" class="pilcrow">¶</a></p>
<div id="int-api-get-device">
<section id="section-12.10.1.1">
            <h5 id="name-get-_matrix-federation-v1-u">
<a href="#section-12.10.1.1" class="section-number selfRef">12.10.1.1. </a><a href="#name-get-_matrix-federation-v1-u" class="section-name selfRef"><code>GET /_matrix/federation/v1/user/:userId/device/:deviceId</code></a>
            </h5>
<p id="section-12.10.1.1-1">Retrieves information about a specific device for a user. This request does not go via a hub, instead
going directly to the server which owns the <code>:userId</code>.<a href="#section-12.10.1.1-1" class="pilcrow">¶</a></p>
<p id="section-12.10.1.1-2"><strong>Implementation note</strong>: Currently this endpoint doesn't actually exist. Use
<code>PUT /_matrix/federation/unstable/org.matrix.i-d.ralston-mimi-linearized-matrix.02/user/:userId/device/:deviceId</code>
when testing against other Linearized Matrix implementations. This string may be updated later to
account for breaking changes.<a href="#section-12.10.1.1-2" class="pilcrow">¶</a></p>
<p id="section-12.10.1.1-3"><strong>TODO</strong>: Remove implementation notes.<a href="#section-12.10.1.1-3" class="pilcrow">¶</a></p>
<p id="section-12.10.1.1-4"><strong>Rate-limited</strong>: Yes.<a href="#section-12.10.1.1-4" class="pilcrow">¶</a></p>
<p id="section-12.10.1.1-5"><strong>Authentication required</strong>: Yes.<a href="#section-12.10.1.1-5" class="pilcrow">¶</a></p>
<p id="section-12.10.1.1-6">Path parameters:<a href="#section-12.10.1.1-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.10.1.1-7.1">
                <p id="section-12.10.1.1-7.1.1"><code>:userId</code> - the user ID (<a href="#int-user-id" class="auto internal xref">Section 3.3</a>) who owns the device.<a href="#section-12.10.1.1-7.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-12.10.1.1-7.2">
                <p id="section-12.10.1.1-7.2.1"><code>:deviceId</code> - the device ID (<a href="#int-device-id" class="auto internal xref">Section 3.4</a>) to get information about.<a href="#section-12.10.1.1-7.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-12.10.1.1-8">Query parameters: None applicable.<a href="#section-12.10.1.1-8" class="pilcrow">¶</a></p>
<p id="section-12.10.1.1-9">Request body: None applicable.<a href="#section-12.10.1.1-9" class="pilcrow">¶</a></p>
<p id="section-12.10.1.1-10"><code>200 OK</code> response:<a href="#section-12.10.1.1-10" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.10.1.1-11">
<pre>
{
   "device_id": "ABCDEF",
   "user_id": "@alice:example.org",
   "algorithms": [
      "m.mls.v1.dhkemx25519-aes128gcm-sha256-ed25519"
   ],
   "keys": {
      "m.mls.v1.credential.ed25519:ABCDEF":
         "&lt;unpadded base64 BasicCredential&gt;"
   },
   "signatures": {
      "@alice:example.org": {
         "m.mls.v1.credential.ed25519:ABCDEF":
            "&lt;unpadded base64 signature&gt;"
      }
   }
}
</pre><a href="#section-12.10.1.1-11" class="pilcrow">¶</a>
</div>
<p id="section-12.10.1.1-12">Note that the response is the same object the device itself signed/created in <a href="#int-mls-credentials" class="auto internal xref">Section 4.1</a>.<a href="#section-12.10.1.1-12" class="pilcrow">¶</a></p>
<p id="section-12.10.1.1-13">If the user ID does not belong the receiving server, a <code>404 Not Found</code> HTTP status code is returned
with error code <code>M_NOT_FOUND</code> (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>). The same applies if the user ID does not
exist, or the user does not have the device ID requested.<a href="#section-12.10.1.1-13" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="int-transport-to-device">
<section id="section-12.10.2">
          <h4 id="name-to-device-messaging">
<a href="#section-12.10.2" class="section-number selfRef">12.10.2. </a><a href="#name-to-device-messaging" class="section-name selfRef">To-Device Messaging</a>
          </h4>
<p id="section-12.10.2-1">To-device messaging is an ability to send information directly to another device, typically to carry
MLS <code>Welcome</code> messages and similar. They are sent as EDUs (<a href="#int-transport-edus" class="auto internal xref">Section 12.9</a>), one per receipient
device and payload:<a href="#section-12.10.2-1" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.10.2-2">
<pre>
{
   "type": "m.direct_to_device",
   "sender": "@alice:example.org",
   "content": {
      "target": "@bob:example.org",
      "target_device": "ABCD",
      "message_type": "m.room.encrypted",
      "message": {
         /* message_type-specific schema */
      }
   }
}
</pre><a href="#section-12.10.2-2" class="pilcrow">¶</a>
</div>
<p id="section-12.10.2-3"><code>target</code> and <code>target_device</code> denote the destination user ID (<a href="#int-user-id" class="auto internal xref">Section 3.3</a>) and device ID (<a href="#int-device-id" class="auto internal xref">Section 3.4</a>)
for that user. This EDU <span class="bcp14">MUST</span> be sent to the server denoted by the target user ID. If the target user
doesn't exist or doesn't have a device with the ID described, the receiving server drops/ignores the
EDU.<a href="#section-12.10.2-3" class="pilcrow">¶</a></p>
<p id="section-12.10.2-4">See <a href="#int-mls-add-remove" class="auto internal xref">Section 4.3</a> for an example of a to-device message being used.<a href="#section-12.10.2-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-transport-key-claim">
<section id="section-12.10.3">
          <h4 id="name-one-time-key-claiming">
<a href="#section-12.10.3" class="section-number selfRef">12.10.3. </a><a href="#name-one-time-key-claiming" class="section-name selfRef">One Time Key Claiming</a>
          </h4>
<p id="section-12.10.3-1">To enable two devices to communicate, they need to claim a key package (<a href="#int-mls-key-packages" class="auto internal xref">Section 4.4</a>)
for the other device. These key packages are also called "one time keys". This is done through the
following endpoint.<a href="#section-12.10.3-1" class="pilcrow">¶</a></p>
<div id="post-matrixfederationv1userkeysclaim">
<section id="section-12.10.3.1">
            <h5 id="name-post-_matrix-federation-v1-">
<a href="#section-12.10.3.1" class="section-number selfRef">12.10.3.1. </a><a href="#name-post-_matrix-federation-v1-" class="section-name selfRef"><code>POST /_matrix/federation/v1/user/keys/claim</code></a>
            </h5>
<p id="section-12.10.3.1-1">Claims one time keys for devices. This request does not go via a hub, instead going directly to the
server which owns the given user IDs.<a href="#section-12.10.3.1-1" class="pilcrow">¶</a></p>
<p id="section-12.10.3.1-2"><strong>Rate-limited</strong>: Yes.<a href="#section-12.10.3.1-2" class="pilcrow">¶</a></p>
<p id="section-12.10.3.1-3"><strong>Authentication required</strong>: Yes.<a href="#section-12.10.3.1-3" class="pilcrow">¶</a></p>
<p id="section-12.10.3.1-4">Path parameters: None applicable.<a href="#section-12.10.3.1-4" class="pilcrow">¶</a></p>
<p id="section-12.10.3.1-5">Query parameters: None applicable.<a href="#section-12.10.3.1-5" class="pilcrow">¶</a></p>
<p id="section-12.10.3.1-6">Request body:<a href="#section-12.10.3.1-6" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.10.3.1-7">
<pre>
{
  "one_time_keys": {
    "@alice:example.org": {
      "ABCD":
        "m.mls.v1.key_package.dhkemx25519-aes128gcm-sha256-ed25519"
    }
  }
}
</pre><a href="#section-12.10.3.1-7" class="pilcrow">¶</a>
</div>
<p id="section-12.10.3.1-8"><code>one_time_keys</code> <span class="bcp14">MUST</span> be specified and is a map of user ID (<a href="#int-user-id" class="auto internal xref">Section 3.3</a>) to device ID (<a href="#int-device-id" class="auto internal xref">Section 3.4</a>)
to algorithm for the key package to claim. Currently the only expected algorithm is defined by <a href="#int-mls-key-packages" class="auto internal xref">Section 4.4</a>.<a href="#section-12.10.3.1-8" class="pilcrow">¶</a></p>
<p id="section-12.10.3.1-9">Any user IDs which don't belong to the receiving server, or which don't exist, are ignored. The same
applies for device IDs for which the user doesn't have.<a href="#section-12.10.3.1-9" class="pilcrow">¶</a></p>
<p id="section-12.10.3.1-10"><code>200 OK</code> response:<a href="#section-12.10.3.1-10" class="pilcrow">¶</a></p>
<div class="lang-json sourcecode" id="section-12.10.3.1-11">
<pre>
{
  "one_time_keys": {
    "@alice:example.org": {
      "ABCD": {
        "m.mls.v1.key_package.dhkemx25519-aes128gcm-sha256-ed25519":
          "&lt;unpadded base64 encoded key package&gt;"
      }
    }
  }
}
</pre><a href="#section-12.10.3.1-11" class="pilcrow">¶</a>
</div>
<p id="section-12.10.3.1-12">Like the request body, <code>one_time_keys</code> <span class="bcp14">MUST</span> be specified (but <span class="bcp14">MAY</span> be empty) and is a map of requested
user ID to requested device ID to algorithm name. The value for the algorithm name is dependent on the
algorithm itself. For <code>m.mls.v1.key_package.dhkemx25519-aes128gcm-sha256-ed25519</code>, this is an unpadded
base64 (<a href="#int-unpadded-base64" class="auto internal xref">Section 10</a>) string representing the key package itself.<a href="#section-12.10.3.1-12" class="pilcrow">¶</a></p>
<p id="section-12.10.3.1-13">Servers <span class="bcp14">MUST NOT</span> reuse a device's one time key, unless that key permits it. For example, MLS's "last
resort" key <span class="bcp14">MAY</span> be used multiple times, but <span class="bcp14">SHOULD</span> only be used if no other one time keys remain for
the device. Servers <span class="bcp14">MUST NOT</span> use an expired key.<a href="#section-12.10.3.1-13" class="pilcrow">¶</a></p>
<p id="section-12.10.3.1-14">Typically, the server will inform the device that a key was used so the device can upload additional
keys. See <a href="#int-mls-key-packages" class="auto internal xref">Section 4.4</a> for further implementation-related concerns.<a href="#section-12.10.3.1-14" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="todo-remainder-of-transport">
<section id="section-12.11">
        <h3 id="name-todo-remainder-of-transport">
<a href="#section-12.11" class="section-number selfRef">12.11. </a><a href="#name-todo-remainder-of-transport" class="section-name selfRef">TODO: Remainder of Transport</a>
        </h3>
<p id="section-12.11-1"><strong>TODO</strong>: This section.<a href="#section-12.11-1" class="pilcrow">¶</a></p>
<p id="section-12.11-2">Topics:<a href="#section-12.11-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.11-3.1">
            <p id="section-12.11-3.1.1">More EDUs (typing notifications, receipts, presence)<a href="#section-12.11-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-12.11-3.2">
            <p id="section-12.11-3.2.1">Query APIs (alias resolution, profiles)<a href="#section-12.11-3.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-12.11-3.3">
            <p id="section-12.11-3.3.1">Other Encryption APIs??<a href="#section-12.11-3.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-12.11-3.4">
            <p id="section-12.11-3.4.1">Server ACLs? (this probably should become part of the auth rules)<a href="#section-12.11-3.4.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-12.11-4">Notably/deliberately missing APIs are:<a href="#section-12.11-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.11-5.1">
            <p id="section-12.11-5.1.1"><code>get_missing_events</code> - this is used by DAG servers only<a href="#section-12.11-5.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-12.11-5.2">
            <p id="section-12.11-5.2.1">Public room directory<a href="#section-12.11-5.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-12.11-5.3">
            <p id="section-12.11-5.3.1">Timestamp-to-event API<a href="#section-12.11-5.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-12.11-5.4">
            <p id="section-12.11-5.4.1">All of 3rd party invites<a href="#section-12.11-5.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-12.11-5.5">
            <p id="section-12.11-5.5.1">All of Spaces<a href="#section-12.11-5.5.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-12.11-5.6">
            <p id="section-12.11-5.6.1">OpenID API<a href="#section-12.11-5.6.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<div id="open-questions">
<section id="section-12.11.1">
          <h4 id="name-open-questions">
<a href="#section-12.11.1" class="section-number selfRef">12.11.1. </a><a href="#name-open-questions" class="section-name selfRef">Open Questions</a>
          </h4>
<ul class="normal">
<li class="normal" id="section-12.11.1-1.1">
              <p id="section-12.11.1-1.1.1">Should we include <code>/_matrix/federation/v1/version</code> in here? It's used by federation testers, but not
really anything else.<a href="#section-12.11.1-1.1.1" class="pilcrow">¶</a></p>
</li>
          </ul>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="int-user-privacy">
<section id="section-13">
      <h2 id="name-user-privacy">
<a href="#section-13" class="section-number selfRef">13. </a><a href="#name-user-privacy" class="section-name selfRef">User Privacy</a>
      </h2>
<p id="section-13-1"><strong>TODO</strong>: Fully complete this section.<a href="#section-13-1" class="pilcrow">¶</a></p>
<p id="section-13-2">Messaging providers may have user-level settings to prevent unexpected or unwarranted invites, such
as automatically blocking invites from non-contacts. This setting can be upheld by returning an error
on <code>POST /_matrix/federation/v3/invite/:txnId</code> (<a href="#int-api-invite" class="auto internal xref">Section 12.7.2.1</a>), and by having the server (optionally)
auto-decline any invites received directly through <code>PUT /_matrix/federation/v2/send/:txnId</code> (<a href="#int-api-send-txn" class="auto internal xref">Section 12.5.1</a>).
See <a href="#int-transport-leaves" class="auto internal xref">Section 12.7.2.2</a> for more information on rejecting invites.<a href="#section-13-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="int-spam">
<section id="section-14">
      <h2 id="name-spam-prevention">
<a href="#section-14" class="section-number selfRef">14. </a><a href="#name-spam-prevention" class="section-name selfRef">Spam Prevention</a>
      </h2>
<p id="section-14-1"><strong>TODO</strong>: Fully complete this section.<a href="#section-14-1" class="pilcrow">¶</a></p>
<p id="section-14-2"><strong>TODO</strong>: Talk about how to deal with spammy/unwanted invites.<a href="#section-14-2" class="pilcrow">¶</a></p>
<p id="section-14-3">Servers <span class="bcp14">MAY</span> temporarily or permanently block a room entirely by using the room ID. Typically, when a
room becomes blocked, all local users will be removed from the room using <code>m.room.member</code> events with
<code>membership</code> of <code>leave</code> (<a href="#int-ev-member" class="auto internal xref">Section 3.5.3.3</a>). Then, any time the server receives a request for that
room ID it can reject it with an error response (<a href="#int-transport-errors" class="auto internal xref">Section 12.2.2</a>).<a href="#section-14-3" class="pilcrow">¶</a></p>
<p id="section-14-4">Blocking a room does not block it from all servers, but does prevent users on a server from accessing
the content within. This is primarily useful to remove a server from rooms where abusive/illegal content
is shared.<a href="#section-14-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="security-considerations">
<section id="section-15">
      <h2 id="name-security-considerations">
<a href="#section-15" class="section-number selfRef">15. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<p id="section-15-1"><strong>TODO</strong>: Expand upon this section.<a href="#section-15-1" class="pilcrow">¶</a></p>
<p id="section-15-2">With the combined use of MLS and server-side enforcement, the server theoretically has an ability to
add a malicious device to the MLS group and receive decryptable messages. Authenticity of devices needs
to be established to ensure a user's devices are actually a user's devices.<a href="#section-15-2" class="pilcrow">¶</a></p>
<p id="section-15-3"><strong>TODO</strong>: Should we bring Matrix's cross-signing here?<a href="#section-15-3" class="pilcrow">¶</a></p>
<p id="section-15-4">Servers retain the ability to control/puppet their own users due to no strong cryptographic link between
the sending device and the event which gets emitted.<a href="#section-15-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="mimi-protocol-comparison">
<section id="section-16">
      <h2 id="name-mimi-protocol-comparison">
<a href="#section-16" class="section-number selfRef">16. </a><a href="#name-mimi-protocol-comparison" class="section-name selfRef">MIMI Protocol Comparison</a>
      </h2>
<p id="section-16-1"><span>[<a href="#I-D.barnes-mimi-arch" class="cite xref">I-D.barnes-mimi-arch</a>]</span>, <span>[<a href="#I-D.ralston-mimi-protocol" class="cite xref">I-D.ralston-mimi-protocol</a>]</span>, and <span>[<a href="#I-D.robert-mimi-delivery-service" class="cite xref">I-D.robert-mimi-delivery-service</a>]</span>
collectively define a protocol with similar capabilities to Linearized Matrix, though leans more heavily
into the MLS layering to accomplish interoperable messaging. Linearized Matrix in contrast provides
a signaling layer for which encryption can operate, using existing open standards as the foundational
piece.<a href="#section-16-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="iana-considerations">
<section id="section-17">
      <h2 id="name-iana-considerations">
<a href="#section-17" class="section-number selfRef">17. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<p id="section-17-1">The <code>m.*</code> namespace likely needs formal registration in some capacity.<a href="#section-17-1" class="pilcrow">¶</a></p>
<p id="section-17-2">The <code>I.*</code> namespace likely needs formal registration in some capacity.<a href="#section-17-2" class="pilcrow">¶</a></p>
<p id="section-17-3">Port 8448 may need formal registration.<a href="#section-17-3" class="pilcrow">¶</a></p>
<p id="section-17-4">The SRV service name <code>matrix</code> may need re-registering, or a new service name assigned.<a href="#section-17-4" class="pilcrow">¶</a></p>
<p id="section-17-5">The <code>.well-known/matrix</code> namespace is already registered for use by The Matrix.org Foundation C.I.C.<a href="#section-17-5" class="pilcrow">¶</a></p>
</section>
</div>
<section id="section-18">
      <h2 id="name-references">
<a href="#section-18" class="section-number selfRef">18. </a><a href="#name-references" class="section-name selfRef">References</a>
      </h2>
<div id="sec-normative-references">
<section id="section-18.1">
        <h3 id="name-normative-references">
<a href="#section-18.1" class="section-number selfRef">18.1. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
        </h3>
<dl class="references">
<dt id="I-D.barnes-mimi-arch">[I-D.barnes-mimi-arch]</dt>
        <dd>
<span class="refAuthor">Barnes, R.</span>, <span class="refTitle">"An Architecture for More Instant Messaging Interoperability (MIMI)"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-barnes-mimi-arch-02</span>, <time datetime="2023-10-23" class="refDate">23 October 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-barnes-mimi-arch-02">https://datatracker.ietf.org/doc/html/draft-barnes-mimi-arch-02</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-mls-architecture">[I-D.ietf-mls-architecture]</dt>
        <dd>
<span class="refAuthor">Beurdouche, B.</span>, <span class="refAuthor">Rescorla, E.</span>, <span class="refAuthor">Omara, E.</span>, <span class="refAuthor">Inguva, S.</span>, and <span class="refAuthor">A. Duric</span>, <span class="refTitle">"The Messaging Layer Security (MLS) Architecture"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-mls-architecture-11</span>, <time datetime="2023-07-26" class="refDate">26 July 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-mls-architecture-11">https://datatracker.ietf.org/doc/html/draft-ietf-mls-architecture-11</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-mls-protocol">[I-D.ietf-mls-protocol]</dt>
        <dd>
<span class="refAuthor">Barnes, R.</span>, <span class="refAuthor">Beurdouche, B.</span>, <span class="refAuthor">Robert, R.</span>, <span class="refAuthor">Millican, J.</span>, <span class="refAuthor">Omara, E.</span>, and <span class="refAuthor">K. Cohn-Gordon</span>, <span class="refTitle">"The Messaging Layer Security (MLS) Protocol"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-mls-protocol-20</span>, <time datetime="2023-03-27" class="refDate">27 March 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-mls-protocol-20">https://datatracker.ietf.org/doc/html/draft-ietf-mls-protocol-20</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ralston-mimi-protocol">[I-D.ralston-mimi-protocol]</dt>
        <dd>
<span class="refAuthor">Ralston, T.</span>, <span class="refAuthor">Kohbrok, K.</span>, <span class="refAuthor">Robert, R.</span>, and <span class="refAuthor">M. Hodgson</span>, <span class="refTitle">"More Instant Messaging Interoperability (MIMI) using HTTPS and MLS"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ralston-mimi-protocol-01</span>, <time datetime="2023-11-06" class="refDate">6 November 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ralston-mimi-protocol-01">https://datatracker.ietf.org/doc/html/draft-ralston-mimi-protocol-01</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ralston-mimi-terminology">[I-D.ralston-mimi-terminology]</dt>
        <dd>
<span class="refAuthor">Ralston, T.</span>, <span class="refTitle">"MIMI Terminology"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ralston-mimi-terminology-03</span>, <time datetime="2023-10-23" class="refDate">23 October 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ralston-mimi-terminology-03">https://datatracker.ietf.org/doc/html/draft-ralston-mimi-terminology-03</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.robert-mimi-delivery-service">[I-D.robert-mimi-delivery-service]</dt>
        <dd>
<span class="refAuthor">Robert, R.</span> and <span class="refAuthor">K. Kohbrok</span>, <span class="refTitle">"MIMI Delivery Service"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-robert-mimi-delivery-service-06</span>, <time datetime="2023-11-06" class="refDate">6 November 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-robert-mimi-delivery-service-06">https://datatracker.ietf.org/doc/html/draft-robert-mimi-delivery-service-06</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC1034">[RFC1034]</dt>
        <dd>
<span class="refAuthor">Mockapetris, P.</span>, <span class="refTitle">"Domain names - concepts and facilities"</span>, <span class="seriesInfo">STD 13</span>, <span class="seriesInfo">RFC 1034</span>, <span class="seriesInfo">DOI 10.17487/RFC1034</span>, <time datetime="1987-11" class="refDate">November 1987</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc1034">https://www.rfc-editor.org/rfc/rfc1034</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC1035">[RFC1035]</dt>
        <dd>
<span class="refAuthor">Mockapetris, P.</span>, <span class="refTitle">"Domain names - implementation and specification"</span>, <span class="seriesInfo">STD 13</span>, <span class="seriesInfo">RFC 1035</span>, <span class="seriesInfo">DOI 10.17487/RFC1035</span>, <time datetime="1987-11" class="refDate">November 1987</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc1035">https://www.rfc-editor.org/rfc/rfc1035</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC1123">[RFC1123]</dt>
        <dd>
<span class="refAuthor">Braden, R., Ed.</span>, <span class="refTitle">"Requirements for Internet Hosts - Application and Support"</span>, <span class="seriesInfo">STD 3</span>, <span class="seriesInfo">RFC 1123</span>, <span class="seriesInfo">DOI 10.17487/RFC1123</span>, <time datetime="1989-10" class="refDate">October 1989</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc1123">https://www.rfc-editor.org/rfc/rfc1123</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc2119">https://www.rfc-editor.org/rfc/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2181">[RFC2181]</dt>
        <dd>
<span class="refAuthor">Elz, R.</span> and <span class="refAuthor">R. Bush</span>, <span class="refTitle">"Clarifications to the DNS Specification"</span>, <span class="seriesInfo">RFC 2181</span>, <span class="seriesInfo">DOI 10.17487/RFC2181</span>, <time datetime="1997-07" class="refDate">July 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc2181">https://www.rfc-editor.org/rfc/rfc2181</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2782">[RFC2782]</dt>
        <dd>
<span class="refAuthor">Gulbrandsen, A.</span>, <span class="refAuthor">Vixie, P.</span>, and <span class="refAuthor">L. Esibov</span>, <span class="refTitle">"A DNS RR for specifying the location of services (DNS SRV)"</span>, <span class="seriesInfo">RFC 2782</span>, <span class="seriesInfo">DOI 10.17487/RFC2782</span>, <time datetime="2000-02" class="refDate">February 2000</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc2782">https://www.rfc-editor.org/rfc/rfc2782</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC3596">[RFC3596]</dt>
        <dd>
<span class="refAuthor">Thomson, S.</span>, <span class="refAuthor">Huitema, C.</span>, <span class="refAuthor">Ksinant, V.</span>, and <span class="refAuthor">M. Souissi</span>, <span class="refTitle">"DNS Extensions to Support IP Version 6"</span>, <span class="seriesInfo">STD 88</span>, <span class="seriesInfo">RFC 3596</span>, <span class="seriesInfo">DOI 10.17487/RFC3596</span>, <time datetime="2003-10" class="refDate">October 2003</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc3596">https://www.rfc-editor.org/rfc/rfc3596</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC3629">[RFC3629]</dt>
        <dd>
<span class="refAuthor">Yergeau, F.</span>, <span class="refTitle">"UTF-8, a transformation format of ISO 10646"</span>, <span class="seriesInfo">STD 63</span>, <span class="seriesInfo">RFC 3629</span>, <span class="seriesInfo">DOI 10.17487/RFC3629</span>, <time datetime="2003-11" class="refDate">November 2003</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc3629">https://www.rfc-editor.org/rfc/rfc3629</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC4648">[RFC4648]</dt>
        <dd>
<span class="refAuthor">Josefsson, S.</span>, <span class="refTitle">"The Base16, Base32, and Base64 Data Encodings"</span>, <span class="seriesInfo">RFC 4648</span>, <span class="seriesInfo">DOI 10.17487/RFC4648</span>, <time datetime="2006-10" class="refDate">October 2006</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc4648">https://www.rfc-editor.org/rfc/rfc4648</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC5234">[RFC5234]</dt>
        <dd>
<span class="refAuthor">Crocker, D., Ed.</span> and <span class="refAuthor">P. Overell</span>, <span class="refTitle">"Augmented BNF for Syntax Specifications: ABNF"</span>, <span class="seriesInfo">STD 68</span>, <span class="seriesInfo">RFC 5234</span>, <span class="seriesInfo">DOI 10.17487/RFC5234</span>, <time datetime="2008-01" class="refDate">January 2008</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc5234">https://www.rfc-editor.org/rfc/rfc5234</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC6125">[RFC6125]</dt>
        <dd>
<span class="refAuthor">Saint-Andre, P.</span> and <span class="refAuthor">J. Hodges</span>, <span class="refTitle">"Representation and Verification of Domain-Based Application Service Identity within Internet Public Key Infrastructure Using X.509 (PKIX) Certificates in the Context of Transport Layer Security (TLS)"</span>, <span class="seriesInfo">RFC 6125</span>, <span class="seriesInfo">DOI 10.17487/RFC6125</span>, <time datetime="2011-03" class="refDate">March 2011</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc6125">https://www.rfc-editor.org/rfc/rfc6125</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC6234">[RFC6234]</dt>
        <dd>
<span class="refAuthor">Eastlake 3rd, D.</span> and <span class="refAuthor">T. Hansen</span>, <span class="refTitle">"US Secure Hash Algorithms (SHA and SHA-based HMAC and HKDF)"</span>, <span class="seriesInfo">RFC 6234</span>, <span class="seriesInfo">DOI 10.17487/RFC6234</span>, <time datetime="2011-05" class="refDate">May 2011</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc6234">https://www.rfc-editor.org/rfc/rfc6234</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8032">[RFC8032]</dt>
        <dd>
<span class="refAuthor">Josefsson, S.</span> and <span class="refAuthor">I. Liusvaara</span>, <span class="refTitle">"Edwards-Curve Digital Signature Algorithm (EdDSA)"</span>, <span class="seriesInfo">RFC 8032</span>, <span class="seriesInfo">DOI 10.17487/RFC8032</span>, <time datetime="2017-01" class="refDate">January 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8032">https://www.rfc-editor.org/rfc/rfc8032</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
        <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8174">https://www.rfc-editor.org/rfc/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8259">[RFC8259]</dt>
        <dd>
<span class="refAuthor">Bray, T., Ed.</span>, <span class="refTitle">"The JavaScript Object Notation (JSON) Data Interchange Format"</span>, <span class="seriesInfo">STD 90</span>, <span class="seriesInfo">RFC 8259</span>, <span class="seriesInfo">DOI 10.17487/RFC8259</span>, <time datetime="2017-12" class="refDate">December 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8259">https://www.rfc-editor.org/rfc/rfc8259</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8446">[RFC8446]</dt>
        <dd>
<span class="refAuthor">Rescorla, E.</span>, <span class="refTitle">"The Transport Layer Security (TLS) Protocol Version 1.3"</span>, <span class="seriesInfo">RFC 8446</span>, <span class="seriesInfo">DOI 10.17487/RFC8446</span>, <time datetime="2018-08" class="refDate">August 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8446">https://www.rfc-editor.org/rfc/rfc8446</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8785">[RFC8785]</dt>
        <dd>
<span class="refAuthor">Rundgren, A.</span>, <span class="refAuthor">Jordan, B.</span>, and <span class="refAuthor">S. Erdtman</span>, <span class="refTitle">"JSON Canonicalization Scheme (JCS)"</span>, <span class="seriesInfo">RFC 8785</span>, <span class="seriesInfo">DOI 10.17487/RFC8785</span>, <time datetime="2020-06" class="refDate">June 2020</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8785">https://www.rfc-editor.org/rfc/rfc8785</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9110">[RFC9110]</dt>
        <dd>
<span class="refAuthor">Fielding, R., Ed.</span>, <span class="refAuthor">Nottingham, M., Ed.</span>, and <span class="refAuthor">J. Reschke, Ed.</span>, <span class="refTitle">"HTTP Semantics"</span>, <span class="seriesInfo">STD 97</span>, <span class="seriesInfo">RFC 9110</span>, <span class="seriesInfo">DOI 10.17487/RFC9110</span>, <time datetime="2022-06" class="refDate">June 2022</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9110">https://www.rfc-editor.org/rfc/rfc9110</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9113">[RFC9113]</dt>
      <dd>
<span class="refAuthor">Thomson, M., Ed.</span> and <span class="refAuthor">C. Benfield, Ed.</span>, <span class="refTitle">"HTTP/2"</span>, <span class="seriesInfo">RFC 9113</span>, <span class="seriesInfo">DOI 10.17487/RFC9113</span>, <time datetime="2022-06" class="refDate">June 2022</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9113">https://www.rfc-editor.org/rfc/rfc9113</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</div>
<div id="sec-informative-references">
<section id="section-18.2">
        <h3 id="name-informative-references">
<a href="#section-18.2" class="section-number selfRef">18.2. </a><a href="#name-informative-references" class="section-name selfRef">Informative References</a>
        </h3>
<dl class="references">
<dt id="DMLS">[DMLS]</dt>
        <dd>
<span class="refAuthor">Chathi, H.</span>, <span class="refTitle">"Decentralised MLS"</span>, <time datetime="2023-05-29" class="refDate">29 May 2023</time>, <span>&lt;<a href="https://gitlab.matrix.org/matrix-org/mls-ts/-/blob/48efb972075233c3a0f3e3ca01c4d4f888342205/decentralised.org">https://gitlab.matrix.org/matrix-org/mls-ts/-/blob/48efb972075233c3a0f3e3ca01c4d4f888342205/decentralised.org</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.kohbrok-mimi-portability">[I-D.kohbrok-mimi-portability]</dt>
        <dd>
<span class="refAuthor">Kohbrok, K.</span> and <span class="refAuthor">R. Robert</span>, <span class="refTitle">"MIMI Portability"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-kohbrok-mimi-portability-01</span>, <time datetime="2024-01-04" class="refDate">4 January 2024</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-kohbrok-mimi-portability-01">https://datatracker.ietf.org/doc/html/draft-kohbrok-mimi-portability-01</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.mahy-mimi-group-chat">[I-D.mahy-mimi-group-chat]</dt>
        <dd>
<span class="refAuthor">Mahy, R.</span>, <span class="refTitle">"Group Chat Framework for More Instant Messaging Interoperability (MIMI)"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-mahy-mimi-group-chat-00</span>, <time datetime="2023-07-10" class="refDate">10 July 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-mahy-mimi-group-chat-00">https://datatracker.ietf.org/doc/html/draft-mahy-mimi-group-chat-00</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.rosenberg-mimi-protocol">[I-D.rosenberg-mimi-protocol]</dt>
        <dd>
<span class="refAuthor">Rosenberg, J.</span>, <span class="refAuthor">Jennings, C. F.</span>, and <span class="refAuthor">S. Nandakumar</span>, <span class="refTitle">"More Instant Messaging Interop (MIMI) Transport Protocol"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-rosenberg-mimi-protocol-00</span>, <time datetime="2023-03-13" class="refDate">13 March 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-rosenberg-mimi-protocol-00">https://datatracker.ietf.org/doc/html/draft-rosenberg-mimi-protocol-00</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="MSC3995">[MSC3995]</dt>
        <dd>
<span class="refAuthor">Ralston, T.</span>, <span class="refTitle">"MSC3995: [WIP] Linearized Matrix"</span>, <time datetime="2023-04-12" class="refDate">12 April 2023</time>, <span>&lt;<a href="https://github.com/matrix-org/matrix-spec-proposals/pull/3995">https://github.com/matrix-org/matrix-spec-proposals/pull/3995</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="PerspectivesProject">[PerspectivesProject]</dt>
        <dd>
<span class="refTitle">"Perspectives Project"</span>, <time datetime="2017-07-02" class="refDate">2 July 2017</time>, <span>&lt;<a href="https://web.archive.org/web/20170702024706/https://perspectives-project.org/">https://web.archive.org/web/20170702024706/https://perspectives-project.org/</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC5280">[RFC5280]</dt>
        <dd>
<span class="refAuthor">Cooper, D.</span>, <span class="refAuthor">Santesson, S.</span>, <span class="refAuthor">Farrell, S.</span>, <span class="refAuthor">Boeyen, S.</span>, <span class="refAuthor">Housley, R.</span>, and <span class="refAuthor">W. Polk</span>, <span class="refTitle">"Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL) Profile"</span>, <span class="seriesInfo">RFC 5280</span>, <span class="seriesInfo">DOI 10.17487/RFC5280</span>, <time datetime="2008-05" class="refDate">May 2008</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc5280">https://www.rfc-editor.org/rfc/rfc5280</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC6120">[RFC6120]</dt>
        <dd>
<span class="refAuthor">Saint-Andre, P.</span>, <span class="refTitle">"Extensible Messaging and Presence Protocol (XMPP): Core"</span>, <span class="seriesInfo">RFC 6120</span>, <span class="seriesInfo">DOI 10.17487/RFC6120</span>, <time datetime="2011-03" class="refDate">March 2011</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc6120">https://www.rfc-editor.org/rfc/rfc6120</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9364">[RFC9364]</dt>
      <dd>
<span class="refAuthor">Hoffman, P.</span>, <span class="refTitle">"DNS Security Extensions (DNSSEC)"</span>, <span class="seriesInfo">BCP 237</span>, <span class="seriesInfo">RFC 9364</span>, <span class="seriesInfo">DOI 10.17487/RFC9364</span>, <time datetime="2023-02" class="refDate">February 2023</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9364">https://www.rfc-editor.org/rfc/rfc9364</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</div>
</section>
<div id="acknowledgments">
<section id="appendix-A">
      <h2 id="name-acknowledgments">
<a href="#name-acknowledgments" class="section-name selfRef">Acknowledgments</a>
      </h2>
<p id="appendix-A-1">Thanks to the Matrix Spec Core Team (SCT) for exploring methods of linearizing Matrix's DAG room model,
especially Richard van der Hoff and Erik Johnston. Additional thanks to the Matrix core team as a whole
for general review and input on this document, especially Patrick Cloke and Jim Mackenzie.<a href="#appendix-A-1" class="pilcrow">¶</a></p>
<p id="appendix-A-2">Matrix's crypto team graciously allowed their work-in-progress MLS considerations to be incorporated
in this document. Thanks to Hubert Chathi for reviewing the MLS work for plausibility.<a href="#appendix-A-2" class="pilcrow">¶</a></p>
<p id="appendix-A-3">Thanks are also extended to the wider MIMI working group for continous review and input on this document.<a href="#appendix-A-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authors-addresses">
<section id="appendix-B">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Travis Ralston</span></div>
<div dir="auto" class="left"><span class="org">The Matrix.org Foundation C.I.C.</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:travisr@matrix.org" class="email">travisr@matrix.org</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Matthew Hodgson</span></div>
<div dir="auto" class="left"><span class="org">The Matrix.org Foundation C.I.C.</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:matthew@matrix.org" class="email">matthew@matrix.org</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
